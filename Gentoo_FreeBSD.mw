{{Important|Sometimes, Gentoo/FreeBSD's @system is broken.
Please get latest information from "Depends on" of {{Bug|462580}}.
}}

Gentoo/FreeBSD is a Gentoo system based on FreeBSD. It is FreeBSD with the following changes:

* Portage replaces ports.
* The base system is managed by portage.
* Software in ./contrib and ./crypto is replaced with Gentoo Linux versions.
* The rc system is replaced with [[OpenRC]].
* Python, wget and bash are included in the base system to support portage.
* FreeBSD's bootloader is removed from the base system (useful for jails).

{{Note|Gentoo FreeBSD is not 100% binary-compatibility with regular FreeBSD due to SONAME differences. It is possible to workaround that by running regular FreeBSD in either a jail or chroot on Gentoo FreeBSD or vice versa.

Gentoo FreeBSD is also not 100% script-compatible with regular FreeBSD by default. Script compatibility can be restored by installing sys-freebsd/ubin-wrappers. This makes it possible to use *BSD software like pkgsrc.
}}

== Installation ==

=== Caution ===
Since this guide has only minimal information, knowledge of both Gentoo/Linux and FreeBSD may be needed. The [http://www.gentoo.org/doc/en/handbook/ Gentoo/Linux Handbook] and [http://www.freebsd.org/handbook/ FreeBSD Handbook] are your friends. 

=== Preparation ===
The installation media of FreeBSD 9.0 to which the LiveCD function was added are used for installation.
Please get the more suitable one of [http://ftp.freebsd.org/pub/FreeBSD/releases/i386/i386/ISO-IMAGES/9.0/ i386] or [http://ftp.freebsd.org/pub/FreeBSD/releases/amd64/amd64/ISO-IMAGES/9.1/ amd64]. Of course, -bootonly.iso can be used to install Gentoo/FreeBSD. Write to a CD or memory stick as necessary. 

Boot the PC using the installation CD.
Wait a moment while watching the boot process.
Please choose Live CD, if a Welcome screen is displayed. 
Then login prompt, enter root.

{{Note|If you have 4KB/sector HDD (aka AFT Drive)

Please select "2. [Esc]ape to loader prompt" at boot time if you have a 4KB/sector HDD.

Set the device name of your HDD with 4KB sectors in the boot loader. ada1 and ada2... to increase if you have more than one.

<pre>
set kern.cam.ada.0.quirks="1"
boot
</pre>
}}

==== Optional: Setting keymap  ====
If your keyboard is not an English 101 keyboard, please set keymap.
{{RootCmd|kbdcontrol -l uk.iso}}

A list of key map is available with the following command.
{{RootCmd|ls -1 /usr/share/syscons/keymaps {{!}} less}}

==== Network setting ====
First, create a directory /tmp/bsdinstall_etc to rewrite the resolv.conf. 
{{RootCmd|mkdir -p /tmp/bsdinstall_etc}}

Identify your network devices. This example is em0. 
{{RootCmd|ifconfig|output=
<pre>em0: flags=8843&lt;UP,BROADCAST,RUNNING,SIMPLEX,MULTICAST&gt; metric 0 mtu 1500
        options=209b&lt;RXCSUM,TXCSUM,VLAN_MTU,VLAN_HWTAGGING,VLAN_HWCSUM,WOL_MAGIC&gt;
        ether 00:00:00:00:00:00
        nd6 options=29&lt;PERFORMNUD,IFDISABLED,AUTO_LINKLOCAL&gt;
        media: Ethernet autoselect (1000baseT &lt;full-duplex&gt;)
        status: active
lo0: flags=8049&lt;UP,LOOPBACK,RUNNING,MULTICAST&gt; metric 0 mtu 16384
        options=3&lt;RXCSUM,TXCSUM&gt;
        inet6 ::1 prefixlen 128
        inet6 fe80::1%lo0 prefixlen 64 scopeid 0x3
        inet 127.0.0.1 netmask 0xff000000
        nd6 options=21&lt;PERFORMNUD,AUTO_LINKLOCAL&gt;</pre>}}

Set the default gateway and IP address. 

If you not use DHCP (IP address is an example)
{{RootCmd|ifconfig em0 192.168.0.100
|route add default 192.168.0.1
|echo "nameserver 8.8.8.8" > /etc/resolv.conf (example used a Google Public DNS)}}

If you use DHCP
{{RootCmd|dhclient em0}}

==== Optional: want to install via ssh ====
So far we could not use ssh. If you want to install via ssh from this step. 

{{RootCmd| mkdir -p /tmp/etc
| mount -t tmpfs tmpfs /tmp/etc
| mount -t unionfs /tmp/etc /etc
| passwd
| echo "PermitRootLogin yes" &gt;&gt; /etc/ssh/sshd_config
| /etc/rc.d/sshd onestart}}

Please connect with any ssh client. The username is root.

==== Setting the Partition ====
The installation target device of serial ATA and IDE are /dev/ada*.
SCSI and USB drive are /dev/da*.
Please identify the HDD using ls /dev/ada* or dmesg | grep ada.
In this case, the device is ada0. 

{{RootCmd|dmesg {{!}} grep ada|output=<pre>
ada0 at ata0 bus 0 scbus0 target 0 lun 0
ada0: <QEMU HARDDISK 0.15.> ATA-7 device
ada0: 16.700MB/s transfers (WDMA2, PIO 8192bytes)
ada0: 12288MB (25165824 512 byte sectors: 16H 63S/T 16383C)
ada0: Previously was known as ad0
</pre>}}

===== If you want to use the UFS2 file system (GPT) =====
{{Note|GPT partition is the standard FreeBSD 9.0.
Please read the next MBR section if you want use MBR partition.}}

This example is simple only two partitions.
If necessary, you can split /, /usr, /var, /tmp, and /home.
Please set using gpart.

{| class="wikitable"
! Partition
! Filesystem
! Size
! Description
|-
|/dev/ada0p1
|none
|just a bit
|Reserved for bootloader
|-
|/dev/ada0p2
|UFS2 + SU
|entire disk - swap space
|Root partition
|-
|/dev/ada0p3
|swap
|Rest of the disk
|Swap partition
|}
{{Note|Please add options -a 4k to gpart add command of all, if you have AFT drive (4096bytes/sector). Start of the partition is properly configured, you can get the best performance.}}

{{RootCmd| gpart create -s GPT ada0
| gpart add -s 64k -t freebsd-boot ada0
| gpart add -s 10G -t freebsd-ufs -l root ada0
| gpart add -t freebsd-swap -l swap ada0}}

Please run gpart show in order to verify the partition could be set. 

{{RootCmd|gpart show|output=
<pre>
=&gt;      34  25165757  ada0  GPT  (12G)
        34       128     1  freebsd-boot  (64k)
       162  20971520     2  freebsd-ufs  (10G)
  20971682   4194109     3  freebsd-swap  (2G)</pre>}}

Results when you create a partition with option -a 4k.

{{RootCmd|gpart show|output=
<pre>
=&gt;      34  25165757  ada0  GPT  (12G)
        34         6        - free -  (3.0k)
        40       128     1  freebsd-boot  (64k)
       168  20971520     2  freebsd-ufs  (10G)
  20971688   4194096     3  freebsd-swap  (2G)
  25165784         7        - free -  (3.5k)
</pre>}}

===== If you want to use the UFS2 file system (MBR) =====

{| class="wikitable"
! Partition
! Filesystem
! Size
! Description
|-
|/dev/ada0s1a
|UFS2 + SU
|entire disk - swap space
|Root partition
|-
|/dev/ada0s1b
|swap
|Rest of the disk
|Swap partition
|}

{{RootCmd| gpart create -s mbr ada0
| gpart add -t freebsd ada0
| gpart set -a active -i 1 ada0
| gpart create -s bsd ada0s1
| gpart add -s 10G -t freebsd-ufs ada0s1
| gpart add -t freebsd-swap ada0s1}}

===== If you want to use the ZFS file system (experimental) / (GPT) =====
{{RootCmd|gpart create -s GPT ada0
|gpart add -s 64k -t freebsd-boot ada0
|gpart add -t freebsd-zfs -l zfs-system ada0}}

==== Creating and mounting a file system ====
===== If you want to use the UFS2 file system =====
Please do not forget newfs -L option to label. 

{{Note|Add option -j to newfs if you want to enable soft updates journaling. Add option -t if you want to enable TRIM.}}

Your choice GPT)
{{RootCmd|newfs -L gfbsdroot -U /dev/ada0p2}}

Your choice MBR)
{{RootCmd|newfs -L gfbsdroot -U /dev/ada0s1a}}

And mount it. 
{{RootCmd|mount /dev/ufs/gfbsdroot /mnt
|swapon /dev/gpt/swap (GPT)
|swapon /dev/ada0s1b (MBR)}}

===== If you want to use the ZFS file system (experimental) =====
Load the kernel module in order to enable ZFS.
{{RootCmd|kldload zfs}}

Prepare the RAM disk to write /boot/zfs/zpool.cache.
{{RootCmd|mount -t tmpfs tmpfs /boot/zfs}}

Please use gnop if you have 4KB/sector HDD. You can get the best performance.
{{RootCmd|gnop create -S 4096 /dev/gpt/zfs-system}}

Creates a new storage pool. if you are using gnop, please specify /dev/gpt/zfs-system.nop instead of /dev/gpt/zfs-system.

{{RootCmd|zpool create zsys /dev/gpt/zfs-system
|zfs set mountpoint{{=}}none zsys}}

Creates a new ZFS file system.
{{RootCmd|zfs create zsys/root
|zfs set mountpoint{{=}}/mnt zsys/root
|zfs mount -a
|zfs create zsys/root/usr
|zfs create zsys/root/var}}
{{RootCmd|zfs create zsys/root/tmp
|zfs create zsys/home
|zfs create -V 8gb zsys/swap
|zfs set org.freebsd:swap{{=}}on zsys/swap
|zfs set checksum{{=}}off zsys/swap}}
{{RootCmd|mkdir /mnt/home
|mount -t zfs zsys/home /mnt/home}}

==== Downloading the Stage3 Tarball and Portage snapshot ====
Now, Gentoo/FreeBSD 9.0 stage3 is available for x86-fbsd. And Gentoo/FreeBSD 9.1 stage3 is available for amd64-fbsd.

{{Important|If you want to use x86-fbsd, please upgrade to 9.1 after the installation is complete. FreeBSD 9.0 is EOL on March 31, 2013.}}

{{RootCmd|cd /mnt
|fetch http://dev.gentoo.org/~aballier/fbsd9.0/x86/stage3-i686-freebsd-9.0.tar.bz2 (for x86-fbsd users)
|fetch http://distfiles.gentoo.org/experimental/bsd/freebsd/stages/amd64-fbsd-9.1/stage3-amd64-freebsd-9.1.tar.bz2 (for amd64-fbsd users)
|fetch http://distfiles.gentoo.org/snapshots/portage-latest.tar.bz2}}

==== Unpacking stage3 and Portage snapshot ====
{{RootCmd|cd /mnt
|setenv LANG "en_US.UTF-8"
|tar xjpf stage3-*.tar.bz2 -C /mnt
|tar xjf portage-latest.tar.bz2 -C /mnt/usr}}

==== Entering the new Environment ====
{{RootCmd|mount -t devfs devfs /mnt/dev
|cp /etc/resolv.conf /mnt/etc/
|chroot /mnt /bin/bash}}

=== Settings and install more in chroot environment ===

==== The first settings and time zone settings ====
env-update and time zone settings. Of course, you can modify /etc/portage/make.conf. 

{{RootCmd|env-update && source /etc/profile
|cp /usr/share/zoneinfo/GMT /etc/localtime (please select your time zone)
|emerge -u sys-apps/portage ; emerge sys-devel/libtool app-admin/eselect
|emerge app-editors/nano
|mv /etc/make.conf /etc/portage/ (if /etc/make.conf is exist.)
|nano -w /etc/portage/make.conf (if necessary)
|prompt=(chroot) root #}}

==== Bug fixes (for x86-fbsd users, 9.0 stage3 only) ====
Bugs have been fixed in several packages. Please upgrade them. For details, see {{Bug|324445}}, {{Bug|412319}}, {{Bug|417031}} and {{Bug|421191}}.

{{RootCmd|emerge sys-devel/gcc-config
|emerge sys-freebsd/freebsd-mk-defs sys-freebsd/freebsd-lib app-arch/libarchive dev-libs/libedit
|prompt=(chroot) root #}}

==== Special settings for ZFS ====
If you select ZFS file system, the following additional work is required.

{{RootCmd|emerge flaggie
|flaggie +zfs
|emerge sys-devel/flex
|emerge sys-freebsd/freebsd-cddl
|emerge sys-freebsd/freebsd-lib sys-freebsd/freebsd-ubin sys-freebsd/boot0
|prompt=(chroot) root #}}

==== Installing a kernel source ====
Unlike Gentoo/Linux, freebsd-sources package is the only sources.

{{RootCmd|USE{{=}}symlink emerge freebsd-sources
|prompt=(chroot) root #}}

==== Compiling and installing kernel ====
Now let's compile the kernel.
Copy the GENERIC in conf, you can change it by changing the kernel configuration.
For more information see the [http://www.freebsd.org/doc/handbook/kernelconfig.html FreeBSD Handbook].

{{RootCmd|emerge -u sys-devel/flex
|cd /usr/src/sys/i386/conf (case of x86-fbsd)
|cd /usr/src/sys/amd64/conf (case of amd64-fbsd)
|cp GENERIC.hints /boot/device.hints
|prompt=(chroot) root #}}
{{RootCmd|config GENERIC
|cd ../compile/GENERIC
|make cleandepend &amp;&amp; make depend &amp;&amp; make -j3 &amp;&amp; make install
|prompt=(chroot) root #}}

==== Installing the boot loader ====
Let's install a boot loader to boot the Gentoo/FreeBSD.
Boot loader configuration is done after exiting the chroot.

{{Note|gcc 4.5.x is required in order to compile boot0. Details, see {{Bug|409815}}
}}

{{RootCmd|emerge -u '<sys-devel/gcc-4.6'
|prompt=(chroot) root #}}

{{RootCmd|ls /usr/bin/gcc-4.5*|output=
/usr/bin/gcc-4.5.4
|prompt=(chroot) root #}}

{{RootCmd|CC{{=}}gcc-4.5.4 emerge sys-freebsd/boot0
|prompt=(chroot) root #}}

==== System setting ====
Familiar setting. 
Please refer to [http://www.gentoo.org/doc/en/handbook/handbook-amd64.xml?part=1&amp;chap=8 Gentoo Linux Handbook] if you need more information.

If you select UFS2
{{RootCmd|nano -w /etc/fstab|output=
<pre># Device	Mountpoint	FStype	Options	Dump	Pass#
/dev/ufs/gfbsdroot	/		ufs	rw	1	1

#your choice GPT (don't forget comment out)
#/dev/gpt/swap	none		swap	sw	0	0

#your choice MBR (don't forget comment out)
#/dev/ada0s1b	none		swap	sw	0	0
</pre>
|prompt=(chroot) root #}}

If you select ZFS
{{RootCmd|nano -w /etc/fstab|output=
<pre># Device	Mountpoint	FStype	Options	Dump	Pass#
#/dev/ad0s1a	/		ufs	rw	1	1
#/dev/ad0s1b	none		swap	sw	0	0
zsys/root	/		zfs	rw	0	0
</pre>
|prompt=(chroot) root #}}

Setting the host name
{{RootCmd|nano -w /etc/conf.d/hostname|output=
<pre># (Set the hostname variable to your host name)
hostname="daemon"
</pre>
|prompt=(chroot) root #}}

Editing network setting
{{RootCmd|nano -w /etc/conf.d/net|output=
<pre># (Set the dns_domain variable to your domain name)
dns_domain_lo="homenetwork"

# Manually setting)
config_em0="192.168.0.100 netmask 255.255.255.0"
routes_em0="default via 192.168.0.1"

# Using DHCP)
config_em0="dhcp"
</pre>
|prompt=(chroot) root #}}

Adding net.em0 to the default runlevel
{{RootCmd|cd /etc/init.d
|ln -s net.lo0 net.em0
|rc-update add net.em0 default
|prompt=(chroot) root #}}

Setting keymap

Please edit /etc/conf.d/syscons if you want to change keymap.
{{RootCmd|nano -w /etc/conf.d/syscons
|prompt=(chroot) root #}}

A list of key map is available with the following command.
{{RootCmd|ls -1 /usr/share/syscons/keymaps {{!}} less
|prompt=(chroot) root #}}

Setting the root password

{{RootCmd|passwd
|prompt=(chroot) root #}}

You can also be configured to run at startup <i>sshd</i>.

{{RootCmd|emerge -u net-misc/openssh
|rc-update add sshd default
|prompt=(chroot) root #}}

===== Special settings for ZFS =====
If you select ZFS file system, the following additional work is required.

{{RootCmd|rc-update add zfs boot
|rc-update add zvol default
|echo 'zfs_load{{=}}"YES"' >> /boot/loader.conf
|echo 'vfs.root.mountfrom{{=}}"zfs:zsys/root"' >> /boot/loader.conf
|prompt=(chroot) root #}}

==== Installing the required packages ====
If dhcpcd is required if you use DHCP.
{{RootCmd|emerge net-misc/dhcpcd
|prompt=(chroot) root #}}

==== Exit from chroot environment ====
Work done in the chroot environment.
exit from chroot environment.

{{RootCmd|exit
|prompt=(chroot) root #}}

=== Writes boot loader and Cleaning up ===
Do you want to reboot now ? Just a minute. We forgot to setting the boot loader.

If you select UFS2 (GPT)
{{RootCmd|gpart bootcode -b /mnt/boot/pmbr ada0
|gpart bootcode -p /mnt/boot/gptboot -i 1 ada0}}

If you select UFS2 (MBR)
{{RootCmd|gpart bootcode -b /mnt/boot/boot0 ada0
|gpart bootcode -b /mnt/boot/boot ada0s1}}

If you select ZFS
{{RootCmd|gpart bootcode -b /mnt/boot/pmbr ada0
|gpart bootcode -p /mnt/boot/gptzfsboot -i 1 ada0}}

==== Special settings for ZFS ====
If you select ZFS file system, the following additional work is required.

{{RootCmd|umount /mnt/dev
|cd /
|zpool set bootfs{{=}}zsys/root zsys
|zpool export zsys
|gnop destroy /dev/gpt/zfs-system.nop (please run if you are using gnop)}}
{{RootCmd|zpool import zsys
|mkdir /mnt/boot/zfs
|cp /boot/zfs/zpool.cache /mnt/boot/zfs/
|zfs unmount -a}}
{{RootCmd|zfs set mountpoint{{=}}none zsys
|zfs set mountpoint{{=}}/usr zsys/root/usr
|zfs set mountpoint{{=}}/var zsys/root/var
|zfs set mountpoint{{=}}/tmp zsys/root/tmp
|zfs set mountpoint{{=}}/home zsys/home
|zfs set mountpoint{{=}}legacy zsys/root}}

==== reboot! ====
Don't have a problem? Now we restart.
Don't forget to remove the Installation CD of FreeBSD.

{{RootCmd|shutdown -r now}}

== Howto run G/FBSD in vanilla FreeBSD's jail ==
Details of jail, please see the [http://www.freebsd.org/handbook/jails.html FreeBSD Handbook].

=== Preparing directory ===
{{RootCmd|mkdir -p /usr/jail/gfbsd
|cd /usr/jail/gfbsd}}

=== Downloading and Unpacking the Stage3 Tarball and Portage snapshot ===
{{RootCmd|fetch http://dev.gentoo.org/~aballier/fbsd9.0/x86/stage3-i686-freebsd-9.0.tar.bz2 (for x86-fbsd users)
|fetch http://distfiles.gentoo.org/experimental/bsd/freebsd/stages/amd64-fbsd-9.1/stage3-amd64-freebsd-9.1.tar.bz2 (for amd64-fbsd users)
|fetch http://distfiles.gentoo.org/snapshots/portage-latest.tar.bz2
|tar xjpf stage3-*.tar.bz2
|tar xjf portage-latest.tar.bz2 -C /usr/jail/gfbsd/usr}}

=== Setting ===
Configure jail to start with FreeBSD.
{{File|/etc/rc.conf|Example for start automatically jail|
<pre>
jail_enable="YES"
jail_list="gfbsd"

jail_gfbsd_rootdir="/usr/jail/gfbsd"
jail_gfbsd_hostname="gfbsd.example.org"
jail_gfbsd_devfs_enable="YES"

# You will also need to add the following line if you need network access.
# em0, please specify your network devices.
jail_gfbsd_interface="em0"
jail_gfbsd_ip="192.168.0.10"
</pre>}}

Setting to operate Gentoo/FreeBSD in jail.
{{RootCmd|echo 'rc_sys{{=}}"jail"' >> /usr/jail/gfbsd/etc/rc.conf
|echo 'hostname{{=}}"gfbsd"' > /usr/jail/gfbsd/etc/conf.d/hostname
|echo 'syslogd_args{{=}}"-ss"' >> /usr/jail/gfbsd/etc/conf.d/syslogd}}

{{RootCmd|chroot /usr/jail/gfbsd /bin/bash}}
{{RootCmd|rc-update add vixie-cron default
|exit
|prompt=(chroot) root #}}

=== run jail ===
Let's run jail.

{{RootCmd|/etc/rc.d/jail start}}

Verify that worked.
{{RootCmd|jls|output=
<pre>
   JID  IP Address      Hostname                      Path
     1  192.168.0.10    gfbsd                         /usr/jail/gfbsd
</pre>}}

To enter the jail environment will use the jexec command.
{{RootCmd|jexec 1 /bin/bash}}

== Upgrade howto ==
This guide will show you how to upgrade Gentoo/FreeBSD 9.1 from previous version.

{{Note|This guide is targeted to version 7.2 or higher.}}

=== Preparation ===
==== Bug fix ====
need to fix some bugs for the upgrade to be successful.

Details, see {{Bug|409815}}, {{Bug|444918}}.

{{RootCmd|cd /usr/portage/sys-freebsd/boot0
|wget -O boot0-9.1.ebuild "http://git.overlays.gentoo.org/gitweb/?p{{=}}proj/gentoo-bsd.git;a{{=}}blob_plain;f{{=}}sys-freebsd/boot0/boot0-9.9999.ebuild;h{{=}}c3832fc62168ce50fb4a4d0bb07d4d304d653a67;hb{{=}}215c51a65ef452b184003ae3a01b78adfa5881b3"
|ebuild boot0-9.1.ebuild digest
|mkdir -p /etc/portage/patches/sys-freebsd/freebsd-sources
|wget -O /etc/portage/patches/sys-freebsd/freebsd-sources/freebsd-sources-9.1-MFC-r239588.patch "http://git.overlays.gentoo.org/gitweb/?p{{=}}proj/gentoo-bsd.git;a{{=}}blob_plain;f{{=}}sys-freebsd/freebsd-sources/files/freebsd-sources-9.1-MFC-r239588.patch;h{{=}}5390d0ed7439ad0211682ee44171165d4ec4f035;hb{{=}}c2024950819c1f42785d7b82410381eb3a61dd8d"
}}

==== Change to latest profile ====
To emerge related to FreeBSD 9.1 is necessary to change the [[profile]].

Get a list of available profiles:
{{RootCmd|eselect profile list|output=
<pre>
Available profile symlink targets:
  [1]   default/bsd/fbsd/x86/9.0
  [2]   default/bsd/fbsd/x86/9.1
</pre>}}

Set the profile of 9.1:
{{RootCmd|eselect profile set 2}}

==== Updating sys-apps/portage ====
Please check first, what will be installed.
{{RootCmd|emerge -pu sys-apps/portage|output=
<pre>[ebuild     UD] sys-apps/portage-2.1.11.33 [2.2_rc49] USE="(ipc%*) (-pypy1_9) -python2% -xattr%"</pre>}}

After confirming that masked by: EAPI error does not appear, please upgrade.

Please add --exclude sys-freebsd/* option if failed messages sys-freebsd packages are mask is displayed.

{{RootCmd|emerge -u sys-apps/portage}}

Successfully updated, please check the version.
{{RootCmd|emerge --version|output=
Portage 2.1.11.33 (default/bsd/fbsd/x86/9.1, gcc-4.4.2, freebsd-lib-7.2, 9.1_rc3-Gentoo i386)}}

need version 2.2. If it is not 2.2, update portage again. 
{{RootCmd|emerge -u sys-apps/portage --exclude sys-freebsd/*}}

Recheck the version.
{{RootCmd|emerge --version|output=
Portage 2.2.0_alpha144 (default/bsd/fbsd/x86/9.1, gcc-4.4.2, freebsd-lib-7.2, 9.1_rc3-Gentoo i386)}}

In addition, check that it includes preserve-libs to FEATURES.
If it does not, please add FEATURES="preserve-libs" in make.conf.
{{Important|Please be sure to check whether preserve-libs is set to FEATURES. If it is not set, then your system will not work because required libraries are removed.}}

{{RootCmd|<nowiki>emerge --info | grep FEATURES= | grep preserve-libs</nowiki>|output=
FEATURES="assume-digests binpkg-logs chflags config-protect-if-modified distlocks ebuild-locks fixlafiles merge-sync news parallel-fetch preserve-libs protect-owned sfperms strict unknown-features-warn unmerge-logs unmerge-orphans userfetch"
}}

==== Move /etc/make.conf ====
Recently, /etc/make.conf has been moved to /etc/portage/make.conf. if it exists in /etc, please move it.

In addition, remove LDFLAGS from make.conf. If it is set, upgrade may fail.

{{RootCmd|mkdir -p /etc/portage
| if [ -e /etc/make.conf ] && [ ! -e /etc/portage/make.conf ] ; then
| mv /etc/make.conf /etc/portage/make.conf
| fi
| gsed -i '/LDFLAGS{{=}}/d' /etc/portage/make.conf}}

==== Fixed collision of tabs ====
If you are using version 8.0 and fewer, tabs might collide.
Please check the following steps.

{{RootCmd|cd /var/db/pkg/sys-freebsd}}
{{RootCmd|<nowiki>grep -r tabs * | grep obj</nowiki>|output=
<pre>
freebsd-ubin-7.2/CONTENTS:obj /usr/bin/tabs 741bc04f9e321d5d0f312b5cb8a87d6a 1257735235
freebsd-ubin-7.2/CONTENTS:obj /usr/share/man/man1/tabs.1.bz2 ed7bca86bc66d164cc1434583f6d8cd7 1257735225
</pre>}}
{{RootCmd|rm /usr/bin/tabs /usr/share/man/man1/tabs.1.bz2}}

And please update sys-libs/ncurses.

{{RootCmd|emerge -u sys-libs/ncurses --exclude sys-freebsd/*}}

==== Package updates the minimum required ====
update the minimal packages needed to upgrade.

{{RootCmd|emerge sys-freebsd/freebsd-mk-defs
|emerge -u sys-apps/findutils --exclude sys-freebsd/*
|emerge sys-devel/libtool --exclude sys-freebsd/*
|emerge -u sys-devel/flex sys-devel/patch sys-devel/m4 net-libs/libpcap sys-devel/gettext app-arch/libarchive dev-libs/libelf --exclude sys-freebsd/*
|emerge sys-devel/libtool --exclude sys-freebsd/*
}}

==== Migrate to lib from lib64 (for amd64-fbsd users, 9.0 stage3 only) ====
{{Important|Do not skip this chapter!}}

If you are using 9.0 stage3 of amd64-fbsd, you will need to migrate to lib from lib64 first.

If you skip this step, all the commands you will not be able to run when upgrade sys-apps/baselayout. For details, see {{Bug|436560}}

{{RootCmd|wget -O /tmp/migrate_libdir.sh "http://git.overlays.gentoo.org/gitweb/?p{{=}}proj/gentoo-bsd.git;a{{=}}blob_plain;f{{=}}scripts/migrate_libdir.sh;hb{{=}}HEAD"
|bash /tmp/migrate_libdir.sh
|emerge -u sys-apps/baselayout --exclude sys-freebsd/* }}

=== Kernel update ===
First of all, you need to update your kernel.
It is because the package of a userland may use the new function of a kernel. 

Please be sure to update a kernel first !

{{RootCmd|<nowiki>USE=symlink emerge freebsd-sources</nowiki>
|cd /usr/src/sys/i386/conf (case of x86-fbsd)
|cd /usr/src/sys/amd64/conf (case of amd64-fbsd)
|cp GENERIC.hints /boot/device.hints}}
{{RootCmd|config GENERIC
|cd ../compile/GENERIC
|make cleandepend &amp;&amp; make depend &amp;&amp; make -j3 &amp;&amp; make install}}

==== failed to compile the kernel ====
Please get the GENERIC kernel of FreeBSD if you fail to compile the kernel.
If you are using amd64-fbsd, please replace the i386 to amd64 in URL.

{{Important|Don't forget to rebuild the kernel after updating FreeBSD userland!}}

{{RootCmd|wget -P /tmp http://ftp.freebsd.org/pub/FreeBSD/releases/i386/i386/9.1-RELEASE/base.txz
|wget -P /tmp http://ftp.freebsd.org/pub/FreeBSD/releases/i386/i386/9.1-RELEASE/kernel.txz
|mv /boot /boot.orig
|cd /
|tar xvJf /tmp/base.txz ./boot
|tar xvJf /tmp/kernel.txz}}

==== reboot ====
Don't have a problem? Now we restart.

{{RootCmd|shutdown -r now}}

After rebooting your machine, please check if the kernel is new. 

{{RootCmd|uname -a|output=
<pre>FreeBSD daemon 9.1-Gentoo FreeBSD Gentoo 9.1 #0: Fri Jan 20 00:01:04 JST 2012
     root@daemon:/usr/src/sys-9.1-r0/amd64/compile/GENERIC  amd64
</pre>}}

=== Updating FreeBSD userland ===
The first emerge the core library. 

{{RootCmd|<nowiki>USE=build emerge -1 --nodeps sys-freebsd/freebsd-lib</nowiki>}}

Update the userland of FreeBSD.

{{RootCmd|emerge -C sys-process/fuser-bsd
|USE{{=}}symlink emerge -auN boot0 freebsd-bin freebsd-cddl freebsd-contrib freebsd-lib freebsd-libexec freebsd-mk-defs freebsd-pam-modules freebsd-sbin freebsd-share freebsd-ubin freebsd-usbin
}}

Cleanup, utmp related files
{{RootCmd|rm /var/run/utmp /var/log/lastlog /var/log/wtmp*}}

=== Change CHOST and rebuild toolchain ===
{{Note|You can skip this step if you are minor upgrading. Please next Cleaning step.}}

Change CHOST, and emerge binutils gcc. (FYI, [http://www.gentoo.org/doc/en/change-chost.xml Changing the CHOST variable])

x86-fbsd users)
{{RootCmd|<nowiki>gsed -i 's:CHOST=.*:CHOST="i686-gentoo-freebsd9.1":g' /etc/portage/make.conf</nowiki>}}
amd64-fbsd users)
{{RootCmd|<nowiki>gsed -i 's:CHOST=.*:CHOST="x86_64-gentoo-freebsd9.1":g' /etc/portage/make.conf</nowiki>}}

emerge binutils gcc

{{emerge|params=-1
|sys-devel/binutils
|sys-devel/gcc}}

check gcc's 8.x stuff

{{RootCmd|gcc-config -l|output=
<pre> * broken config file: /etc/env.d/gcc/i686-gentoo-freebsd8.0-4.4.3
 [1] i686-gentoo-freebsd8.0-4.4.3 *
 [2] i686-gentoo-freebsd9.1-4.6.3
</pre>}}

remove 8.x stuff.

{{RootCmd|emerge -C '&lt;gcc-4.6'}}

{{RootCmd|gcc-config -c|output=
i686-gentoo-freebsd9.1-4.6.3}}

also check binutils

{{RootCmd|binutils-config -l|output=
<pre> [1] i686-gentoo-freebsd9.1-2.20.1 *
</pre>}}

{{RootCmd|binutils-config -c|output=
i686-gentoo-freebsd9.1-2.20.1}}

remove FreeBSD 8.x env data.

{{RootCmd|cd /etc/env.d/
|grep gentoo-freebsd8. *|output=
<pre>
04gcc-i686-gentoo-freebsd8.0:PATH="/usr/i686-gentoo-freebsd8.0/gcc-bin/4.4.3"
04gcc-i686-gentoo-freebsd8.0:ROOTPATH="/usr/i686-gentoo-freebsd8.0/gcc-bin/4.4.3"
04gcc-i686-gentoo-freebsd8.0:MANPATH="/usr/share/gcc-data/i686-gentoo-freebsd8.0/4.4.3/man"
04gcc-i686-gentoo-freebsd8.0:INFOPATH="/usr/share/gcc-data/i686-gentoo-freebsd8.0/4.4.3/info"
04gcc-i686-gentoo-freebsd8.0:LDPATH="/usr/lib/gcc/i686-gentoo-freebsd8.0/4.6.3
04gcc-i686-gentoo-freebsd8.0:/usr/lib/gcc/i686-gentoo-freebsd8.0/4.4.3"
05gcc-i486-gentoo-freebsd8.0:MANPATH="/usr/share/gcc-data/i486-gentoo-freebsd8.0/4.4.3/man"
05gcc-i486-gentoo-freebsd8.0:INFOPATH="/usr/share/gcc-data/i486-gentoo-freebsd8.0/4.4.3/info"
05gcc-i486-gentoo-freebsd8.0:LDPATH="/usr/lib/gcc/i486-gentoo-freebsd8.0/4.4.3"
05gcc-i486-gentoo-freebsd8.0:PATH="/usr/i486-gentoo-freebsd8.0/gcc-bin/4.4.3"
05gcc-i486-gentoo-freebsd8.0:ROOTPATH="/usr/i486-gentoo-freebsd8.0/gcc-bin/4.4.3"
</pre>}}

target file name is 04gcc-i686-gentoo-freebsd8.0, 05gcc-i486-gentoo-freebsd8.0 in this case.

{{RootCmd|rm 04gcc-i686-gentoo-freebsd8.0 05gcc-i486-gentoo-freebsd8.0
|env-update &amp;&amp; source /etc/profile
|/usr/share/gcc-data/i686-gentoo-freebsd9.1/4.6.3/fix_libtool_files.sh 4.4.3 --oldarch i686-gentoo-freebsd8.0
}}

Recreate all packages.
{{RootCmd|emerge sys-devel/libtool
|emerge -ae @world --exclude sys-apps/portage
|emerge sys-apps/portage}}

Failure to compile the package if any, 'emerge --resume --skipfirst' is your friend.
Also, please bug report the problem if you like.

{{Note|If emerge fails to compile sys-freebsd/boot0, please see [[#Troubleshooting]].}}

=== Cleaning ===
Let's remove the backup files when you have finished all the steps.
{{Important|don't forget etc-update ! }}
{{RootCmd|emerge sys-devel/libtool app-admin/eselect
|emerge @preserved-rebuild
|etc-update}}

=== Re-select profile ===
Please re-select the profile if make.profile exists in /etc.

{{RootCmd|ls -l /etc/make.profile|output=
<pre>
lrwxr-xr-x  1 root  portage  48 Dec  1 00:00 /etc/make.profile -> ../usr/portage/profiles/default/bsd/fbsd/x86/9.1
</pre>
}}

{{RootCmd|rm /etc/make.profile
|eselect profile list|output=
<pre>
Available profile symlink targets:
  [1]   default/bsd/fbsd/x86/9.0
  [2]   default/bsd/fbsd/x86/9.1
</pre>}}

{{RootCmd|eselect profile set 2}}

== Experimental Zone ==
=== How to use X Window System with vesa video card ===
{{Important|Please check {{Bug|428112}} and {{Bug|435640}} and {{Bug|435648}} first.
Please to create your own overlay. And, please apply the patch attached to the bug.}}

{{Note|Please update wiki if you know a better way.

Also welcome to fix the problem. Please file a bug.}}

{{RootCmd|emerge portage ; emerge libtool app-admin/eselect
|mv /etc/make.conf /etc/portage/make.conf (be careful !)
|emerge -u flaggie
|flaggie +python +X}}

{{RootCmd|echo 'INPUT_DEVICES{{=}}"keyboard mouse"' >> /etc/portage/make.conf
|echo 'VIDEO_CARDS{{=}}"vesa"' >> /etc/portage/make.conf
|echo "media-libs/mesa -~amd64-fbsd -~x86-fbsd amd64" >> /etc/portage/package.keywords}}

{{RootCmd|emerge -p xorg-x11
|emerge xorg-x11
|emerge x11-drivers/xf86-input-mouse
|emerge xorg-drivers
|emerge xterm twm xclock
|Xorg -configure
|mv /root/xorg.conf.new /etc/X11/xorg.conf}}

Check the device for mouse
{{RootCmd|grep /dev /etc/X11/xorg.conf|output=
<pre>        Option      "Device" "/dev/sysmouse"</pre>
}}

OK, In this case /dev/sysmouse has been detected.
{{RootCmd|/etc/init.d/moused start
|rc-update add moused default
|startx}}

==== Other video cards ====
xf86-video-vmware)
{{RootCmd|ACCEPT_KEYWORDS{{=}}amd64 emerge --nodeps '<x11-drivers/xf86-video-vmware-12.0.0'}}

==== Q&A ====
Q. mouse does not work

A. PS/2 mouse is /dev/psm0ã€USB mouse is /dev/usm0. another one is /dev/sysmouse.
Please specify in xorg.conf correctly.
You need to start moused to use /dev/sysmouse. Run /etc/init.d/moused start.

=== Experimental clang stages ===
{{Important|clang stages is using clang as the system compiler. It's very experimental.}}

clang stages is available from the following URL:

http://distfiles.gentoo.org/experimental/bsd/freebsd/stages/amd64-fbsd-9.1/clang/stage3-amd64-clangfbsd-9.1.tar.bz2

Please see bug list and page [[Clang]]. In addition, please report to Gentoo Bugzilla if you find a package that can not be compiled with clang.

==== Bug list ====
*{{Bug|417795}}: dev-libs/openssl-1.0.0j and dev-libs/openssl-1.0.1c fail to build with Clang
*{{Bug|474486}}: dev-libs/libgcrypt-1.5.2-r1: build fails with using clang-3.3 on x86-fbsd 
*{{Bug|417789}}: [TRACKER] Packages that fail to build with LLVM/Clang on Gentoo FreeBSD

=== How to migrate from amd64/9.1 profile to amd64/9.1/clang ===
{{Important|Please check {{Bug|474042}} first. Please apply patches attached to the bug.}}

{{RootCmd|emerge -a sys-devel/clang sys-libs/libcxx
|CC{{=}}clang CXX{{=}}"clang++ -stdlib{{=}}libc++" emerge -B sys-devel/llvm sys-devel/clang
|emerge -K sys-devel/llvm sys-devel/clang
|eselect profile set default/bsd/fbsd/amd64/9.1/clang}}

==== Why make the package once ? ====
When compiled with CXX="clang++ -stdlib=libc++" to llvm or clang, clang command does not work at all (Segmentation fault occurs always).

When set CXX="clang++ -stdlib=libc++", in order to successfully compile them, should both be linked to libc++.so.1.

== Troubleshooting ==

=== amd64-fbsd ===

==== All commands is not working after emerge sys-apps/baselayout ====

After failing to emerge baselayout, all commands will not work. Details, see {{Bug|436560}}

{{RootCmd|ls|output=<pre>
Shared object "libutil.so.9" not found, required by "ls"
</pre>}}

If you have not restarted the PC, please run this command first.
{{RootCmd|export LD_LIBRARY_PATH{{=}}"/lib64:/usr/lib64"}}

If you restart or turn off your PC already has a need to restore your system using the installation CD of FreeBSD.

# boot using the installation media of FreeBSD.
# Live CD select
# Mount the root partition of G/FBSD (eg. mount /dev/ufs/gfbsdroot /mnt)
# cd /mnt (Please replace to /mnt/,/mnt/usr... from /,/usr... )

Please check lib in /, /usr, /usr/local.

{{RootCmd|ls -l /lib /usr/lib /usr/local/lib|output=<pre>
ls: /lib: No such file or directory
lrwxr-xr-x  1 root  wheel  5 Oct 14 06:41 /usr/lib -> lib64

lrwxr-xr-x  1 root  wheel  5 Oct 14 06:41 /usr/local/lib -> lib64
</pre>}}

In this case, the symbolic link /lib is simply removed. Let's re-create symbolic link /lib.

{{RootCmd|ln -s lib64 /lib}}

You need to migrate from lib64 to lib before run emerge baselayout so far. Run the script for migration.

If you have to recover by using FreeBSD's installation media, please enter in G/FBSD run chroot /mnt !

{{RootCmd|wget -O /tmp/migrate_libdir.sh "http://git.overlays.gentoo.org/gitweb/?p{{=}}proj/gentoo-bsd.git;a{{=}}blob_plain;f{{=}}scripts/migrate_libdir.sh;hb{{=}}HEAD"
|bash /tmp/migrate_libdir.sh
|emerge sys-apps/baselayout}}

==== can not boot a kernel panic always occurs ====
Details, see {{Bug|408019}}

workaround is to use gcc 4.3 or clang to compile the kernel.

==== amd64 kernel + x86 stage environment, tar will not work successfully. ====
Details, see {{Bug|444918}}

Error messages:
<pre>
tar: getvfsbyname failed: No such file or directory
tar: Error exit delayed from previous errors.
</pre>

workaround fix
{{RootCmd|emerge {{=}}libarchive-3.0.3}}

==== gcc fails to compile, Error message is recompile -fPIC ====
Details, see {{Bug|415185}} .

workaround fix
{{emerge|sys-devel/gcc}}

=== Architecture Independent Issues ===

==== The kernel fails to mount a ZFS root filesystem with error 2 ====
Your /boot/zfs/zpool.cache file is missing information about the pool containing your root filesystem.

Boot a FreeBSD LiveCD and enter the shell. Then import your pool using the name of your pool intead of "rpool":
{{RootCmd|zpool import -f -N rpool}}

Inform ZFS what your root dataset is using its name instead of "rpool/ROOT/freebsd":
{{RootCmd|zfs set mountpoint{{=}}/ rpool/ROOT/freebsd}}

Export the pool
{{RootCmd|zpool export rpool}}

Import the pool again, except this time over your Live CD's root filesystem:
{{RootCmd|zpool import rpool}}

Now force the system to reboot and it should work. This procedure originally described on the [http://forums.freebsd.org/showpost.php?p=153410&postcount=2 FreeBSD forums].

==== Emerge fails net-misc/openssh ====
Details, see {{Bug|391011}}

workaround fix for openssh
{{RootCmd|EXTRA_ECONF{{=}}'--disable-utmp --disable-wtmp' emerge '>net-misc/openssh-6.0'}}

Another issue. If the following error message is displayed, please try EXTRA_ECONF{{=}}'--disable-lastlog'
<pre>
loginrec.c: In function 'lastlog_openseek':
loginrec.c:1506:46: error: invalid application of 'sizeof' to incomplete type 'struct lastlog'
loginrec.c: In function 'lastlog_write_entry':
loginrec.c:1536:17: error: storage size of 'last' isn't known
loginrec.c:1536:17: warning: unused variable 'last' [-Wunused-variable]
loginrec.c: In function 'lastlog_get_entry':
loginrec.c:1589:17: error: storage size of 'last' isn't known
loginrec.c:1589:17: warning: unused variable 'last' [-Wunused-variable]
</pre>

==== Emerge fails app-misc/screen ====
Details, see {{Bug|393039}} and {{Bug|409819}}.

Please use app-misc/tmux instead of app-misc/screen.

==== lex: not found ====
{{emerge|sys-devel/flex}}

==== cc: not found ====
Details, see {{Bug|412319}}

{{RootCmd|emerge '>{{=}}sys-devel/gcc-config-1.7.1'}}

==== Emerge fails sys-freebsd/boot0 using >gcc-4.6 ====
Details, see {{Bug|409815}}

workaround:
{{RootCmd|emerge -u '<sys-devel/gcc-4.6'
|CC{{=}}gcc-4.5.4 emerge boot0
}}

== Contacts ==
* gentoo-bsd mailing list ( [http://www.gentoo.org/main/en/lists.xml Gentoo Mailing Lists])
* IRC Channel #gentoo-bsd on freenode ( [http://www.gentoo.org/main/en/irc.xml Gentoo Linux IRC Resources] )

== See also ==
* [http://www.gentoo.org/proj/en/gentoo-alt/bsd/fbsd/ Gentoo/FreeBSD Project page]
* [http://www.gentoo.org/doc/en/gentoo-freebsd.xml A short guide to Gentoo/FreeBSD]
* [http://www.gentoo.org/proj/en/gentoo-alt/contribute/index.xml Gentoo/Alt Contributor's Guide]
* [[Project:Gentoo/Staffing_Needs]]
* [http://www.gentoo.org/doc/en/handbook/ Gentoo/Linux Handbook]
* [http://www.freebsd.org/handbook/ FreeBSD Handbook]
* [http://www.freebsd.org/cgi/man.cgi FreeBSD Man Pages]
* [http://wiki.freebsd.org/ZFSTuningGuide ZFSTuningGuide - FreeBSD Wiki]
* [http://wiki.freebsd.org/ FreeBSD Wiki]

[[Category:Core system]]
