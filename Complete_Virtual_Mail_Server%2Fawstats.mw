== Introduction ==
Even though postfix provides logs, having them graphically displayed and analyzed can give much more insight. {{Package|www-misc/awstats}} is a popular log analyzer that can parse logs and setup proper results.


== Installation ==
AWStats is a web-application but no longer relies on webapp-config. If it hasn't emerged already, it needs to be emerged.
{{Emerge|www-misc/awstats}}

Once installed, a config file needs to be created, either per domain, or one that handles all domains.

{{RootCmd|cp /etc/awstats/awstats.model.conf /etc/awstats/awstats.example.com.conf}}

== Configuration ==
=== AWStats ===
AWStats comes with reasonable defaults, but some need to be changed nevertheless.

For one, awstats assumes that vhosts aren't used. When using apache's default combined vhost logs for example, awstats will fail to run.

Assuming apache's combined LogFormat is setup as follows.
{{Code|Apache's LogFormat|<pre>LogFormat "%v %h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\" VLOG=%{VLOG}e" vhost</pre>}}

The following changes needs to be made.
{{File|/etc/awstats/awstats.example.com.conf|Match Logformat to apache's.|<pre>
LogFormat = "%virtualname %host %other %logname %time1 %methodurl %code %bytesd %refererquot %uaquot"
</pre>}}

Next awstats needs to know about the domains and aliases to filter from the log file.
{{File|/etc/awstats/awstats.example.com.conf|Make awstats listen to the domains|<pre>
SiteDomain="example.com"

HostAliases="localhost 127.0.0.1 REGEX[example\.com)$] REGEX[example\.(org|net)$]
</pre>}}

Also, awstats needs to store its database somewhere. Gentoo has created ''/var/lib/awstats'' for this use, but can be stored anywhere.
{{File|/etc/awstats/awstats.example.com.conf|AWStats database storage|<pre>
DirData="/var/lib/awstats"
</pre>}}

Any other changes to the configuration file are optional, but interesting to look into.
{{Note|When using the graphapplet plugin, the java applet may not display, see {{Bug|400589}} for more information.}}

=== Logging ===
awstats needs to process the apache logfile to build its database. Once confirmed that it is working manually it can be automated.
==== Manually ====
First, awstats should be run from the console, to spot any initial errors.
{{Cmd|<nowiki>awstats.pl -config=stats.example.com -update -showdropped</nowiki>}}

This should list any issues and missing domain names from the config.
==== Cron ====
If everything is working perfectly, it can then be added to cron.hourly.
{{File|/etc/cron.hourly/awstats|AWstats cronjob|<pre>
#!/bin/sh
awstats.pl -config=stats.example.com -update > /dev/null 2>&1
</pre>}}
Remember to make the script executeable if needed.

==== Logrotate ====
Awstats will process the log file every hour, but when logrotate rotates apache's log, some entries may be missing. This is easily solved however.
{{File|/etc/logrotate.d/apache2|Diff of pre-init script|<pre>
# Apache2 logrotate snipet for Gentoo Linux
# Contributes by Chuck Short
#
/var/log/apache2/*log {
  missingok
  notifempty
  sharedscripts
+  prerotate
+  /etc/cron.hourly/awstats > /dev/null 2>&1
+  endscript
  postrotate
  /etc/init.d/apache2 reload > /dev/null 2>&1 || true
  endscript
}
</pre>}}

=== Apache ===
For awstats to be used from apache, the webhost needs to properly setup. In the alias section, the following needs to be added.
{{File|/etc/apache2/vhosts.d/stats.example.com|Aliases for awstats|<pre>
        Alias /awstats/classes "/usr/share/awstats/wwwroot/classes"
        Alias /awstats/css "/usr/share/awstats/wwwroot/css"
        Alias /awstats/icon "/usr/share/awstats/wwwroot/icon"
        ScriptAlias /awstats/ "/usr/share/awstats/wwwroot/cgi-bin/"
        ScriptAlias /awstats "/usr/share/awstats/wwwroot/cgi-bin/awstats.pl"
</pre>
}}

Finally, awstats needs the correct permissions to be accessable.
{{File|/etc/apache2/vhosts.d/stats.example.com|Aliases for awstats|<pre>
<Directory "/usr/share/awstats/wwwroot">
        AllowOverride None
        Options None
        Order allow,deny
        Allow from all
</Directory>
</pre>}}

After a restart of apache, awstats should be available via ''http://stats.example.com/awstats/awstats.pl?config=stats.example.com''. If no config option is passed to awstats, it uses the current hostname, which means in this case could have been omitted.

== Awstats for mail log ==
AWStats is known for being an apache log parser. However it can also be used to parse mail logs.
=== Configuration ===
After copying ''awstats.stats.example.com.conf'' to ''awstats.mail.example.com.conf'' quite a few changes are required to turn awstats into a mail log parser.
{{File|/etc/awstats.mail.example.com.conf|Log mail.log instead of access.log (diff -u, only additions and deletions)|<pre>
-LogFile="/var/log/apache2/access_log"
+LogFile="perl /usr/bin/awstats_maillogconvert.pl standard < /var/log/mail.log |"

-LogType=W
+LogType=M

-LogFormat=1
+LogFormat="%time2 %email %email_r %host %host_r %method %url %code %bytesd"

-SiteDomain="localhost"
+SiteDomain="example.com"


-HostAliases="localhost 127.0.0.1 REGEX[myserver\.com$]"
+HostAliases="localhost 127.0.0.1 REGEX[example\.(net|org)$]"

-DirData="."
+DirData="/var/lib/awstats"

-LevelForBrowsersDetection=2         # 0 disables Browsers detection.
+LevelForBrowsersDetection=0        # 0 disables Browsers detection.
                                     # 2 reduces AWStats speed by 2%
                                     # allphones reduces AWStats speed by 5%
-LevelForOSDetection=2               # 0 disables OS detection.
+LevelForOSDetection=0               # 0 disables OS detection.
                                     # 2 reduces AWStats speed by 3%
-LevelForRefererAnalyze=2            # 0 disables Origin detection.
+LevelForRefererAnalyze=0            # 0 disables Origin detection.
                                     # 2 reduces AWStats speed by 14%
-LevelForRobotsDetection=2           # 0 disables Robots detection.
+LevelForRobotsDetection=0           # 0 disables Robots detection.
                                     # 2 reduces AWStats speed by 2.5%
-LevelForSearchEnginesDetection=2    # 0 disables Search engines detection.
+LevelForSearchEnginesDetection=0    # 0 disables Search engines detection.
                                     # 2 reduces AWStats speed by 9%
-LevelForKeywordsDetection=2         # 0 disables Keyphrases/Keywords detection.
+LevelForKeywordsDetection=0         # 0 disables Keyphrases/Keywords detection.
                                     # 2 reduces AWStats speed by 1%
-LevelForFileTypesDetection=2        # 0 disables File types detection.
+LevelForFileTypesDetection=0        # 0 disables File types detection.
                                     # 2 reduces AWStats speed by 1%
 LevelForWormsDetection=0            # 0 disables Worms detection.
                                     # 2 reduces AWStats speed by 15%

-ShowRobotsStats=HBL
+ShowRobotsStats=0

-ShowEMailSenders=0
+ShowEMailSenders=HBML

-ShowEMailReceivers=0
+ShowEMailReceivers=HBML

-ShowSessionsStats=1
+ShowSessionsStats=0

-ShowPagesStats=PBEX
+ShowPagesStats=0

-ShowFileTypesStats=HB
+ShowFileTypesStats=0

-ShowFileSizesStats=0
+ShowFileSizesStats=1

-ShowDownloadsStats=HB
+ShowDownloadsStats=0

-ShowOSStats=1
+ShowOSStats=0

-ShowBrowsersStats=1
+ShowBrowsersStats=0

-ShowOriginStats=PH
+ShowOriginStats=0

-ShowKeyphrasesStats=1
+ShowKeyphrasesStats=0

-ShowKeywordsStats=1
+ShowKeywordsStats=0

-ShowMiscStats=a
+ShowMiscStats=0

-ShowHTTPErrorsStats=1
+ShowHTTPErrorsStats=0

-ShowSMTPErrorsStats=0
+ShowSMTPErrorsStats=1
</pre>}}

With those changes in place, a manual run should work without any issues.
{{Cmd|awstats run from the CLI|<pre>
awstats.pl -config=mail.example.com -showcorrupted -showdropped
</pre>}}

=== Logging ===
To scan the mail log every hour, the existing awstats script in cron.hourly can be appended with the following.
{{File|/etc/cron.hourly/awstats|Add parsing of the mail log|<pre>
awstats.pl -config=mail.example.com -update > /dev/null 2>&1
</pre>}}

Also syslog is getting rotated and thus awstats needs to parse the mail log file before the mail log is being rotated.
{{File|/etc/logrotate.d/syslog-ng|Modify mail log entry in syslog|<pre>
# Mail system
/var/log/mail.log /var/log/mail.info /var/log/mail.err /var/log/mail.warn {
    sharedscripts
    missingok
    prerotate
        /etc/cron.hourly/awstats
    endscript
    postrotate
        /etc/init.d/syslog-ng reload > /dev/null 2>&1 || true
    endscript
}
</pre>}}

{{Note|The ''/var/log/mail.log'' file does not have to be on the same server. AWStats will have to have access to it. This could be via nfs, or having syslog do remote logging.}}

If logging of apache files is not desired, or webmail resides on a different server, the webserver log parsing can be removed from cron jobs.
