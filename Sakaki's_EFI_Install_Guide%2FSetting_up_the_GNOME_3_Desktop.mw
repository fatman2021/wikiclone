<!-- Page: Setting_up_the_GNOME_3_Desktop -->

<span id="setup_gnome_desktop">In this section</span>, we'll be setting up {{Highlight|GNOME 3}} on your machine.

GNOME 3 is a feature-rich desktop environment provided by the [https://www.gnome.org Gnome Project]. It is one of the most widely-used Linux desktops. Version 3 has now been stabilized on Gentoo, and the older version 2 is no longer supported (reflecting an upstream decision).

GNOME's user interface is known as the [[:Wikipedia:GNOME_Shell|"GNOME Shell"]]. It provides core user functions,<ref>[https://wiki.gnome.org/Projects/GnomeShell/CheatSheet GNOME Shell Cheat Sheet"</ref> such as:
* launching applications, 
* switching windows and desktops, 
* searching for programs and files,
* notification management, etc.
and uses accelerated, modern-looking graphics:

[[File:GNOME_Shell_3.12.png|thumb|none|400px|GNOME Shell v3.12 in Overview Mode]]

For more information about GNOME, see its [https://www.gnome.org official site] and [[:Wikipedia:GNOME|Wikipedia page]]. A list of GNOME releases may be found [[:Wikipedia:GNOME#Releases|here]].

As of the time of writing, the [[:Wikipedia:X_Window_System|X Window System ("X11")]] is still the most usual platform on which to deploy the GNOME 3 environment (although it is slowly being transitioned to use the more lightweight [[:Wikipedia:Wayland_(display_server_protocol)|Wayland]] compositor).

Accordingly, the process we'll be following in this section is:
# Adding a regular (non-root) user;
# Installing X11;
# Temporarily installing a simple X11 window manager, and a few applications, for test purposes;
# Reconfiguring the kernel if necessary (to include missing graphic drivers etc.) and recompiling using <tt>buildkernel</tt>;
# Installing GNOME 3 and key applications; then
# Testing GNOME 3, and refining settings.

This section has no direct equivalent in the Gentoo Handbook (although the part about adding a user reflects the [[Handbook:AMD64/Installation/Finalizing#User_administration|"User Administration"]] section from Chapter 11, and the X11 troubleshooting section has elements of the [[Handbook:AMD64/Installation/Kernel#Default:_Manual_configuration|"Default: Manual (Kernel) Configuration"]] section from Chapter 7). 

{{Note|You may find the articles [[GNOME/Configuration{{!}}"GNOME Configuration HOWTO"]] and [[Systemd/Installing Gnome3 from scratch{{!}}"systemd/Installing Gnome3 from scratch"]] (both from the Gentoo wiki) useful background reading.}}

{{Note|The transition from GNOME 2 to 3 has caused some controversy in the Linux community, as it involves a significant shift away from the more 'traditional' desktop metaphor (see [[:Wikipedia:Controversy_over_GNOME_3{{!}}this Wikipedia article]] for example). And forces you to use <tt>systemd</tt>...

If the newer look is not for you, don't despair. Although GNOME 2 is no longer supported in Gentoo, other similar desktops are; for example:
* [[:Wikipedia:LXDE{{!}}LXDE]] (via package {{Package|lxde-base/lxde-meta}}), 
* [[:Wikipedia:XFCE{{!}}XFCE]] (via package {{Package|xfce-base/xfce-meta}}) etc. 

However, installing these is beyond the scope of this guide. In what follows, I'm going to assume you want to use the GNOME 3 desktop.}}

Right, let's get started!

== <span id="add_regular_user">Adding a User for Daily Use</span> ==

Per the [[Handbook:AMD64/Installation/Finalizing#User_administration|Gentoo Handbook]], it is strongly recommended to set up a user for day-to-day use on your machine. Let's do that now. <span id="setup_regular_user">Issue (via the <tt>ssh</tt> connection from the helper PC)</span>:
{{RootCmd
|useradd --create-home --groups users,wheel,portage,lpadmin,lp --shell /bin/bash --comment "sakaki" sakaki
|passwd sakaki
|prompt=koneko <span style{{=}}"color:royalblue;">~ #</span>
|output=<pre>
New password: <enter your new password>
Retype new password: <enter your new password again>
passwd: password updated successfully
</pre>
}}
{{Note|Obviously, substitute your real name (for <tt>"sakaki"</tt>) and desired username (for <tt>sakaki</tt>)  in the above commands. You can also define multiple users at this point if you like.}}
{{Important|Be sure to write this password down somewhere safe! You will require it to log in later.}}
{{Note|Feel free to add or remove groups as required in the <tt>useradd</tt> command - the above set is a reasonable starting point for a 'power user' under <tt>systemd</tt> in Gentoo. See the description below for further information.}}

The meaning of those <tt>useradd</tt> options is as follows:

{| class="wikitable"
|-
! Parameter !! Short Form !! Meaning
|-
| <tt>--create-home</tt> || <tt>-m</tt> || Create the user's home directory if it does not already exist.
|-
| <tt>--groups</tt> || <tt>-G</tt> || Specify a set of supplementary groups for the user. By default on Gentoo, when a user is created, a new group of the same name will also be created, and become that user's [https://library.linode.com/using-linux/users-and-groups#sph_working-with-groups primary group]. The additional groups specified here have the following function:<ref>[https://www.debian.org/doc/manuals/securing-debian-howto/ch12.en.html#s-faq-os-users ''Securing Debian Manual'': Chapter 12: "Operating system users and groups"]</ref><ref>Ubuntu Wiki: [https://wiki.ubuntu.com/Security/Privileges "Privileges"]</ref><ref>Debian GNU/Linux Desktop Survival Guide: [http://www.togaware.com/linux/survivor/Standard_Groups.html "Standard Groups"]</ref>
{| class="wikitable"
|-
! Group !! Description
|-
| <tt>users</tt> || This is the standard group for users.
|-
| <tt>wheel</tt> || Members of this group can use <tt>su</tt> to masquerade as other users (including the <tt>root</tt> user), provided they know the appropriate password.
|-
| <tt>portage</tt> || Members of this group can perform <tt>emerge --pretend</tt> operations, and access <tt>portage</tt> log files.
|-
| <tt>lpadmin</tt> || Members of this group can administer printers attached to the system.
|-
| <tt>lp</tt> || Members of this group can use printers attached to the system (important for Bluetooth printers too).<ref>ArchLinux Wiki: [https://wiki.archlinux.org/index.php/bluetooth#Installation "Bluetooth: Installation"]</ref>
|}
|-
| <tt>--shell</tt> || <tt>-s</tt> || Specify the user's login shell. We've used [[:Wikipedia:Bash_(Unix_shell){{!}}bash]] here, as it is the default shell in Gentoo Linux.
|-
| <tt>--comment</tt> || <tt>-c</tt> || A short description of the login; most commonly the user's full name (such as "John Doe").
|}
{{Note|With the move to <tt>systemd</tt>, many of the old hardware-access groups (such as <tt>disk</tt>, <tt>network</tt>, <tt>audio</tt>, <tt>lp</tt> etc.) are no longer necessary, and may even cause problems if you add yourself to them. Other 'traditional' groups such as <tt>adm</tt> have no effect on modern systems.<ref>ArchLinux Wiki: [https://wiki.archlinux.org/index.php/Sysvinit#Supplementary_information "Migration to systemd: Supplementary Information"]</ref>}}
{{Note|There are a number of other software groups that you may wish to add your user(s) to over time, as and when you emerge the specific packages. For example, if you use [[VirtualBox{{!}}VirtualBox]], you'd need to add your user to the <tt>vboxusers</tt> group. [https://wiki.archlinux.org/index.php/users_and_groups#Software_groups This wiki entry] has a useful list of this type of group (and instructions for how to add and remove users from a group).}}

== <span id="install_x11">Installing X11</span> ==

As we'll be using X11<ref name="x11_guide">Wikibooks: [https://en.wikibooks.org/wiki/Guide_to_X11 ''Guide to X11'']</ref> as the underlying graphical platform for GNOME, we'll install it next.

We need to set a few USE flags for {{Package|media-libs/mesa}} (an OpenGL-like library which X pulls in as a dependency), and while we're at it, set a few others that we'll need shortly for GNOME, so issue:

{{RootCmd
|nano -w /etc/portage/package.use
|prompt=koneko <span style{{=}}"color:royalblue;">~ #</span>
}}
and ''append'':
{{FileBox|filename=/etc/portage/package.use|title=Append the following per-package use flags|1=
# required by standard X-server installation
>=media-libs/mesa-9.1.6                 xa gbm
# required by Gnome 3.14
>=media-libs/mesa-9.1.6                 gles2
>=media-libs/cogl-1.18.2                gles2
>=media-libs/clutter-1.20.0             egl
}}
Save and exit <tt>nano</tt>.

Here are what those flags do (you may also find this [http://www.linuxfromscratch.org/blfs/view/cvs/x/mesalib.html ''Linux from Scratch'' page] useful):

{| class="wikitable"
|-
! Package !! Use flag !! Description
|-
| rowspan=3|{{Package|media-libs/mesa}} || <tt>xa</tt> || This enables the XA (X Acceleration) API for [[:Wikipedia:Gallium3D{{!}}Gallium3D]] (a device driver framework for 3D graphics chipsets).
|-
| <tt>gbm</tt> || This enables support for the Graphics Buffer Manager for [[:Wikipedia:EGL_(API){{!}}EGL]] on kernel mode setting.
|-
| <tt>gles2</tt> || This enables [[:Wikipedia:OpenGL_ES|OpenGL for Embedded Systems]] (version 2) support.
|-
| {{Package|media-libs/cogl}} || <tt>gles2</tt> || Ditto.
|-
| {{Package|media-libs/clutter}} || <tt>egl</tt> || Enables the [[:Wikipedia:EGL_(API){{!}}EGL]] backend.
|}

As [[../Building_the_Gentoo_Base_System_Minus_Kernel#second_virtual_console|before]], since some of the next steps will involve lengthy emerges, we'll use <tt>screen</tt>, and <span id="another_second_console">setup a second virtual console</span>, which will be let us monitor progress using <tt>showem</tt>. Issue:
{{RootCmd
|screen
|export PS1{{=}}"(1) $PS1"
|prompt=koneko <span style{{=}}"color:royalblue;">~ #</span>
}}
to start <tt>screen</tt>. Then, press {{Key|Ctrl}}{{Key|a}} then {{Key|c}} to start a new virtual console, and in that new console enter:
{{RootCmd
|export PS1{{=}}"(2) $PS1"
|prompt=koneko <span style{{=}}"color:royalblue;">~ #</span>
}}
Now hit {{Key|Ctrl}}{{Key|a}} then {{Key|p}} to get back to the original console.

Now, since you have already set up the necessary [[../Installing_the_Gentoo_Stage_3_Files#video_cards_variable|<tt>VIDEO_CARDS</tt>]] and [[../Installing_the_Gentoo_Stage_3_Files#input_devices_variable|<tt>INPUT_DEVICES</tt>]] variables in {{Path|/etc/portage/make.conf}} [[../Installing_the_Gentoo_Stage_3_Files#setup_make_conf|earlier]], we can now proceed to install the X-server itself. Issue:
{{RootCmd
|emerge --ask --verbose --oneshot x11-base/xorg-server
|prompt=<span style{{=}}"color:gray;">(1)</span> koneko <span style{{=}}"color:royalblue;">~ #</span>
|output=<pre>
... additional output suppressed ...
Would you like to merge these packages? [Yes/No] <press y, then press Enter>
... additional output suppressed ...
</pre>
}}
and the X11 server will be downloaded and installed. Note that we use <tt>--oneshot</tt> here to avoid adding it to your [[World|@world]] set (this is slightly cleaner, as it will become a dependency of GNOME, once it is installed later).
{{Note|Just as [[../Building_the_Gentoo_Base_System_Minus_Kernel#use_showem|before]], you can temporarily switch to the second console to watch the progress with <tt>showem</tt>, if you like. Use {{Key|Ctrl}}{{Key|a}} then {{Key|n}} to switch to the second console, and {{Key|Ctrl}}{{Key|a}} then {{Key|p}} to return back when done.}}

== <span id="temp_install_twm">Temporarily Installing an X11 Window Manager and Applications</span> ==

To be <span id="install_x_test_apps">able to test</span> out X11, we'll need to install a [[:Wikipedia:Window_manager|window manager]], and a few X11 applications.

To keep things simple here, we'll use the (minimalist) [[:Wikipedia:Twm|Tab Window Manager (TWM)]] ({{Package|x11-wm/twm}}), and the following apps:
* {{Package|x11-apps/xsetroot}}: a background ('root') window parameter setting utility for X;
* {{Package|x11-apps/xclock}}: a simple clock display for X; and
* {{Package|x11-terms/xterm}}: the standard terminal emulator for X.

Issue:
{{RootCmd
|emerge --ask --verbose x11-wm/twm x11-terms/xterm x11-apps/xclock x11-apps/xsetroot
|prompt=<span style{{=}}"color:gray;">(1)</span> koneko <span style{{=}}"color:royalblue;">~ #</span>
|output=<pre>
... additional output suppressed ...
Would you like to merge these packages? [Yes/No] <press y, then press Enter>
... additional output suppressed ...
</pre>
}}
These are small programs, and shouldn't take long to download, compile or install.

Next, we need to tell X11 what window manager and apps to use whenever it starts up. The <tt>.xinitrc</tt> file is used for this purpose. Also, as it's generally not a great idea to run an X server as root, we'll invoke it as the regular user [[#add_regular_user|we've just created]]. Still via <tt>ssh</tt>/<tt>screen</tt> console, issue:
{{RootCmd
|su --login sakaki
|prompt=<span style{{=}}"color:gray;">(1)</span> koneko <span style{{=}}"color:royalblue;">~ #</span>
}}
{{Note|Substitute the user name of the regular user you created in the [[#add_regular_user{{!}}earlier step]] for <tt>sakaki</tt> in the above command.}}

{{Note|The <tt>su</tt> command, when invoked with <tt>--login</tt> (as here) provides a console environment similar to that which the specified user would have if s/he had logged in directly. When issued by the superuser (<tt>root</tt>), as here, no password is required.}}

Next, edit the <tt>.xinitrc</tt> file in the regular user's home directory. Issue:
{{Cmd
|nano -w ~/.xinitrc
|prompt=sakaki@koneko <span style{{=}}"color:royalblue;">~ $</span>
}}
{{Note|Obviously, the name that you see in the prompt will reflect that of the regular user you added (and which you just <tt>su</tt>-d to).}}
Put the following text in the <tt>.xinitrc</tt>:
{{FileBox|filename=~/.xinitrc|title=A basic setup to start TWM and some simple applications|lang=bash|1=
#!/bin/sh
twm &
xsetroot -solid CornflowerBlue &
xclock -geometry 100x100-1+1 &
xterm -geometry 80x50+494+51 &
xterm -geometry 80x20+494-0 &
exec xterm -geometry 80x66+0+0 -name login
}}
Save and exit <tt>nano</tt>. 

The above shell script simply instructs X to:
* start the Tab Window Manager (<tt>twm</tt>) as a [[:Wikipedia:Background_process|background process]];
* set the background [[:Wikipedia:X11_color_names#Color_name_charts|colour]] to "CornflowerBlue" (also backgrounded, but will exit quickly);
* show an analogue clock, of size 100x100 pixels, offset 1 pixel from the right side of the screen and 1 pixel from the top (as a background process);
* show a terminal, of size 80x50 ''characters'', offset 494 ''pixels'' from the left side of the screen and 51 pixels from the top (as a background process);
* show a second terminal, of size 80x20 characters, offset 494 pixels from the left side of the screen and 0 pixels from the bottom; and
* then execute a third terminal, of size 80x66 characters, offset 0 pixels from the left, top corner of the screen ([[:Wikipedia:Exec_(computing)|replacing]] the calling process). This terminal has name 'login' and, when terminated, the X session will close.

<span id="first_try_startx">Now we are ready to try it out!</span>

Still on the <tt>ssh</tt>/<tt>screen</tt> console, issue:

{{Cmd
|startx
|prompt=sakaki@koneko <span style{{=}}"color:royalblue;">~ $</span>
}}

If all goes well, the screen of your target PC should now be displaying something like the below:
[[File:Twm_screen.png|thumb|none|400px|Simple X11/TWM Desktop and Applications]]
(If you get an error instead, see the following section [[#if_x11_fails|"Troubleshooting a Failed X11 Startup"]]. Any problems are most likely due to a missing kernel graphics driver, which is easy to fix, so don't panic!)

Check that you can move the cursor around (using the target machine's mouse or touchpad), and try typing some simple commands (e.g. "<tt>ls /bin</tt>") into any of the three terminal windows. When done, move your cursor into the longest (leftmost) terminal, so that it receives the focus (its cursor will switch to a filled rectangle), and type (directly at the target machine's keyboard):
{{Cmd
|exit
|prompt=sakaki@koneko <span style{{=}}"color:royalblue;">~ $</span>
}}
On the <tt>ssh</tt>/<tt>screen</tt> console (at your helper PC), you should now see that the <tt>startx</tt> program has exited (and a lot of status output will have been written to the console too).
{{Note|If you have problems, the X server can always be closed from the <tt>ssh</tt> window, by typing {{Key|Ctrl}}{{Key|c}}.}}

If you were able to carry out this test, then congratulations, GNOME 3 should be able to work fine on your system. [[#install_gnome3|Jump over the troubleshooting section]] and install it.

If, however, X failed to start up properly, continue reading.

=== <span id="if_x11_fails">Troubleshooting a Failed X11 Startup</span> ===

{{Note|This troubleshooting section is necessary ''only'' if you had problems starting X11. To reiterate: if the above X11 test worked for you, then you should just skip to [[#install_gnome3{{!}}the next section]] now.}}

By far the most likely problem you will encounter with X is a missing graphics driver. Actually, if you've been following this tutorial, and have a reasonably modern machine, then it'll ''likely'' have happened to you. That's because the Gentoo minimal install image kernel (on which your current kernel's configuration has been [[../Configuring_and_Building_the_Kernel#kernel_opts_set_by_buildkernel|based]]) does not have many graphics device drivers configured (either built into the kernel, or as modules) - in order to keep the size of the image small.

Two drivers that are conspicuous by their absence from the minimal install kernel configuration are:
* the <tt>DRM_I915</tt> driver; this is needed for the integrated [[:Wikipedia:Intel_HD_and_Iris_Graphics|"HD Graphics"]] on many [[:Wikipedia:Ultrabook|Ultrabooks]] (such as the Panasonic CF-AX3);
*the <tt>DRM_NOUVEAU</tt> driver; this is an open-source driver that [[:Wikipedia:Nouveau_(software)|supports]] many nVidea graphics cards (which are popular on desktop machines).

The easiest way to see if you have had a problem like this is to look at the output from your attempt to run <tt>startx</tt> (the output in the <tt>ssh</tt>/<tt>screen</tt> virtual terminal, that is, not on your target machine's display). 

If you see output such as:
{{GenericCmd|<pre>
... additional output suppressed ...
modprobe: FATAL: Module i915 not found.
... additional output suppressed ...
</pre>
}}
then you know that you have a driver problem. In this case, it is complaining about the <tt>i915</tt> driver module (dynamic library).

To rectify this, we need to <span id="make_menuconfig_intro">turn on the appropriate drivers</span> and rebuild our kernel. Ensure that the USB boot key is inserted into the target machine, and issue (from the <tt>ssh</tt>/<tt>screen</tt> virtual terminal):
{{Cmd
|exit
|prompt=sakaki@koneko <span style{{=}}"color:royalblue;">~ $</span>
}}
to drop back to the <tt>root</tt> user.
{{Note|You may also find the content of the {{Path|/var/log/Xorg.0.log}} log file useful. Additionally, entering (as root):
{{RootCmd
|lspci {{!}} grep -i VGA
|prompt=<span style{{=}}"color:gray;">(1)</span> koneko <span style{{=}}"color:royalblue;">~ #</span>
}}
and
{{RootCmd
|hwinfo --gfxcard
|prompt=<span style{{=}}"color:gray;">(1)</span> koneko <span style{{=}}"color:royalblue;">~ #</span>
}}
can provide more information about your graphics card. Unfortunately, as of the time of writing, there is no reliable program which will query your hardware and generate an appropriate kernel configuration automatically.}}

Then:
{{RootCmd
|buildkernel --menuconfig
|prompt=<span style{{=}}"color:gray;">(1)</span> koneko <span style{{=}}"color:royalblue;">~ #</span>
}}
to start the kernel rebuild process going. Because you have not specified <tt>--ask</tt> here, but you ''have'' specified <tt>--menuconfig</tt>, the process will run through by itself (assuming no errors) to the point where you can modify the kernel configuration using the standard <tt>curses</tt>-based editor GUI.

The configuration changes you need to make will vary depending on the driver(s) you need to enable. The following is a step-by-step guide for modern laptops (and other PCs) with Intel integrated HD graphics (following [[Intel|this wiki page]]). If you require a different driver, modify these instructions accordingly.

The <tt>menuconfig</tt> system is a simple tool used to modify Linux kernel configurations (aka "<tt>.config</tt>" files) in a coherent manner. The tool will not let you make inconsistent choices, and has a useful search facility.

{{Note|For more information on <tt>menuconfig</tt>, refer to Chapter 4 of Greg Kroah-Hartman's ''Linux Kernel in a Nutshell''<ref name{{=}}"kernel_in_nutshell">Kroah-Hartman, Greg. [http://www.kroah.com/lkn/ ''Linux Kernel in a Nutshell'' (ebook)]. O'Reilly, 2006</ref>, the Gentoo [[Kernel/Configuration{{!}}wiki page]], and Bruce Dubbs' "Considerations when configuring the Linux kernel" from ''Linux from Scratch''<ref>Dubbs, Bruce. [http://www.linuxfromscratch.org/hints/downloads/files/kernel-configuration.txt "Considerations when configuring the Linux kernel"]. 28 May 2009, Linux from Scratch.</ref>.}}

When <tt>menuconfig</tt> starts up, it will present you with a display similar to the below (your version may vary depending on currently selected options and kernel version):
[[File:Menuconfig_1.png|thumb|none|400px|Initial Display of make menuconfig Application]]

You can navigate the interface as follows:
* Use the up and down arrow keys to move your selection (highlighted in blue) in the top pane;
* Use the left and right arrow keys to traverse the bottom (horizontal) menu, which defines what happens when you press {{Key|Enter}}, viz.:
** <Select> enters a sub-menu, for items (in the top pane) ending with <tt>---></tt>, or brings up a text entry box for items which start with round brackets "<tt>()</tt>";
** <Exit> exits a sub-menu; if at the top level already, asks you whether to save changes (if you have made any) and exits the program; you can also press {{Key|Esc}} then {{Key|Esc}} to perform this action;
** <Help> shows a help screen that is relevant to the (top pane) selection; you can also press {{Key|h}} for this;
** <Save> saves the current configuration; and
** <Load> allows you to load a new configuration.

Items starting with non-round brackets represent features which can be enabled, as follows:
; <tt>[ ]</tt>, <tt>[*]</tt> : Square brackets indicate features that are deactivated (blank) or activated (asterisk). Press {{Key|Space}} to toggle status, or {{Key|y}} to activate, {{Key|n}} to deactivate. Activated items are built directly into the kernel; deactivated items are omitted from it entirely.
; <tt>< ></tt>, <tt><M></tt>, <tt><*></tt> : Angle bracketed items can similarly be deactivated (blank) or activated (asterisk), but can additionally be built as ''modules'' ("<tt>M</tt>"). In addition to {{Key|Space}}, {{Key|y}} and {{Key|n}}, you can use {{Key|m}} with such items to specify that they should be modularized.
; <tt>{M}</tt>, <tt>{*}</tt> : Curly brackets indicate items which ''cannot'' be deactivated (due to another item's dependency). However, they may be activated or modularized (using {{Key|y}}, {{Key|m}} or {{Key|Space}}, as before).
; <tt>-M-</tt>, <tt>-*-</tt> : Similarly, hyphens indicate items whose status ''cannot'' be changed (their selection having been forced as the result of another item choice).

{{Note|At times, you may find that certain choices are impossible, despite the bracket coding, because of other choices you have made. For example, you may not be able to activate an element, only modularize it, if one of its dependencies is modularized (rather than selected). In such cases, <tt>menuconfig</tt> will tell you that your choice is restricted, and why.}}

To search, press {{Key|/}} and then type your search term. This is a very useful facility when looking for missing drivers etc. For example, since we are here looking for the missing <tt>i915</tt> module, press {{Key|/}} then type in <tt>i915</tt>, then press {{Key|Enter}} to see the search results:
{|style="background:transparent; color:black" 
|[[File:Menuconfig_2.png|thumb|none|400px|Searching for a Missing Driver...]]
|[[File:Menuconfig_3.png|thumb|none|400px|...And Reviewing the Results]]
|}

{{Note|As mentioned, the following assumes you are adding the necessary Intel <tt>DRM_I915</tt> driver. If your setup requires a different driver, for example <tt>DRM_NOUVEAU</tt> (for nVidia cards), you will need to modify these instructions accordingly.}}

You can scroll through the results using the arrow keys. Doing so in this case, we discover that (''inter alia''):
* Four items are returned, of which the first two (<tt>DRM_I915</tt> and <tt>DRM_I915_KMS</tt>) are relevant;
* The output shows that (e.g.) the <tt>DRM_I915</tt> item (which will appear in the {{Path|/usr/src/linux/.config}} file as <tt>CONFIG_DRM_I915</tt>) is to be found in the <tt>Graphics support</tt> submenu under the <tt>Device drivers</tt> submenu. We also see that its prompt in the upper-pane menu will (as is common with this software!) will be distinct from the <tt>DRM_I915</tt> name (it will actually appear as "<tt>Intel 8xx/9xx/G3x/G4x/HD Graphics</tt>").
* The dependencies of this driver are also shown (you can drag the <tt>ssh</tt> terminal window on your helper machine wider to see any that may have been clipped off). Generally, for an item to be available for selection or modularization, ''all'' its dependencies must be satisfied: either selected (<tt>=y</tt>, the same as an asterisk) or modularized (<tt>=m</tt>). In some cases, items whose dependencies are unsatisfied will not be visible other than through a search like this.

This last point bears repeating, since it confuses many first-time users: {{Highlight|an item will often not even appear in <tt>menuconfig</tt>'s top pane until its dependencies have been satisfied}}. It would be nice if <tt>menuconfig</tt> would allow us to activate/modularize "an item and all its dependencies, transitively" from the search results screen, but it currently cannot, so we must perform this depth-first recursion manually.

OK, so let's work through the <tt>DRM_I915</tt> case as a concrete example. From the search just performed we can see that, of the requirements for <tt>DRM_1915</tt>, the {{Highlight|<tt>DRM</tt>}} and {{Highlight|<tt>AGP_INTEL</tt>}} items are currently deselected. Well then, let's recursively investigate <tt>DRM</tt>: we hit {{Key|Enter}} to exit current search, then {{Key|/}} to search again, and type in <tt>DRM</tt> and press {{Key|Enter}}. The item we want here is the first result term. All its dependencies appear satisfied in the current configuration, and we note also that it appears under "<tt>Device Drivers -> Graphics support</tt>", and that its prompt is "<tt>Direct Rendering Manager (XFree86 4.1.0 and higher DRI support)</tt>". Next, let's recurse into <tt>AGP_INTEL</tt>. Press {{Key|Enter}} to exit the current search, then {{Key|/}} to search again, and type in <tt>AGP_INTEL</tt> and press {{Key|Enter}}. Just one result this time, and again, all dependencies appear currently satisfied. Here, the location is "<tt>Device Drivers -> Graphics support -> /dev/agpgart (AGP Support)</tt>", and it will appear in the menu as "<tt>Intel 440LX/BX/GX, I8xx and E7x05 chipset support</tt>":

{|style="background:transparent; color:black" 
|[[File:Menuconfig_40.png|thumb|none|400px|Search Results for DRM (Dependency)...]]
|[[File:Menuconfig_41.png|thumb|none|400px|...And for AGP_INTEL (Dependency)]]
|}

Now we know there are no further unsatisfied dependencies for <tt>DRM_I915</tt>, we can activate those we've discovered. We'll start with <tt>AGP_INTEL</tt>. Press {{Key|Enter}} to exit the current search, then use the arrow keys to navigate to the "<tt>Device Drivers</tt>" item (if not visible to begin with, the top pane will scroll as you arrow down), then press {{Key|Enter}} to enter the submenu. Next, repeat the process to select the "<tt>Graphics support</tt>" item, and press {{Key|Enter}}:

{|style="background:transparent; color:black" 
|[[File:Menuconfig_4.png|thumb|none|400px|Select Device Drivers menu...]]
|[[File:Menuconfig_5.png|thumb|none|400px|...Then Graphics support Submenu]]
|}

Now, select the "<tt>/dev/agpgart (AGP Support)</tt>" item, and press {{Key|Enter}} to enter the submenu. Move down to the line starting "Intel 400LX/BX/GX", and press {{Key|y}} to enable it, as shown:

{|style="background:transparent; color:black" 
|[[File:Menuconfig_6.png|thumb|none|400px|Select AGP Support Submenu...]]
|[[File:Menuconfig_16.png|thumb|none|400px|...Then Enable AGP_INTEL]]
|}

{{Note|If you are unsure of an item, you can press {{Key|?}} when it is highlighted; this will show its help information, including symbol name (in this case, <tt>AGP_INTEL</tt>). The mapping from item text (shown in the search results "<tt>Prompt:</tt>" field) to symbol name (shown in the search results "<tt>Symbol:</tt>" field) isn't always obvious!

One other point to bear in mind is that any symbol, for example <tt>DRM_I915</tt>, will have a <tt>CONFIG_</tt> prefix attached when written out to a <tt>.config</tt> file. You will occasionally see these <tt>CONFIG_</tt> prefixes appear in the help text too (in point of fact, the help for <tt>DRM_I915</tt> refers to it as <tt>CONFIG_DRM_I915</tt>). However, don't be confused: <tt>CONFIG_DRM_I915</tt> is ''the same as'' <tt>DRM_I915</tt>.

Press {{Key|Enter}} when you are finished reading the help, to close it and go back.}}

{{Note|We're taking the approach of selecting required components directly (requesting they be built into the kernel itself), rather than modularizing them, but this is generally not mandatory. <tt>buildkernel</tt> copies all modules into the initramfs, so whether or not to modularize is ultimately up to you - it will have no effect on your ability to boot (certainly for elements like this that were disabled in the minimal install configuration to begin with).}}

Now <tt>AGP_INTEL</tt> is set, we can proceed to enable <tt>DRM_I915</tt>'s other unmet dependency, <tt>DRM</tt>. Press {{Key|Esc}} then {{Key|Esc}} to come back out one menu level (back to "<tt>Graphics support</tt>"), then select the line starting "<tt>Direct Rendering Manager</tt>" (remember, if you are unsure this is the item whose symbol is <tt>DRM</tt>, you can always check it first, by pressing {{Key|?}} when highlighted). Press {{Key|y}} to enable it. This unlocks a set of subitems, which now appear:

{|style="background:transparent; color:black" 
|[[File:Menuconfig_30.png|thumb|none|400px|Selecting Direct Rendering Manager (DRM)...]]
|[[File:Menuconfig_31.png|thumb|none|400px|...Causes a Set of Subitems to Appear]]
|}

One of these is what we're after - move down until the line starting "<tt>Intel 8xx/9xx/G3x/G4x/HD Graphics</tt>" is highlighted (this is in fact our original target, the <tt>DRM_I915</tt> item, which you can verify using {{Key|?}} if you like), then press {{Key|y}} to enable it. Doing so causes ''yet more'' items to appear (feels rather like a 70's era [[:Wikipedia:Adventure_game#Gathering_and_using_items|adventure game]]!):
{|style="background:transparent; color:black" 
|[[File:Menuconfig_32.png|thumb|none|400px|Selecting HD Graphics Driver (DRM_I915)...]]
|[[File:Menuconfig_33.png|thumb|none|400px|...Causes a Set of Subitems to Appear]]
|}

The first of these is <tt>DRM_I915_KMS</tt>, which is also necessary for X11 to start correctly. Move to it, and select it by pressing {{Key|y}}:
[[File:Menuconfig_35.png|thumb|none|400px|Enabling Kernel Modesetting (DRM_I915_KMS)]]

And that's it, you're done. Hit {{Key|Esc}} then {{Key|Esc}} to come back out to the "<tt>Device Drivers</tt>" menu. Hit {{Key|Esc}} then {{Key|Esc}} again to come back out to the top-level menu. Finally, hit {{Key|Esc}} then {{Key|Esc}} again, to exit the program. When prompted, ensure <tt><Yes></tt> is selected, and press {{Key|Enter}} to save the new configuration and quit <tt>menuconfig</tt>:
[[File:Menuconfig_17.png|thumb|none|400px|Saving New Configuration and Exiting]]

{{Note|<span id{{=}}"kernel_config_shorthand_note">It's useful to</span> relate the process just described to the 'kernel configuration shorthand' you will often see on the Gentoo wiki, and many other places on the web. For example, looking at the [[Intel{{!}}"intel"]] page on the wiki, we read that you need to enable the following kernel options:
{{KernelBox|<pre>
Processor type and features  --->
    [*] MTRR (Memory Type Range Register) support
Device Drivers  --->
    Graphics support  --->
        <*> /dev/agpgart (AGP Support)  --->
             <*> Intel 440LX/BX/GX, I8xx and E7x05 chipset support
        <*> Direct Rendering Manager (XFree86 4.1.0 and higher DRI support) --->
            <*> Intel 8xx/9xx/G3x/G4x/HD Graphics
            [*]   Enable modesetting on intel by default
</pre>}}
This is really just informing you of the menu locations (and prompts) of the options you need to choose, and how to set them (here, all have asterisks, so implying you should ideally select, rather than modularize). All of the above should be familiar from the process just described, with the exception of "<tt>MTRR (Memory Type Range Register) Support</tt>" (symbol "<tt>MTRR</tt>"); this we didn't look at (as it is now force-selected by default on the current Gentoo minimal install kernel configuration).

Generally speaking, when presented with a configuration list like this, you can just work through the menus in the order provided and enable the items - the author will have done the 'depth first' dependency pass for you. However, this isn't foolproof, so if an item referred to in such a list appears missing, simply search for it, and check that its dependencies are set, as we have done above.

Remember also that symbols do get dropped from (and obviously, added to) the kernel configuration set over time, so if you are working from an old set of instructions, a specified item may have been obsoleted and removed. Do an internet search if unsure.

There's some further information about the kernel configuration shorthand notation on the [[Kernel/Gentoo_Kernel_Configuration_Guide#Kernel_configuration_shorthand_notation{{!}}Gentoo wiki]].

In the later part of this tutorial, I will assume that you are able to translate these 'shorthand' kernel configuration recipes, using <tt>buildkernel --menuconfig</tt>, without spelling out the process step-by-step. If in doubt, please re-read this section. (And if you are reading this now because you were jumped back to this section from a later chapter, you can [[../Final_Configuration_Steps#resume_after_menuconfig_tutorial{{!}}click here]] to return - otherwise, just continue reading!)
}}

Once you have exited <tt>menuconfig</tt>, <tt>buildkernel</tt> will automatically create a kernel with the newly created configuration, sign it, and copy it over to the boot USB key. Wait for the process to complete (you get the message "<tt>All done!</tt>"). Then issue:

{{RootCmd
|exit
|prompt=<span style{{=}}"color:gray;">(1)</span> koneko <span style{{=}}"color:royalblue;">~ #</span>
}}
which will close the first <tt>screen</tt> terminal, then:

{{RootCmd
|exit
|prompt=<span style{{=}}"color:gray;">(2)</span> koneko <span style{{=}}"color:royalblue;">~ #</span>
}}
to close the second one. Then, ensure the boot USB key is still inserted in the target machine and restart it, by issuing:
{{RootCmd
|systemctl reboot
|prompt=koneko <span style{{=}}"color:royalblue;">~ #</span>
}}
{{Note|If you have problems rebooting with this new kernel, you can follow the instructions [[../Configuring_systemd_and_Installing_Necessary_Tools#revert_to_previous_kernel{{!}}given earlier]] to revert back to the backup (previous) version on the boot USB key - which won't have your configuration changes - and try again.}}

When the machine restarts, as before, you will need to enter your LUKS keyfile <tt>gpg</tt> passphrase (the one you created [[../Preparing_the_LUKS-LVM_Filesystem_and_Boot_USB_Key#create_gpg_luks_keyfile|earlier]]), directly at the target machine keyboard.

Once this has been completed successfully, and the target machine is restarted, from the helper PC, log back in again via <tt>ssh</tt>:

{{Cmd
|ssh root@192.168.1.106
|prompt=user@pc2 $
|output=<pre>
Password: <enter root password>
... additional output suppressed ...
</pre>}}
{{Note|Substitute whatever IP address you got back from <tt>ifconfig</tt> [[../Configuring_systemd_and_Installing_Necessary_Tools#post_reboot_ip{{!}}earlier]] for 192.168.1.106 in the above command. It is possible (although unlikely, with modern DHCP) that the target's IP address will have changed during the reboot. If so, log in directly at the target machine's keyboard, use <tt>ifconfig</tt> to find out the new address, then issue the above <tt>ssh</tt> command citing that address. As before, in such a case you may need to clean out any previous record of <tt>ssh</tt> connections to (other machines at) that new address (since the fingerprints will not match), using:
{{Cmd
|sed -i '/^[^[:digit:]]*192.168.1.106[^[:digit:]]/d' ~/.ssh/known_hosts
|prompt=user@pc2 $}}
obviously substituting the new address for <tt>192.168.1.106</tt> in the above. Then, be sure to check the fingerprint when prompted (by the subsequent <tt>ssh</tt> command), against those you noted down [[../Configuring_systemd_and_Installing_Necessary_Tools#note_new_fingerprints{{!}}earlier]].
}}
{{Note|If installing over WiFi, and you had to manually restart <tt>wpa_supplicant</tt> in the [[../Configuring_systemd_and_Installing_Necessary_Tools#manually_start_wpa_supplicant_systemd{{!}}previous two chapters]], then you'll need to do so again here (directly at the target machine's keyboard) before you'll be able to <tt>ssh</tt> in.}}

Then, re-establish <tt>screen</tt> (enter all commands via the <tt>ssh</tt> console from the helper PC, unless otherwise stated). Issue:
{{RootCmd
|screen
|export PS1{{=}}"(1) $PS1"
|prompt=koneko <span style{{=}}"color:royalblue;">~ #</span>
}}
to start <tt>screen</tt>. Then, press {{Key|Ctrl}}{{Key|a}} then {{Key|c}} to start a new virtual console, and in that new console enter:
{{RootCmd
|export PS1{{=}}"(2) $PS1"
|prompt=koneko <span style{{=}}"color:royalblue;">~ #</span>
}}
Now hit {{Key|Ctrl}}{{Key|a}} then {{Key|p}} to get back to the original console.
Log back in as your regular user:
{{RootCmd
|su --login sakaki
|prompt=<span style{{=}}"color:gray;">(1)</span> koneko <span style{{=}}"color:royalblue;">~ #</span>
}}
{{Note|Substitute the user name of the regular user you created in the [[#add_regular_user{{!}}earlier step]] for <tt>sakaki</tt> in the above command.}}

And now rejoin the tutorial from the [[#first_try_startx|point where you attempted to run <tt>startx</tt>, above]]. Hopefully, all should be well this time. Good luck!

{{Note|If you are using the i915 driver, you may find that you cannot change the screen brightness, and that the screen appears dim. This issue is addressed [[../Final_Configuration_Steps#LCD_Screen_Backlight_.28Addressing_the_i915_Regression.29{{!}}later]] in the tutorial.}}

{{Note|If you still have problems, the Gentoo wiki page on [[Xorg/Configuration{{!}}X11 configuration]] may contain some useful pointers. With a modern X setup however, problems are almost always as a result of incorrect kernel configuration (or possibly incorrect [[../Installing_the_Gentoo_Stage_3_Files#video_cards_variable{{!}}<tt>VIDEO_CARDS</tt>]] or [[../Installing_the_Gentoo_Stage_3_Files#input_devices_variable{{!}}<tt>INPUT_DEVICES</tt>]] variables in {{Path|/etc/portage/make.conf}}), rather than incorrect X configuration.}}

== <span id="install_gnome3">Installing GNOME 3</span> ==

Now that we know X works, we can install GNOME! Let's begin by removing the temporary X window manager and applications (which we installed, for testing purposes only, [[#install_x_test_apps|earlier]]).

Issue (from the helper PC <tt>ssh</tt>/<tt>screen</tt> terminal):
{{Cmd
|exit
|prompt=sakaki@koneko <span style{{=}}"color:royalblue;">~ $</span>
}}
to get back to the <tt>root</tt> user, then:
{{RootCmd
|emerge --ask --verbose --depclean x11-wm/twm x11-terms/xterm x11-apps/xclock x11-apps/xsetroot
|output=<pre>
... additional output suppressed ...
Would you like to unmerge these packages? [Yes/No] <press y, then press Enter>
... additional output suppressed ...
</pre>
|prompt=<span style{{=}}"color:gray;">(1)</span> koneko <span style{{=}}"color:royalblue;">~ #</span>
}}

{{Note|Using the <tt>--depclean</tt> option to <tt>emerge</tt> in this way is a common idiom to safely uninstall packages in Gentoo. If any of the specified [[../Installing_the_Gentoo_Stage_3_Files#atoms_etc{{!}}atoms]] happens to be a dependency of another installed package (even transitively), it will not be removed.}}

Now for GNOME itself. There are two minor license exceptions (to our license group (<tt>@FREE</tt>), which we set [[../Installing_the_Gentoo_Stage_3_Files#set_license|earlier]]), that we'll need to allow for GNOME. These are benign (the license in question, "<tt>CC-Sampling-Plus-1.0</tt>" is essentially a free-use license, but is not currently included in <tt>@FREE</tt>; it may be viewed at {{Path|/usr/portage/licenses/CC-Sampling-Plus-1.0}}). Issue:
{{RootCmd
|nano -w /etc/portage/package.license
|prompt=<span style{{=}}"color:gray;">(1)</span> koneko <span style{{=}}"color:royalblue;">~ #</span>
}}
Then ''append'':
{{FileBox|filename=/etc/portage/package.license|title=Append the following acceptable case-by-case licenses|1=
# fairly harmless licenses required for GNOME
>=x11-themes/gnome-icon-theme-3.10.0 CC-Sampling-Plus-1.0
>=gnome-base/gdm-3.10.0.1 CC-Sampling-Plus-1.0
>=x11-themes/adwaita-icon-theme-3.14.1 CC-Sampling-Plus-1.0
}}
Save and exit the <tt>nano</tt> editor.

As of the time of writing, there is a circular dependency which will prevent the installation of GNOME 3. To solve this, issue:<ref>Gentoo Forums: [https://forums.gentoo.org/viewtopic-p-7557156.html#7556668 "emerge gnome won't compile"]</ref>
{{RootCmd
|USE{{=}}"-gnome" emerge --ask --verbose --oneshot virtual/notification-daemon
|prompt=<span style{{=}}"color:gray;">(1)</span> koneko <span style{{=}}"color:royalblue;">~ #</span>
|output=<pre>
... additional output suppressed ...
Would you like to merge these packages? [Yes/No] <press y, then press Enter>
... additional output suppressed ...
</pre>
}}
The {{Package|virtual/notification-daemon}} package will be replaced by one with the correct USE flag set in the next step; we have used the <tt>--oneshot</tt> option in the above to prevent it being recorded in your [[World|<tt>@world</tt>]] set.

{{Note|If you were to omit the above step, <tt>emerge</tt> will give you a helpful error message telling you that there is a problem, and that the above is what you need to do to resolve it, when you attempt to emerge {{Package|gnome-base/gnome}}, next.}}

Now we are ready to install GNOME! Issue:
{{RootCmd
|emerge --ask --verbose --keep-going gnome-base/gnome
|prompt=<span style{{=}}"color:gray;">(1)</span> koneko <span style{{=}}"color:royalblue;">~ #</span>
|output=<pre>
... additional output suppressed ...
Would you like to merge these packages? [Yes/No] <press y, then press Enter>
... additional output suppressed ...
</pre>
}}

{{Note|
As [[../Building_the_Gentoo_Base_System_Minus_Kernel#use_showem{{!}}before]], you can switch to the second <tt>screen</tt> console we prepared [[#another_second_console{{!}}earlier]], to watch the progress (as the files download, build etc.). Hit {{Key|Ctrl}}{{Key|a}} then {{Key|n}} to switch to the second console (you can do this while the <tt>emerge</tt> is running), and issue:
{{RootCmd
|showem
|prompt=<span style{{=}}"color:gray;">(2)</span> koneko <span style{{=}}"color:royalblue;">~ #</span>
}}

You can now switch back and forward between the two windows as you like (using {{Key|Ctrl}}{{Key|a}} then {{Key|n}} to cycle forwards, and {{Key|Ctrl}}{{Key|a}} then {{Key|p}} to cycle backwards - identical in function here where we only have two windows active), which should give you a good overview of the emerge process as it progresses. You can exit the <tt>showem</tt> program at any time by issuing {{Key|Ctrl}}{{Key|c}}.
}}

The <tt>emerge</tt> will take quite some time to complete! Note that the <tt>--keep-going</tt> option instructs <tt>emerge</tt> to build as much as possible, even if some errors are encountered. This is useful here because, due to the size of the build, it is possible that you may come across one or two failed packages.

Most often, any failures will be caused by the high level of <tt>make</tt> paralleism we are using. Accordingly, if, at the conclusion of the above <tt>emerge</tt>, near the end of the output you see a message that:
{{GenericCmd|
... additional output suppressed ...
 <span style{{=}}"color:red;">*</span> The following <n> packages have failed to build or install:
... additional output suppressed ...
}}
then issue the following command, to re-attempt to build the failed packages, this time ''without'' <tt>make</tt> parallelism:
{{RootCmd
|MAKEOPTS{{=}}"-j1" emerge --ask --verbose --noreplace gnome-base/gnome
|prompt=<span style{{=}}"color:gray;">(1)</span> koneko <span style{{=}}"color:royalblue;">~ #</span>
|output=<pre>
... additional output suppressed ...
Would you like to merge these packages? [Yes/No] <press y, then press Enter>
... additional output suppressed ...
</pre>
}}
(Of course, if the original <tt>emerge</tt> completed successfully, there is no need to issue the above, but, due to the <tt>--noreplace</tt> flag, even if you do it will simply exit immediately, so it is always safe.)
{{Note|If you ''still'' experience build errors emerging {{Package|gnome-base/gnome}}, you find it useful to refer to [[../Building_the_Gentoo_Base_System_Minus_Kernel#troubleshooting_failed_build{{!}}these earlier notes]].
}}

Once the process has completed, ensure you are back in the virtual terminal from where you issued the <tt>emerge</tt> command (i.e., not the <tt>showem</tt> terminal), and then issue the following to ensure your environment is up-to-date post-install:
{{RootCmd
|env-update && source /etc/profile && export PS1{{=}}"(1) $PS1"
|prompt=<span style{{=}}"color:gray;">(1)</span> koneko <span style{{=}}"color:royalblue;">~ #</span>
}}
Hit {{Key|Ctrl}}{{Key|a}} then {{Key|n}} to go to the second <tt>screen</tt> console, and do the same there. Issue:
{{RootCmd
|source /etc/profile && export PS1{{=}}"(2) $PS1"
|prompt=<span style{{=}}"color:gray;">(2)</span> koneko <span style{{=}}"color:royalblue;">~ #</span>
}}
Then press {{Key|Ctrl}}{{Key|a}} then {{Key|p}} to switch back to the original console again.

Next, we need to log back in as our regular user, and try out our new desktop! Issue:
{{RootCmd
|su --login sakaki
|prompt=<span style{{=}}"color:gray;">(1)</span> koneko <span style{{=}}"color:royalblue;">~ #</span>
}}
{{Note|Substitute the user name of the regular user you created in the [[#add_regular_user{{!}}earlier step]] for <tt>sakaki</tt> in the above command.}}

Next, edit the <tt>.xinitrc</tt> file in the regular user's home directory. Issue:
{{Cmd
|nano -w ~/.xinitrc
|prompt=sakaki@koneko <span style{{=}}"color:royalblue;">~ $</span>
}}
{{Note|Obviously, as before, the name that you see in the prompt will reflect that of the regular user you added (and which you just <tt>su</tt>-d to).}}

'''Delete''' the current contents of <tt>.xinitrc</tt> (you can use {{Key|Ctrl}}{{Key|k}} inside <tt>nano</tt> to delete a line at a time), and '''replace''' with the following text:
{{FileBox|filename=~/.xinitrc|title=Replace existing text with the below to start GNOME|lang=bash|1=
export XDG_MENU_PREFIX=gnome-
exec gnome-session
}}
Save and exit <tt>nano</tt>.
{{Note|Don't forget the hyphen at the end of <tt>gnome-</tt> (as shown above). Also, note that there is no need to start the file with a [[:Wikipedia:Shebang_(Unix){{!}}shebang]] this time.}}

OK, time to try it out! Issue:
{{Cmd
|startx
|prompt=sakaki@koneko <span style{{=}}"color:royalblue;">~ $</span>
}}

And hopefully you should be greeted with a (rather startlingly empty!) GNOME 3 desktop, somewhat similar to the below, on the target machine:
[[File:Gnome_first_run.jpg|thumb|none|400px|GNOME Shell Basic Desktop (via startx)]]

{{Note|The precise layout etc. that you see may of course differ, due to version changes in GNOME. Also, you may experience some issues the first time you try running GNOME in this manner (strange display glitches etc.); if so, simply try quitting (by issuing {{Key|Ctrl}}{{Key|c}} at the helper PC <tt>ssh</tt>/<tt>screen</tt> terminal) and then running <tt>startx</tt> again.}}

You can try playing around with it briefly if you like (some simple instructions may be found [https://wiki.gnome.org/Projects/GnomeShell/CheatSheet here] - or just get started by moving your mouse pointer up to the top left corner of the screen, or by pressing {{Key|Windows Key}}), using the target machine keyboard and mouse / touchpad directly. Note, however, that this isn't a properly logged-in instance, so certain of the standard features will not function as you expect. You should be able to start a terminal etc. however. When you're done, kill the test instance, by issuing {{Key|Ctrl}}{{Key|c}} at the helper PC <tt>ssh</tt>/<tt>screen</tt> terminal (the one where you just issued <tt>startx</tt>).

== <span id="testing_gnome3">Testing GNOME 3 (and Refining Settings)</span> ==

Congratulations, GNOME 3 is now basically functional; we only need a few more steps to get it fully operational on your machine! So, let's continue. Come back out to be <tt>root</tt> again:

{{Cmd
|exit
|prompt=sakaki@koneko <span style{{=}}"color:royalblue;">~ $</span>
}}

Next, we must enable the [[:Wikipedia:NetworkManager|<tt>NetworkManager</tt>]] service (which will handle all network interaction under GNOME), and disable the <tt>dhcpcd</tt> service, which we started [[../Configuring_systemd_and_Installing_Necessary_Tools#start_dhcpcd|earlier]] (and whose functionality <tt>NetworkManager</tt> supplants). First, issue:
{{RootCmd
|systemctl stop dhcpcd
|systemctl disable dhcpcd
|prompt=<span style{{=}}"color:gray;">(1)</span> koneko <span style{{=}}"color:royalblue;">~ #</span>
}}
{{Note|As before, with <tt>systemd</tt>'s <tt>systemctl</tt> command, you use:
* <tt>stop</tt> to stop a running service immediately;
* <tt>disable</tt> to ensure a service doesn't start at boot time;
* <tt>enable</tt> to ensure a service will (try to) start at boot time; and
* <tt>start</tt> to run running a service immediately.}}
Next, if you are using '''WiFi''' for the install, you'll also have explicitly set up a <tt>wpa_supplicant</tt> configuration file [[../Configuring_systemd_and_Installing_Necessary_Tools#start_wpa_supplicant|earlier in the tutorial]], and so you need to remove this again now (however, [[#start_nm|'''skip''' this step]] if installing over a '''wired Ethernet''' connection):
{{RootCmd
|mv -v /etc/wpa_supplicant/wpa_supplicant.conf /etc/wpa.conf
|prompt=<span style{{=}}"color:gray;">(1)</span> koneko <span style{{=}}"color:royalblue;">~ #</span>
}}

<span id="start_nm">Now we can fire up <tt>NetworkManager</tt></span>. Issue:
{{RootCmd
|systemctl enable NetworkManager
|systemctl start NetworkManager
|prompt=<span style{{=}}"color:gray;">(1)</span> koneko <span style{{=}}"color:royalblue;">~ #</span>
}}
{{Note|If you are installing via WiFi, you will temporarily lose connectivity when bringing up <tt>NetworkManager</tt> in this manner, since it doesn't yet know your network settings. If that happens to you, enter the subsequent two commands (to enable and start <tt>gdm</tt>) as the <tt>root</tt> user ''directly'' at the target machine's keyboard (those installing over a wired connection can of course issue the commands via <tt>ssh</tt>, as usual). Once <tt>NetworkManager</tt> is configured (as described [[#gnome_network_settings{{!}}next]]), you should be able to re-establish the <tt>ssh</tt> connection.}}

That having being done, we need to make sure that the [[:Wikipedia:GNOME_Display_Manager|GNOME Display Manager]] (<tt>gdm</tt>) is configured to run on boot (and also, we'll start up an instance now). Issue:
{{RootCmd
|systemctl enable gdm
|systemctl start gdm
|prompt=<span style{{=}}"color:gray;">(1)</span> koneko <span style{{=}}"color:royalblue;">~ #</span>
}}

Assuming that worked, <span id="login_to_gnome">you should now</span> be able to see a GNOME login screen on the target machine, similar to the below:
[[File:Gnome_login.jpg|thumb|none|400px|GNOME 3 Login Screen]]

{{Note|If you don't see your regular user's user name appear (as for 'sakaki' in the above screenshot), click on the "<tt>Not listed?</tt>" text, and type in the user name when prompted (directly at the target machine's keyboard)).}}
{{Note|You may need to press {{Key|Enter}} once or twice (directly on the target machine's keyboard) to see the login prompt, if the screen has blanked.}}

Directly at the target machine, click on the (regular) user name then, when prompted, type in the (regular user) password you set up [[#setup_regular_user|earlier]].
{{Note|If your password is rejected, it may be because you do not (yet) have the correct keyboard settings in GNOME (particularly if you have a non-US keyboard, as the Panasonic CF-AX3 does, for example). You can click on the 'man in a circle' accessibility icon in the top bar, and use the on-screen keyboard to enter your password in this case. Afterwards, it is easy to change your keyboard setup via the 'Region & Language' settings panel in GNOME, as described [[#gnome_keyboard_settings{{!}}below]].}}

You should arrive back at the GNOME desktop (only this time, with a little more functionality, since this ''is'' a normal login session). 

Before our final reboot (at which point, we will no longer require the helper PC, but will be using the target machine natively), there are three additional tasks we need to carry out:
# ensuring that network settings are correct;
# setting up keyboard settings are correct within GNOME (if required); and
# ensuring that our the system remembers our volume preferences between reboots.

=== <span id="gnome_network_settings">GNOME Network Settings</span> ===

You should now make sure that your network settings are correct under GNOME. Any wired connection should have been picked up fine, but if you have been installing using '''WiFi''', you'll need to select an access point, and enter your wireless passphrase, to regain network connectivity.

To do that, simply click on the 'downwards pointing triangle' in very top right of the screen. This will show a drop-down menu, from which you can turn on WiFi, and select an access point (you'll be prompted for the passphrase). (Alternatively, you can press the {{Key|Windows Key}}, then type "<tt>settings</tt>" (and press {{Key|Enter}}), then click on the item titled 'Network' in the panel that appears.) It's a fairly self-explanatory interface, but if you need assistance, simply press {{Key|F1}}.

{{Note|If you start playing around with your system now, you'll probably find that there are a few things, like Bluetooth for example, and possibly even WiFi (depending on your setup), that are not working yet. That's because we haven't yet enabled all necessary kernel drivers - but we will address this in the [[../Final_Configuration_Steps|next chapter]]!}}
{{Note|Some users have commented that GNOME (and in particular, WiFi) does not come up properly, until their machine is restarted with <tt>gdm</tt> enabled. Therefore, if you are experiencing any problems with GNOME at this stage (such as your WiFi passphrase being rejected), it may be worth waiting, and trying again once we have rebooted in the final configuration (which we'll do very shortly, [[#restart_to_gnome{{!}}below]]).}}  

Once you have the network set up, you should be able to browse the web etc. Try this now: directly at the target machine's keyboard, press the {{Key|Windows Key}} and type 'Web', then press {{Key|Enter}} to start the first item shown. GNOME's default [[:Wikipedia:Web_(web_browser)|web browser]] will start up, initially full-screen. You can drag it down by the top bar to make it a normal-sized window, type in a URL etc.:
{|style="background:transparent; color:black" 
|[[File:Gnome_web_app.jpg|thumb|none|400px|Searching for a Web Browser in GNOME...]]
|[[File:Gnome_with_browser.jpg|thumb|none|400px|...And Using the Default Browser]]
|}

=== <span id="gnome_keyboard_settings">GNOME Keyboard Settings</span> ===

If you have a non-US keyboard (as in the case of the Panasonic CF-AX3), you will need to set this in GNOME. Press the {{Key|Windows Key}}, then type "<tt>region</tt>" (and press {{Key|Enter}}) and click on the <tt>Region & Language</tt> item in the list. This opens a control panel. Make sure the 'Language' and 'Formats' in the top pane are correct for your locale. Then, add the appropriate 'input source' in the bottom pane. Click on the 'plus' sign icon, and an "Add an Input Source" panel will appear. Click on the tile showing three stacked dots, and drag the panel slightly larger vertically (as otherwise the output will be hidden). You should now be able to click on the 'Other' tile that appears, and then select the required source from the full list, and then click on 'Add' (in my case, I actually added three: "English (UK)" (for my plug-in keyboard), "Japanese" for the machine's built-in keyboard, and "Japanese (Anthy)" for kanji and kana input - obviously, your requirements will probably differ). When done, close out the "<tt>Region & Language</tt>" dialog.

Once an item <span id{{=}}"input_source_menu">has been added</span>, it can be activated via a drop down in the top bar of the screen. In the case of the CF-AX3, you'd want to select 'Japanese' from this list, so that the keyboard mapping is correct (even if you are typing everything in English!) Be sure to check this, if you have problems having your password accepted at the GNOME login screen.

{{Note|If you have a standard US-layout machine and are using it in the US, this section will probably not apply to you. Nevertheless, you should still check that that the 'Language' and 'Formats' elements are set correctly in the "<tt>Region & Language</tt>" panel.}}
{{Note|GNOME has quite extensive context-sensitive help, which you can access by pressing {{Key|F1}} in any panel (for example, try it with "<tt>Region & Language</tt>" open - you'll be able to read useful hints about switching layouts using keyboard accelerators, having a layout per window or one for all windows, and more.}}

=== <span id="gnome_volume_control">GNOME Volume Control</span> ===

You may find that although you can set sound levels using the 'speaker icon' menu in the GNOME top bar, these settings are lost on a reboot (and sound is muted each time). If this occurs on your system (it affects the CF-AX3), take the following steps. First, emerge {{Package|media-sound/alsa-utils}} (you can do this via the <tt>ssh</tt>/<tt>screen</tt> terminal on the helper PC):
{{RootCmd
|emerge --ask --verbose media-sound/alsa-utils
|prompt=<span style{{=}}"color:gray;">(1)</span> koneko <span style{{=}}"color:royalblue;">~ #</span>
|output=<pre>
... additional output suppressed ...
Would you like to merge these packages? [Yes/No] <press y, then press Enter>
... additional output suppressed ...
</pre>
}}
Once that completes, set the volume levels as you like them, then issue:
{{RootCmd
|alsactl store
|prompt=<span style{{=}}"color:gray;">(1)</span> koneko <span style{{=}}"color:royalblue;">~ #</span>
}}
The settings should now be preserved across a reboot.

{{Note|You may also need to change your output settings in the GNOME 'Sound' control panel to hear anything: on the CF-AX3, you need to choose the 'Analog Output' option, which is not selected by default.}}

=== <span id="restart_to_gnome">Restarting into GNOME!</span> ===

We are now ready to bid farewell to the services of the helper PC, as all further steps can now be done on the target machine directly. Close out the <tt>ssh</tt>/<tt>screen</tt> terminal. Issue:
{{RootCmd
|exit
|prompt=<span style{{=}}"color:gray;">(1)</span> koneko <span style{{=}}"color:royalblue;">~ #</span>
}}
which will close the first <tt>screen</tt> terminal, then:
{{RootCmd
|exit
|prompt=<span style{{=}}"color:gray;">(2)</span> koneko <span style{{=}}"color:royalblue;">~ #</span>
}}
to close the second one, then:
{{RootCmd
|exit
|prompt=koneko <span style{{=}}"color:royalblue;">~ #</span>
}}
which will close out the <tt>ssh</tt> session itself. Now, ensure that the USB boot key is inserted in the target PC, and reboot it, by clicking on the 'power' icon (in the top right of the screen), clicking on the 'power' button in the dropdown menu that then appears, and then clicking on the 'Restart' button in the dialog.

The machine should then power cycle (you will be cleanly logged out of GNOME first). When the machine restarts, as before, you will need to enter your LUKS keyfile <tt>gpg</tt> passphrase (the one you created [[../Preparing_the_LUKS-LVM_Filesystem_and_Boot_USB_Key#create_gpg_luks_keyfile|earlier]]), directly at the target machine keyboard to unlock the LUKS partition. You should then be presented directly with a GNOME login page (as [[#login_to_gnome|above]]). Directly at the target machine, click on your (regular) user name then, when prompted, type in the (regular user) password you set up [[#setup_regular_user|earlier]] (ensure you have the correct keyboard settings, if relevant, as discussed [[#input_source_menu|above]]).

Once logged in to GNOME, bring up a web browser: directly at the target machine's keyboard, press the {{Key|Windows Key}} and type 'Web', then press {{Key|Enter}} to start the first item shown. GNOME's default [[:Wikipedia:Web_(web_browser)|web browser]] will start up, initially full-screen. You can drag it down by the top bar to make it a normal-sized window. Do so, and type in the <span id="rejoin">[https://wiki.gentoo.org/wiki/EFI_Gentoo_End_to_End_Install/Setting_up_the_GNOME_3_Desktop#rejoin URL for this tutorial]</span>, so that you can continue to follow it there.
{{Important|From this point on, all interaction with the target machine will be done directly (and not via the helper PC), unless otherwise noted.}}
{{Note|Now that <tt>NetworkManager</tt> is running, even if you have been installing over WiFi, and had to manually restart <tt>wpa_supplicant</tt> in the [[../Configuring_systemd_and_Installing_Necessary_Tools#manually_start_wpa_supplicant_systemd{{!}}previous two chapters]], there should be no further need to do so. WiFi network access should now come online automatically after boot.}}

Now, <span id="open_gnome_terminal">bring up a terminal window</span> in GNOME. Press the {{Key|Windows Key}} again, and type 'terminal', then press {{Key|Enter}}. A standard-issue terminal window should open. As we have some final installation work to do, become root:
{{Cmd
|su --login root
|prompt=sakaki@koneko <span style{{=}}"color:royalblue;">~ $</span>
|output=<pre>
Password: <enter root password>
</pre>
}}
The password required here is the one you set up [[../Final_Preparations_and_Reboot_into_EFI#setup_new_root_password|earlier]] in the tutorial (and have used when <tt>ssh</tt>-ing in).

== <span id="next_steps">Next Steps</span> ==

Congratulations - if you have followed through to this stage, you have a basically functioning system! There is some final driver configuration left still to do, so let's address that now. [[../Final_Configuration_Steps|Click here]] to go to the next chapter, "Final Configuration Steps".

== <span id="notes">Notes</span> ==
{{reflist}}

{| style="margin: 1em auto 1em auto;"
|-
| [[../Configuring_Secure_Boot|<]]
| [[../|Home]]
| [[../Final_Configuration_Steps|>]]
|}

[[Category:Core system]]
[[Category:GNOME]]
[[Category:Localization]]
[[Category:X.Org]]
