<languages />
Chroot (Changement de racine) est un utilitaire système pour changer le répertoire racine apparent en vue de créer un nouvel environnement logiquement séparé du système principal. Ce nouvel environnement est aussi connu sous le nom de  « prison Chroot » (Chroot jail). Un utilisateur opérant dans la prison ne peut ni voir ni accéder au fichiers placés en dehors de l'environnement dans lequel il a été enfermé.

Une des utilisations principales du changement de racine est de créer un système Linux séparé au dessus du système courant dans un but de test ou de compatibilité logicielle. Cela est souvent considéré comme une alternative légère à la virtualisation parce que le système peut fonctionner sans la surcharge du hyperviseur.

== Mettre l'environnement en place ==
La première chose que vous devez faire quand vous créez une nouvelle installation et de créer un répertoire où votre nouvel environnement résidera, par exemple dans « /mnt/chroot ».

{{Cmd
|mkdir /mnt/mychroot
|cd /mnt/mychroot
}}

Si vous voulez monter une installation existante à partir d'une partition, vous pouvez faire :

{{Cmd
|mkdir /mnt/mychroot
|mount /dev/DEVICE /mnt/mychroot
}}

Remplacez DEVICE par la partition où se trouve votre installation existante.

If you already have an installation in a sub directory of the root you are currently in, you don't need to do the above steps.

==Unpacking system files & portage tree for a new installation==
If you're building a new install, the next step is to download the stage3 and portage tarballs and set them up in the chroot location. For more information on this process please see sections 5a and 5b in the [http://www.gentoo.org/doc/en/handbook/handbook-amd64.xml?part=1&chap=5 Gentoo Handbook].

{{RootCmd
|links http://distfiles.gentoo.org/releases/amd64/current-stage3/
|tar xvjpf stage3-*.tar.bz2 -C /mnt/mychroot
|links http://distfiles.gentoo.org/snapshots/
|tar xvjf portage-*.tar.bz2 -C /mnt/mychroot/usr
}}

==Configuration==
Before entering the chroot we need to mount a number of directories.

{{RootCmd
|mount -o bind /dev /mnt/mychroot/dev
|mount -t proc none /mnt/mychroot/proc
|mount -o bind /sys /mnt/mychroot/sys
|mount -o bind /tmp /mnt/mychroot/tmp
}}

And will also need to copy over some basic configuration file from the host, do not copy over make.conf if you're using an existing installation.

{{Cmd
|cp /etc/portage/make.conf /mnt/mychroot/etc/portage # If you use an existing installation, skip this command.
|cp /etc/resolv.conf /mnt/mychroot/etc
}}

Once done we can then enter the chroot environment.

{{RootCmd
|chroot /mnt/mychroot /bin/bash
|env-update
|source /etc/profile
|<nowiki>export PS1="(chroot) $PS1"</nowiki>
}}

When creating a new installation, you can sync portage to make sure everything is up to date.

{{RootCmd
|emerge --sync
}}

The system is now ready. You can install software, mess with settings, test experimental packages and configurations without having any effect on your main system. To leave the chroot simply type "exit" or press Ctrl-D, this will return you back to your normal environment.

==Init scripts==
If you need to do this often, you can speed up the mounting of the directories needed for a chroot by using an init script:

{{File|/etc/init.d/mychroot||
 #!/sbin/runscript

 depend() {
   need localmount
   need bootmisc
 }

 start() {
     ebegin "Mounting chroot directories"
     mount -o bind /dev /mnt/mychroot/dev > /dev/null &
     mount -t proc none /mnt/mychroot/proc > /dev/null &
     mount -o bind /sys /mnt/mychroot/sys > /dev/null &
     mount -o bind /tmp /mnt/mychroot/tmp > /dev/null &
     eend $? "An error occurred while mounting chroot directories"
}

 stop() {
     ebegin "Unmounting chroot directories"
     umount -f /mnt/mychroot/dev > /dev/null &
     umount -f /mnt/mychroot/proc > /dev/null &
     umount -f /mnt/mychroot/sys > /dev/null &
     umount -f /mnt/mychroot/tmp > /dev/null &
     eend $? "An error occurred while unmounting chroot directories"
 }
}}

If you use a different directory or partition, add the necessary mounting commands in start() and change /mnt/chroot if you use a different name.

==See also==
* [http://www.gentoo.org/proj/en/base/x86/chroot.xml Gentoo x86 Chroot Setup Guide]
* [http://www.gentoo.org/proj/en/base/amd64/howtos/index.xml?part=1&chap=2 32Bit Chroot Guide for Gentoo/AMD64]


[[Category:Core system]]
