<languages />

Данное руководство показывает как настроить distcc на кросс-компиляцию для разных архитектур процессора.

== Кросс-компиляция с distcc ==

=== Введение ===

<code>distcc</code> - это инструмент, который позволит Вам распределить процесс компиляции программного обеспечения по нескольких компьютерам, соединенным в сеть. Пока соединенные по сети машины используют одни и те же средства компиляции и генерации кода - toolchain, никакие особенные настройки <code>distcc</code> не требуются. 

=== Собираем необходимые утилиты ===

Сперва, Вам необходимо установить <code>crossdev</code> на всех компьютерах, которые будут вовлечены в процесс компиляции. <code>crossdev</code> - это инструмент, который облегчает сборку кросс-платформенных toolchain-ов. Первоначально, он был написан Joshua Kinard и был переписан с самого нуля Mike Frysinger. Его использование достаточно прямолинейно: например, команда <code>crossdev -t sparc</code> соберет полную cross-toolchain для архитектуры Sparc. Она включает binutils, gcc, glibc, и заголовки ядра Linux. Если Вам требуется дополнительная помощь, попробуйте ввести <code>crossdev --help</code> . Очевидно что Вам не нужно устанавливать подходящую cross-toolchain на все вспомогательные машины. 

Затем, Вам необходимо установить <code>distcc</code> на все машины, которые будут вовлечены в процесс. Это включает и машину, на которой будет запущен emerge и машины с кросс-компиляторами. Пожалуйста, посмотрите [http://www.gentoo.org//doc/ru/distcc.xml документацию Gentoo по Distcc] для поиска более подробной информации по настройке и использованию <code>distcc</code> .

=== Архитектурно-специфические замечания ===

Если Вы проводите кросс-компиляцию между различными субархитектурами для процессора Intel x86 (например, i586 и i686), Вам все так же требуется собрать полную cross-toolchain для необходой архитектуры, указанной в CHOST, или иначе компиляция завершится неудачей. Это потому, что i586 и i686 обладают разными архитектурами CHOST, вопреки тому, что их обе относят к "x86." Пожалуйста, держите это в уме, когда Вы собираете свои cross-toolchain-ы. Например, если целевая платформа - i586, это значит, что Вы должны построить i586 cross-toolchain-ы на Ваших вспомогательных i686 машинах. 

=== Конфигурация distcc для корректной кросс-компиляции ===

In the default distcc setup, cross-compiling will ''not'' work properly. The problem is that many builds just call <code>gcc</code> instead of the full compiler name (e.g. <code>sparc-unknown-linux-gnu-gcc</code> ). When this compile gets distributed to a distcc helper box, the native compiler gets called instead of your shiny new cross-compiler. 

Fortunately, there is a workaround for this little problem. All it takes is a wrapper script and a few symlinks on the box that will be running <code>emerge</code> . I'll use my Sparc box as an example. Wherever you see <code>sparc-unknown-linux-gnu</code> below, you will want to insert your own CHOST ( <code>x86_64-pc-linux-gnu</code> for an AMD64 box, for example). When you first emerge distcc, the {{Path|/usr/lib/distcc/bin}} directory looks like this: 

{{Note|The following instructions are to be performed only on the box running the emerge. Do not perform these steps on the helper boxes.}}

{{RootCmd|cd /usr/lib/distcc/bin
|ls -l|output=<pre>
total 0
lrwxrwxrwx  1 root root 15 Dec 23 20:13 c++ -> /usr/bin/distcc
lrwxrwxrwx  1 root root 15 Dec 23 20:13 cc -> /usr/bin/distcc
lrwxrwxrwx  1 root root 15 Dec 23 20:13 g++ -> /usr/bin/distcc
lrwxrwxrwx  1 root root 15 Dec 23 20:13 gcc -> /usr/bin/distcc
lrwxrwxrwx  1 root root 15 Dec 23 20:13 sparc-unknown-linux-gnu-c++ -> /usr/bin/distcc
lrwxrwxrwx  1 root root 15 Dec 23 20:13 sparc-unknown-linux-gnu-g++ -> /usr/bin/distcc
lrwxrwxrwx  1 root root 15 Dec 23 20:13 sparc-unknown-linux-gnu-gcc -> /usr/bin/distcc
</pre>
}}

Here is what you want to do: 

{{RootCmd|rm c++ g++ gcc cc}}

Next, we'll create the new script on this box. Fire up your favorite editor and create a file with the following text in it, then save it as {{Path|sparc-unknown-linux-gnu-wrapper}} . Remember to change the CHOST (in this case, <code>sparc-unknown-linux-gnu</code> ) to the actual CHOST of the box that will be running the emerge. 

{{Code|The new wrapper script|<pre>
#!/bin/bash
exec /usr/lib/distcc/bin/sparc-unknown-linux-gnu-g${0:$[-2]} "$@"
</pre>
}}

Next, we'll make the script executable and create the proper symlinks: 

{{RootCmd|chmod a+x sparc-unknown-linux-gnu-wrapper
|ln -s sparc-unknown-linux-gnu-wrapper cc
|ln -s sparc-unknown-linux-gnu-wrapper gcc
|ln -s sparc-unknown-linux-gnu-wrapper g++
|ln -s sparc-unknown-linux-gnu-wrapper c++}}

When you're done, {{Path|/usr/lib/distcc/bin}} will look like this: 

{{RootCmd|ls -l|output=<pre>
total 4
lrwxrwxrwx  1 root root 25 Jan 18 14:20 c++ -> sparc-unknown-linux-gnu-wrapper
lrwxrwxrwx  1 root root 25 Jan 18 14:20 cc -> sparc-unknown-linux-gnu-wrapper
lrwxrwxrwx  1 root root 25 Jan 18 14:20 g++ -> sparc-unknown-linux-gnu-wrapper
lrwxrwxrwx  1 root root 25 Jan 18 14:20 gcc -> sparc-unknown-linux-gnu-wrapper
lrwxrwxrwx  1 root root 15 Nov 21 10:42 sparc-unknown-linux-gnu-c++ -> /usr/bin/distcc
lrwxrwxrwx  1 root root 15 Nov 21 10:42 sparc-unknown-linux-gnu-g++ -> /usr/bin/distcc
lrwxrwxrwx  1 root root 15 Jul 27 10:52 sparc-unknown-linux-gnu-gcc -> /usr/bin/distcc
-rwxr-xr-x  1 root root 70 Jan 18 14:20 sparc-unknown-linux-gnu-wrapper
</pre>
}}

Congratulations; you now have a (hopefully) working cross-distcc setup. 

=== How this works ===

When <code>distcc</code> is called, it checks to see what it was called as (e.g. <code>i686-pc-linux-gnu-gcc</code> , <code>sparc-unknown-linux-gnu-g++</code> , etc.) When distcc then distributes the compile to a helper box, it passes along the name it was called as. The distcc daemon on the other helper box then looks for a binary with that same name. If it sees just <code>gcc</code> , it will look for <code>gcc</code> , which is likely to be the native compiler on the helper box, if it is not the same architecture as the box running <code>emerge</code> . When the ''full'' name of the compiler is sent (e.g. <code>sparc-unknown-linux-gnu-gcc</code> ), there is no confusion. 

== Acknowledgements ==

We would like to thank the following authors and editors for their contributions to this guide:

* Andrew Gaffney
* Joshua Saddler
