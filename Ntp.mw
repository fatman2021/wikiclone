{{Lowercase title}}
{{InfoBox stack
|{{InfoBox homepage|http://ntp.org/|header=true}}
|{{InfoBox wikipedia|Network Time Protocol}}
|{{InfoBox wikipedia|OpenNTPD}}
|{{InfoBox ohloh|ntpd}}
}}
'''NTP''' ('''N'''etwork '''T'''ime '''P'''rotocol) is used to synchronize the [[system time]] with other devices over the network. This usually happens in a client-server model.

== Installation ==
Install {{Package|net-misc/ntp}}:
{{USEflag
|package=net-misc/ntp
|caps
|debug++no
|ipv6+yes
|openntpd
|parse-clocks
|samba
|selinux
|snmp
|ssl+yes
|vim-syntax
|zeroconf
}}

{{Emerge|ntp}}

Or alternatively, you can use [[OpenNTPD]] instead.

== Configuration ==

=== Ntp-Client ===
to adjust ntp-client's command & upstream servers.

{{File|/etc/conf.d/ntp-client||<pre>
NTPCLIENT_CMD="ntpdate"
NTPCLIENT_OPTS="-s -b -u \
	0.gentoo.pool.ntp.org 1.gentoo.pool.ntp.org \
	2.gentoo.pool.ntp.org 3.gentoo.pool.ntp.org"
</pre>
}}

=== Server ===
Here you can specify with which servers you want to synchronize your local time for ntpd.  

The default configuration is populated with
{{File|/etc/ntp.conf||<pre>
server 0.gentoo.pool.ntp.org
server 1.gentoo.pool.ntp.org
server 2.gentoo.pool.ntp.org
server 3.gentoo.pool.ntp.org
</pre>}}

{{Note|Time zones and location of the server do not matter, it synchronizes the [[Wikipedia:Coordinated Universal Time|UTC time]].}}

Per default the Gentoo servers are listed and enabled. A list of available servers can be found here: [http://www.pool.ntp.org/en/#top ntp.org]. You can also define a home or company server here, given that ntpd is running and the machine is allowed to.

On systems, where network connection is not always available at boot (laptops etc.) it might be helpful to add the following lines to server configuration:
{{File|/etc/ntp.conf||<pre>
server 127.127.1.0
fudge  127.127.1.0 stratum 10
</pre>}}
This sets localhost as a server with low priority, so that the daemon starts properly even without network connection and switches to using network servers when connection is established.

=== Permissions ===
To control who is allowed to synchronize with this machine and change the configuration, you can change these options.

* access to NTP service allowed only from localhost.   'noquery' can be added to help prevent your server from being abused to conduct DDOS attacks
{{File|/etc/ntp.conf||<pre>
# To deny other machines from changing the
# configuration but allow localhost:
restrict default nomodify nopeer noquery
restrict 127.0.0.1
</pre>}}

* access to NTP service allowed only from the 192.168.0.0/24 network.
{{File|/etc/ntp.conf||<pre>
# To allow machines within your network to synchronize
# their clocks with your server, but ensure they are
# not allowed to configure the server or used as peers
# to synchronize against, uncomment this line.
#
restrict 192.168.0.0 mask 255.255.255.0 nomodify nopeer notrap
</pre>}}

* denying access to NTP's monlist functionality, used for querying traffic stats but also exploited in a denial-of-service attack.
{{File|/etc/ntp.conf||<pre>
disable monitor
</pre>}}

== Usage ==
Basic tools and common usage

=== Client ===

==== Ntp-Client ====
{{RootCmd|rc-service ntp-client start}}

To monitor status of the client.
{{RootCmd|rc-service ntp-client status}}

To start at boot.
{{RootCmd|rc-update add ntp-client default}}

==== Ntpdate ====
This used to be the client, but its functionality is now moved into ntpd & ntp-client itself. It is purely to set the local time when started and then exits (not a service):

{{RootCmd|ntpdate pool.ntp.org}}

=== Server ===
{{Note|The server is both a client, and server.  If your setup can't access net early in init, use server only instead.}}

==== Ntpd Service ====
If ntpd is run as a service, the time will automatically synchronize as long as the difference between the local time and the time on the server is less than 1000s (~17min). So it is pretty common to adjust the time initially to whatever the server time is as a trusted source:

{{RootCmd|ntpd -g -c /etc/ntp.conf}}
{{Note|If ntpd is already running, it won't start a second time.}}

Add ntpd to the default runlevel to have the time synchronized automatically.  There is no need to run a client when the service is running.  Make sure you are not running ntp-client or ntpdate.

{{RootCmd
|rc-service ntpd start
|rc-update add ntpd default}}

To monitor status of the server.
{{RootCmd|rc-service ntpd status}}

=== Hardware Clock ===
To write your NTP sync time to the hardware at shutdown, and read hardware clock at start.

{{RootCmd
|<nowiki>echo 'clock_hctosys="YES"' >> /etc/conf.d/hwclock</nowiki>
|<nowiki>echo 'clock_systohc="YES"' >> /etc/conf.d/hwclock</nowiki>
|rc-service hwclock restart
|rc-update add hwclock boot
}}

Or on a sufficiently modern kernel (3.9 or newer), you can configure Linux to handle it automatically:

{{Kernel||<pre>
Device Drivers  --->
  [*] Real Time Clock  --->
    [*]   Set system time from RTC on startup and resume
    [*]   Set the RTC time based on NTP synchronization
</pre>}}

The hwclock init script is not needed at all with this method, which speeds up the boot/shutdown process slightly.

=== systemd / timedatectl ===

systemd comes with timedatectl to manage your system clock time. 

The manpage of timedatectl shows how ntpd and timedatectl can work together:
{{Cmd
|man timedatectl<pre>
 Enable an NTP daemon (chronyd):

           $ timedatectl set-ntp true
           ==== AUTHENTICATING FOR org.freedesktop.timedate1.set-ntp ===
           Authentication is required to control whether network time synchronization shall be enabled.
           Authenticating as: user
           Password: ********
           ==== AUTHENTICATION COMPLETE ===

           $ systemctl status chronyd.service
           chronyd.service - NTP client/server
                     Loaded: loaded (/usr/lib/systemd/system/chronyd.service; enabled)
                     Active: active (running) since Fri, 2012-11-02 09:36:25 CET; 5s ago
           ...</pre>
}}

However, it also seems to work if ntpd.service is enabled

{{RootCmd
|systemctl enable ntpd
|systemctl enable ntpd
ln -s '/usr/lib64/systemd/system/ntpd.service' '/etc/systemd/system/multi-user.target.wants/ntpd.service'
|systemctl status ntpd
ntpd.service - OpenNTP Daemon
   Loaded: loaded (/usr/lib64/systemd/system/ntpd.service; disabled)
   Active: active (running) since Mi 2014-04-23 13:46:28 CEST; 3s ago
 Main PID: 27243 (ntpd)
   CGroup: /system.slice/ntpd.service
           ├─27243 /usr/sbin/ntpd -s -d
           └─27244 /usr/sbin/ntpd -s -d

Apr 23 13:46:28 lapslave systemd[1]: Started OpenNTP Daemon.
Apr 23 13:46:28 lapslave ntpd[27243]: ntp_adjtime adjusted frequency by 0.000000ppm
Apr 23 13:46:28 lapslave ntpd[27243]: ntp engine ready
Apr 23 13:46:28 lapslave ntpd[27243]: reply from 85.214.52.61: offset 0.004787 delay 0.063980, next query 7s
Apr 23 13:46:28 lapslave ntpd[27243]: reply from 83.137.98.96: offset 0.006781 delay 0.070009, next query 6s
Apr 23 13:46:28 lapslave ntpd[27243]: reply from 83.170.1.42: offset 0.004661 delay 0.074198, next query 6s
}}

The time is synced despite the fact that timedatectl says ntp sync is off:
{{RootCmd
|timedatectl
      Local time: Mi 2014-04-23 13:47:54 CEST
  Universal time: Mi 2014-04-23 11:47:54 UTC
        RTC time: Mi 2014-04-23 12:48:50
        Timezone: Europe/Berlin (CEST, +0200)
     NTP enabled: n/a
NTP synchronized: no
 RTC in local TZ: no
      DST active: yes
 Last DST change: DST began at
                  So 2014-03-30 01:59:59 CET
                  So 2014-03-30 03:00:00 CEST
 Next DST change: DST ends (the clock jumps one hour backwards) at
                  So 2014-10-26 02:59:59 CEST
                  So 2014-10-26 02:00:00 CET
}}

== See also ==
* [[Home Router|Home Router Guide]]

== External Resources ==
* https://wiki.archlinux.org/index.php/Network_Time_Protocol_daemon

[[Category:Daemons]]
[[Category:Server]]
