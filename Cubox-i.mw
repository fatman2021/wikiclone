== Goal ==

The goal of these instructions is to have a running installation of Gentoo on a Cubox-i, with a kernel up-to-date enough to run a current btrfs root filesystem.

== Prerequisite ==

* Cubox-i
** if you want to configure over a serial console you need a CuBox-i2ultra or a CuBox-i4pro
** otherwise you need an hdmi display and an usb keyboard
* another (Linux) computer with a cross compiler for arm installed
* git
* tftp server
* u-boot-tools
* [http://imx.solid-run.com/wiki/index.php?title=Beginner%27s_guide#Mini-Installer_Image mini-image]
* sd-card (with enough space, boot partition, rootfs with a git kernel and gentoo, 4GB+)
* network cable for an internet connection (the wifi driver needs a firmware that can be installed later)

== Installation ==

The install consists of partitioning and formatting, the sd-card. Copying over a stage3 tarball, configuring it so that it can boot and it can be accessed. Creating a kernel. Booting the kernel on the machine. Installing the kernel for an automatic boot. Continue a default Gentoo installation.

=== Setup Custom u-Boot ===

<TODO>
u-Boot can be compiled from source as well. Nevertheless we start with a precompiled one, so this step can be skipped.

=== Setup serial console ===

If the model is a CuBox-i2ultra or a CuBox-i4pro it can be connected direclty with your other computer. If not you need to attach it to an hdmi display and connect a usb keyboard.


=== Preparing SD Card ===

To start we flash the mini-image on the sd-card. This way there is already u-boot properly installed and we can test if the serial connection (or connected keyboard and display) is working.

If the first test worked okay you can partition and format the card. As in the goal described in a two partition scheme will be used.
* {{Path|/dev/mmcblk0p0}} will be ext2 with 100MB (boot)
* {{Path|/dev/mmcblk0p1}} will be btrfs with the rest of the capacity (root)

{{Path|/dev/mmcblk0}} can be different in your computer probably {{Path|/dev/sdX}}

The minimal configuration of the root has to be done already on the other computer
# extract stage3
# edit {{Path|/etc/fstab}}
# set root password
# enable serial console

==== Extract stage 3 ====

Get from [http://www.gentoo.org/main/en/mirrors.xml Gentoo Mirrors] the latest {{Path|/releases/arm/autobuilds/current-stage3-armv7a_hardfp/}} and extract it to the root partition.

{{RootCmd
|cd /mnt/sdcard-root
|tar xvjpf /path/to/download/stage3-*.tar.bz2}}

==== Edit /etc/fstab ====
Edit on the root partition on the sdcard {{Path|/etc/fstab}}:

{{File|/etc/fstab||<pre>
/dev/mmcblk0p1          /boot           ext2            noauto,noatime  1 2
/dev/mmcblk0p2          /               btrfs           noatime         0 1

#/dev/SWAP              none            swap            sw              0 0
#/dev/cdrom             /mnt/cdrom      auto            noauto,ro       0 0
#/dev/fd0               /mnt/floppy     auto            noauto          0 0
</pre>}}

==== Edit root password ====

To be able to login later we need to set a root password, we create passwor hash and edit it to the {{Path|/etc/shadow}}.

{{RootCmd
|openssl passwd -1
|nano -w /mnt/sdcard-root/etc/shadow
}}

Replace the start or current hash of the root user with the output from the command above.

==== Enable serial console ====

To also have a serial console after we booted the current system we need to modify.

{{RootCmd|nano /mnt/sdcard-root/etc/inittab}}

Change the s0 line to the following:

{{File|/mnt/sdcard-root/etc/inittab||<pre>
s0:12345:respawn:/sbin/agetty -L 115200 ttymxc0 vt100
</pre>}}

This should be enough that a kernel can boot the system and that we can work with it afterwards.

=== Kernel ===

At the moment the are multiple [http://imx.solid-run.com/wiki/index.php?title=CuBox-i_and_Carrier-One_Resources_Links sources for kernels] available all with their specific advantages and drawbacks.

* https://github.com/SolidRun/linux-imx6 the kernels here are all 3.0.x, they are the offical ones from solidrun with all the patches included but unfortunately to old for a current btrfs system
* a vanilla kernel 3.12+ might run on the cubox-i but it does not contain all the patches to use the complete hardware
* https://github.com/SolidRun/linux-linaro-stable-mx6 is new merge of 3.10.x and all the patches, '''in the following we are going with this one'''
** (2014-03-01) I had some problems with make dtbs, and had to make some modifications, you can find the [https://github.com/stefan-langenmaier/linux-linaro-stable-mx6 here], but be warned I have no idea what I am doing.
* There are also [https://github.com/RobertCNelson/armv7-multiplatform some] [http://www.home.arm.linux.org.uk/~rmk/cubox/ patches] for 3.14-rc around. I could not test them. 3.14 or 3.15 should include more support for the Cubox-i in the vanilla kernel.

{{RootCmd
|export ARCH=arm
|export CROSS_COMPILE=armv7a-hardfloat-linux-gnueabi-
|git clone --depth=1 https://github.com/linux4kix/linux-linaro-stable-mx6
|cd linux-linaro-stable-mx6
|make imx_v7_cubox-i_hummingboard_defconfig
|make menuconfig
}}

Add btrfs to the kernel (built-in). Add <code>ARM_APPENDED_DTB</code> to the kernel.

{{RootCmd
|make zImage
|make imx6q-cubox-i.dtb
|cd arch/arm/boot
|cat zImage dts/imx6q-cubox-i.dtb > zImage-dtb
|mkimage -A arm -O linux -C none -T kernel -a 0x10008000 -e 0x10008000 -n "linux-cubox-i-3.10.30" -d zImage-dtb uImage
}}

==== Wifi ====

The drivers for wifi need a firmware. In case you are have set them to built-in you have to include the blobs already in the kernel

The following settings are necessay for the driver:
* <code>CONFIG_BRCMUTIL=y</code>
* <code>CONFIG_BRCMFMAC=y</code>
* <code>CONFIG_BRCMFMAC_SDIO=y</code>

I have the blobs from the geexbox package [http://download.geexbox.org/snapshots/geexbox-xbmc-imx6-cuboxi/latest/binaries.cuboxi/packages/  firmware-wifi-brcm80211_20140206-d7f8a7c81a3-1_armv7.opk]
* brcmfmac4329-sdio.bin
* brcmfmac4329-sdio.txt

The files have to be dropped in {{Path|/lib/firmware/brcm/}} if the driver is compiled as module or directly into the kernel source folder under {{Path|firmware/brcm}} if they will be compiled built-in.


==== Headers ====

To compile certain applications like xbmc that have modified/additional codecs zou need to expose the patched  kernel headers. Fortunately there is a script for that:

{{RootCmd| make headers_install ARCH{{=}}arm INSTALL_HDR_PATH{{=}}/usr/local/include}}

If you install them into /usr/local/include then you don't overwrite the ones provided by the gentoo package.

=== Bootloader / U-Boot ===

==== Interactive ====

Connect to your Cubox-i with a serial console (or with a keyboard and a display) and interrupt the u-boot bootloader with {{Key|Enter}} and type the following commands.

<pre>
setenv ipaddr 192.168.0.<CUBOXI-IP>
setenv serverip 192.168.0.<TFTP-IP>
setenv bootargs root=/dev/mmcblk0p2 rootfstype=btrfs ro rootwait console=ttymxc0,115200
tftpboot 0x10800000 uimage
bootm 0x10800000
</pre>

This should boot you in your Cubox-i installation and you should be able to login as root with your password. From here you can continue with a default Gentoo installation. To make this boot configuration permanent follow the next step "Default".

==== Default (Hardcoded)====

In the following we will make the settings permanent. The uImage file is copied to the boot partition. The first line contains the settings for loading the kernel into memory. The second holds the arguments for the kernel. The third one is the code to execute the kernel.

The bootcmd is called by default and executes theses three steps in order. The last line makes these variables permanent in the u-boot settings.
<pre>
setenv mybootload ext2load mmc 0:1 0x10800000 /uimage
setenv mybootset setenv bootargs root=/dev/mmcblk0p2 rootfstype=btrfs ro rootwait console=ttymxc0,115200
setenv mybootstart bootm 0x10800000
setenv bootcmd run mybootset mybootload mybootstart
saveenv
</pre>

==== uEnv ====

u-Boot can also read configuration values from a file. This way the boot process can be modified without going into the u-Boot console and the settings are permanent as well. The following script is modified from the original mini-image used for the installation. In the uEnv.txt file you can no add now for example rootflags to boot from a specific btrfs snapshot.

<pre>
setenv gsetmmc 'root="root=/dev/mmcblk${rootunit}p$rootpart rootfstype=$rootfs ro rootwait"' 
setenv gconsole console=ttymxc0,115200 consoleblank=0
setenv gbootextra init=/init
setenv grootflags ""
setenv gvideo mxcfb0:dev=hdmi,1920x1080M@60,if=RGB24
setenv gbootpreset 'bootdev=mmc; bootunit=0; bootpart=1; bootfs=ext2; envfile=uEnv.txt; bootroot=; bootfile=uImage'
setenv grootpreset 'rootunit=0; rootpart=2; rootfs=btrfs'
setenv gsetenvscript setenv gbootenv "\'run gset\${bootdev}; setenv bootargs \$root \$gvideo \$gconsole \$gbootextra \$grootflags $end\'"
setenv gloaduenv 'if ${bootfs}load $bootdev $bootunit:$bootpart $loadaddr $envfile; then env import -t $loadaddr $filesize; fi'
setenv grootpresetup 'bootrun=bootm; loadfile=$bootfile; rootdev=$bootdev; rootunit=$bootunit; rootpart=$rootpart; rootfs=$rootfs'
setenv gbootload '${bootfs}load $bootdev $bootunit:$bootpart $loadaddr $bootroot/$loadfile'
setenv gbootstart '$bootrun'
setenv bootcmd run gbootpreset grootpreset gsetenvscript gloaduenv grootpresetup gbootenv gbootload gbootstart
</pre>

=== Continue Gentoo install ===

Steps that should be done right after the installation
# setup network
# set date
# emerge-webrsync
# emerge ntpd
# /etc/init.d/sshd

[http://www.gentoo.org/doc/en/handbook/handbook-arm.xml Gentoo arm install Handbook]

=== Graphics driver (closed source) ===

You can find a portage repository with packages for the closed source drivers on github: https://github.com/stefan-langenmaier/gentoo-cubox-i-repository

== Applications ==

=== XBMC ===

If you want to install XBMC make sure that:

* consoleblank=0 is enabled in the bootargs otherwise you will get a "No signal/no video" after 10 minutes
* for the moment you should use XBMC and libCEC from the custom repos
* you have ''make headers_install'' executed

== References ==

* [http://imx.solid-run.com/wiki/index.php?title=Serial_console#Linux SolidRun Wiki serial console]
* [http://imx.solid-run.com/wiki/index.php?title=Common_problems SolidRun Wiki common problems]
* [http://imx.solid-run.com/wiki/index.php?title=Flash_an_image SolidRun Wiki flash image]
* [https://dev.gentoo.org/~armin76/arm/beaglebone/install.xml armin76â€™s (un)official beaglebone howto]
* [http://imx.solid-run.com/wiki/index.php?title=CuBox-i_and_Carrier-One_Resources_Links SolidRun Wiki kernel resources]
* [http://wireless.kernel.org/en/users/Drivers/brcm80211#Firmware_installation-1 Broadcom Wifi]
* [http://eewiki.net/display/linuxonarm/Wandboard Wandboard]
* [https://plus.google.com/103895730806848715870/posts/dDFGdPL2oEn u-boot from zImage with device tree]
* [https://community.freescale.com/thread/308940 consoleblank=0]
== Open Questions ==

* open-source hardware-accelerated video driver 
** [https://github.com/laanwj/etna_viv reverse engineereddrivers]
** [https://plus.google.com/113859186888177702948/posts/Y9ZWe7rqumb kms driver is disabled in patched kernel]

[[Category:Embedded systems]]
