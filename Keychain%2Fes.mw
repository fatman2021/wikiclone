<languages />

Este documento describe cómo usar claves compartidas de SSH
junto con el programa keychain. Asume un conocimiento básico de
criptografía con clave pública.

== Conceptos previos ==

=== Descripción del problema ===

Así que tiene todas esas hermosas máquinas Gentoo corriendo <c>sshd</c>,
pero supone un pequeño inconveniente tener que escribir constantemente todas esas
claves de acceso, ¿verdad? O tal vez tenga un guión o trabajo programado
que necesita una forma adecuada de utilizar una conexión ssh. De cualquier
manera, hay una solución a este problema, que comienza con la autenticación mediante
clave pública. 

=== ¿Cómo funciona la autenticación con clave pública? ===

Asumamos que tenemos un cliente que quiere conectarse a un servidor
que corre sshd. El cliente, en primer lugar, genera un par de claves y le
entrega la clave pública al servidor. Después de esto, cada vez que el cliente intente
conectarse, el servidor envía un reto cifrado con la clave
pública. Solamente el titular de la correspondiente clave privada (el
cliente) puede descifrar el reto, así pues, como habrá adivinado,
la respuesta correcta conduce a una autenticación exitosa. 

== Cómo utilizar la autenticación de clave pública ==

=== Genere su par de claves ===

El primer paso consiste en crear su par de claves. Para hacer esto,
usaremos la orden <c>ssh-keygen</c> de la siguiente forma: 

{{Cmd|ssh-keygen -t dsa}}

Simplemente acepte los valores por defecto y asegúrese de introducir una
contraseña (passphrase) robusta.

{{Warning|Asegúrese de usar una contraseña robusta, ¡Especialmente si esta clave se usará para autenticar al usuario root!}}

Ahora debería tener una clave privada en {{Path|~/.ssh/id_dsa}} y
una clave pública en {{Path|~/.ssh/id_dsa.pub}}. Estamos listos
para copiar la clave pública al servidor remoto. 

=== Preparar el servidor ===

Copiaremos el fichero {{Path|~/.ssh/id_dsa.pub}} al servidor que
corre sshd. También lo añadiremos al fichero {{Path|~/.ssh/authorized_keys}} que pertenece al usuario que se conectará a
este servidor. A continuación se muestra un ejemplo de cómo cómo hacerlo si ya tiene acceso ssh al servidor. 

{{Cmd|scp ~/.ssh/id_dsa.pub usuario_del_servidor@servidor:~/miequipo.pub |ssh usuario_del_servidor@servidor "cat ~/miequipo.pub &gt;&gt; ~/.ssh/authorized_keys" |ssh usuario_del_servidor@servidor "cat ~/.ssh/authorized_keys"}}

La salida de la última línea le debería mostrar el contenido del fichero {{Path|~/.ssh/authorized_keys}}. Asegúrese de que es correcto. 

=== Probar la configuración ===

Teóricamente, si todo ha ido bien y el demonio ssh del servidor lo
permite, debería obtener acceso ssh sin contraseña en este
momento. Todavía hará falta descifrar la clave privada en el cliente
con la contraseña que establecimos anteriormente, pero no confunda esto
con la contraseña de la cuenta del usuario en el servidor. 

{{Cmd|ssh usuario_del_servidor@servidor}}

Esperemos que se le haya solicitado la contraseña para id_dsa y que
haya podido obtener acceso ssh al servidor como usuario_del_servidor. Si no, acceda al servidor como usuario_del_servidor y verifique
el contenido del archivo {{Path|~/.ssh/authorized_keys}} para
asegurarse de que cada entrada está en su propia línea. Quizás también quiera revisar la configuración de sshd para determinar que prefiere utilizar la autenticación mediante clave pública cuando ésta esté disponible. 

En este momento, seguro que está pensando "¿Cuál será la gracia?
¡Solo he cambiado una contraseña por otra!" Relájese, en la siguiente
sección le mostraré exactamente lo que tiene que hacer para ahorrar su precioso tiempo. 

== Hacer que la autenticación por clave pública merezca la pena ==

=== Gestión típica de claves con ssh-agent ===

Si ha llegado hasta aquí, probablemente piense que
sería grandioso si pudiésemos, de alguna manera, descifrar nuestra(s)
clave(s) privada(s) una sola vez y así poder usar ssh libremente sin más
contraseñas. ¡Es afortunado! porque es exactamente para lo que
sirve el programa <code>ssh-agent</code>. 

El programa <code>ssh-agent</code> normalmente se inicia al comienzo de una sesión X, o al iniciar una sesión con un guión como {{Path|~/.bash_profile}}. Para funcionar, crea un zócalo (socket) unix y registra las variables de entorno adecuadas para que cualquier aplicación posterior pueda aprovechar sus servicios al conectarse a este zócalo (socket). Por supuesto, solo tiene sentido ejecutarlo en el proceso padre de su sesión X si desea usar las claves
privadas descifradas en las aplicaciones X posteriores. 

{{Cmd|eval `ssh-agent`}}

{{Note|This ssh-agent will keep keys decrypted until you kill ssh-agent. If you want to set a lifetime for the keys, use the -t argument as described in <code>man ssh-agent</code> .}}

Al correr ssh-agent, le debería notificar su identificador del proceso (PID) además de establecer valores para algunas variables de entorno, en particular, <code>SSH_AUTH_SOCK</code> y <code>SSH_AGENT_PID</code>. Debería también
agregar automáticamente {{Path|~/.ssh/id_dsa}} a su colección y pedirle la correspondiente contraseña. Si tiene otras claves privadas que quiera agregar al ssh-agent que está corriendo, puede utilizar la orden <code>ssh-add</code> de la siguiente forma: 

{{Cmd|ssh-add algun_fichero_de_claves}}

Ahora viene la magia. Ya que debe tener lista su clave privada descifrada, podrá acceder al servidor mediante ssh sin teclear contraseña alguna. 

{{Cmd|ssh server}}

¿No sería bueno saber cómo parar ssh-agent cuando se necesite? 

{{Cmd|ssh-agent -k}}

{{Note|Si ha tenido algún problema en hacer funcionar ssh-agent, tal vez sea porque sigue corriendo. Puede acabar con él como cualquier otro proceso mediante <code>killall ssh-agent</code>.}}

Si desea aún más comodidad para utilizar ssh-agent, proceda a la siguiente sección sobre el uso de keychain. Asegúrese de acabar con el ssh-agent
que esté corriendo tal y como se muestra en el ejemplo anterior, si así lo desea.

=== Sacar hasta la última gota de comodidad de ssh-agent ===

Keychain le permitirá reutilizar un ssh-agent entre un acceso y otro y opcionalmente, le pedirá la contraseña cada vez que el usuario acceda. Pero, antes de avanzar demasiado, vamos a correr emerge. 

{{Emerge|keychain}}

Asumiendo que no hubo problemas, ahora podemos utilizar keychain libremente. Agregue lo siguiente a su {{Path|~/.bash_profile}} para activarlo: 

{{Code|Habilitar keychain en .bash_profile|<pre> 
keychain ~/.ssh/id_dsa
. ~/.keychain/$HOSTNAME-sh
. ~/.keychain/$HOSTNAME-sh-gpg
</pre>
}}

{{Note|Puede agregar tantas claves privadas como desee a la línea de la orden. Además, si quiere que solicite la contraseña cada vez
que inicie un intérprete de órdenes, agregue la opción --clear.}}

{{Note|Si no está usando bash, revise la sección '''EXAMPLES''' de <code>man keychain</code> para ver ejemplos de cómo usarlo con otros intérpretes de órdenes. La idea es que estas órdenes se ejecuten cada vez que utilice un intérprete de órdenes.}}

Ahora vamos a probarlo. En primer lugar asegúrese de que ha acabado con el ssh-agent iniciado en la sección anterior. A continuación iniciamos un nuevo intérprete de órdenes, normalmente accediendo a nuestro sistema o abriendo un nuevo terminal. Debería pedirle la contraseña para cada clave especificada en la línea de la orden. Todos los intérpretes de órdenes que se abran a partir de este momento debería reutilizar a ssh-agent, permitiéndole realizar conexiones ssh sin utilizar contraseña una y otra vez. 

=== Usar keychain con KDE ===

Si utiliza KDE, en vez utilizar {{Path|~/.bash_profile}}, puede dejar a KDE que se encargue del ssh-agent. Para ello, tendrá que
editar el fichero {{Path|/etc/kde/agent-startup.sh}}, que se lee durante el inicio de KDE, y el fichero {{Path|/etc/kde/shutdown/agent-shutdown.sh}}, que se ejecuta durante el apagado de KDE. A continuación se muestra como podrían editarse estos ficheros: 

{{Code|Editar /etc/kde/agent-startup.sh|<pre>
if [ -x /usr/bin/ssh-agent ]; then
  eval "$(/usr/bin/ssh-agent -s)"
fi
</pre>
}}

{{Code|Editar /etc/kde/shutdown/agent-shutdown.sh|<pre>
if [ -n "${SSH_AGENT_PID}" ]; then
  eval "$(ssh-agent -k)"
fi
</pre>
}}

Ahora, todo lo que tiene que hacer es iniciar el terminal que desee, por ejemplo, Konsole, y cargar las claves que le gustaría usar. Por ejemplo: 

{{Cmd|keychain ~/.ssh/id_dsa}}

Your keys will be remembered until you end your KDE session or kill the ssh-agent manually. 

== Comentarios finales ==

=== Consideraciones sobre la seguridad ===

Of course, the use of ssh-agent may add a bit of insecurity to your system. If another user were to use your shell while you were in the bathroom, he could login to all of your servers without passwords. As a result, it is a risk to the servers you are connecting to, and you should be sure to consult the local security policy. If you do use it, be sure to take the appropriate measures to ensure the security of your sessions. 

=== Solución de problemas ===

Most of this should work pretty well, but if you encounter problems, you'll certainly want to know a few useful things. 

* If you are unable to connect without ssh-agent, consider using ssh with the arguments -vvv to find out what's happening. Sometimes the server is not configured to use public key authentication, sometimes it is configured to ask for local passwords anyway! If that is the case, you may want to also use the -o option with ssh, or change the server sshd_config.
* If you are having problems with ssh-agent or keychain, it may be that you are not using a shell that understands the commands they use. Consult the man pages for ssh-agent and keychain for details on working with other shells.
* You may also want to visit the [https://github.com/funtoo/keychain keychain homepage] for more usage tips.

== Agradecimientos ==

We would like to thank the following authors and editors for their contributions to this guide:


* Eric Brown
* Marcelo Goes
* nightmorph

[[Category:Server and Security]]
