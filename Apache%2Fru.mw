<languages />

{{Metadata|abstract=HTTP-сервер APACHE это эффективный и расширяемый веб-сервер, а также один из самых популярных веб-серверов в Интернет.}}

{{InfoBox stack
|{{InfoBox homepage|http://httpd.apache.org|header=true}}
|{{InfoBox wikipedia|Apache HTTP Server}}
|
}}

'''Apache HTTP-сервер''' — это эффективный и расширяемый [[:Category:Web Servers|веб-сервер]], а также один из самых популярных используемых в интернете серверов.

== Установка ==

{{Note/ru|Если требуется только обновление, обратитесь к [http://www.gentoo.org/proj/en/apache/doc/upgrading.xml руководству по обновлению].}}

{{Emerge|{{Package|www-servers/apache}}}}

=== USE-флаги ===

{{USEflag|package=www-servers/apache
|debug
|doc
|ldap
|ssl+yes
|static
|suexec
|threads
|APACHE2_MODULES+++See {{Path|[http://sources.gentoo.org/cgi-bin/viewvc.cgi/gentoo-x86/profiles/desc/apache2_modules.desc /usr/portage/profiles/desc/apache2_modules.desc]}}. Enable in your {{Path|make.conf}}.
|APACHE2_MPMS+++See {{Path|[http://sources.gentoo.org/cgi-bin/viewvc.cgi/gentoo-x86/profiles/desc/apache2_mpms.desc /usr/portage/profiles/desc/apache2_mpms.desc]}}. Enable in your {{Path|make.conf}}.
}}

=== Поддержка в других пакетах ===

Существует глобальный USE-флаг ''apache2'', который включает поддержку Apache в других пакетах. Он может автоматически «подтянуть» {{Package|www-servers/apache}} в качестве зависимости, если такие пакеты есть в системе.
{{File|/etc/portage/make.conf||<pre>
USE="...apache2 ..."
</pre>}}

После установки этого флага потребуется обновить систему, чтобы изменения вступили в силу:

{{Emerge|params+=--changed-use --deep|@world}}

== Запуск и перезапуск ==

=== OpenRC ===

Запуск сервера Apache:

{{RootCmd|/etc/init.d/apache2 start}}

Добавление Apache в уровень исполнения по умолчанию:

{{RootCmd|rc-update add apache2 default}}

Перезапуск службы Apache:

{{RootCmd|/etc/init.d/apache2 restart}}

Перезагрузка конфигурационных файлов Apache:

{{RootCmd|/etc/init.d/apache2 reload}}

=== systemd ===

Запуск сервера Apache:

{{RootCmd|systemctl start apache2}}

Добавление Apache в уровень исполнения по умолчанию: 

{{RootCmd|systemctl enable apache2}}

Перезапуск службы Apache: 

{{RootCmd|systemctl restart apache2}}

== Тестирование ==

Проверка интерфейсов IP, на которых apache2 работает, и портов IP, которые он «слушает»:

{{RootCmd|netstat -tulpen {{!}} grep apache|output=<pre>
tcp     0     0 0.0.0.0:80      0.0.0.0:*     LISTEN     0     10932720     4544/apache2        
tcp     0     0 0.0.0.0:443     0.0.0.0:*     LISTEN     0     10932716     4544/apache2        
</pre>}}

Проверка, есть ли соединение с запущенным на localhost'е сервером Apache:

{{Cmd|telnet localhost 80|output=<pre>
Trying 127.0.0.1...
Connected to localhost.
Escape character is '^&#93;'.
</pre>}}

Тестовое соединение можно разорвать нажатием {{Key|Ctlr}}+{{Key|c}} и {{Key|Enter}}.

== Настройка ==

=== Конфигурационные файлы ===

Существуют 2 основных файла, которые настраивают поведение Apache2 в системе: 

* Конфигурационный файл сценария инициализации apache2 в Gentoo
{{path|/etc/conf.d/apache2 }}

* стандартный файл конфигурации сервера Apache
{{path|/etc/apache2/httpd.conf}}

==== Конфигурационный файл сценария инициализации Gentoo ====

Единственная действующая строка в этом файле приведена ниже:

{{File|/etc/conf.d/apache2||<pre>
APACHE2_OPTS="-D DEFAULT_VHOST -D INFO -D SSL -D SSL_DEFAULT_VHOST -D LANGUAGE"
</pre>}}

Эта строка определяет параметры, которые будут переданы различным конфигурационным файлам, использующим выражение <code><IfDefine option-name></code> для включения или отключения некоторой части настроек. Мы вернёмся к ним там, где это уместно: в конце этого руководства.

==== Стандартный конфигурационный файл сервера Apache  - httpd.conf ====

Этот файл на самом деле является лишь '''точкой входа''', так как вся конфигурация разбита на множество файлов в каталоге {{Path|/etc/apache2/}}, которые собираются вместе посредством директивы <code>Include</code>. Например, целью выражения <code>Include /etc/apache2/modules.d/*.conf</code>, в {{Path|httpd.conf}}, является включение всех файлов, имя которых оканчивается на {{Path|.conf}}, в {{Path|/etc/apache2/modules.d/}}. 

Принимая во внимание то, о чём говорилось в предыдущем разделе, и то, что конфигурационные файлы модулей (файлы в /etc/apache2/modules.d) почти всегда начинаются с <code><IfDefine module-name></code>, получаем, что содержимое одного файла в {{Path|/etc/apache2/modules.d}} будет объединено с остальной конфигурацией ТОЛЬКО в том случае, если соответствующий параметр установлен с помощью флага <code>-D module-name</code> в переменной APACHE2_OPTS в файле {{Path|/etc/conf.d/apache2 }}. Конфигурационный файл {{Path|00_default_settings.conf}} является исключением из этого правила, так как не начинается с выражения <code>IfDefine</code> и, следовательно, всегда включается в конечную конфигурацию.

=== Настройки по умолчанию ===

Ниже приведена конфигурация свежей установки сервера Apache, получающаяся объединением различных конфигурационных файлов. Мы начнём с точки входа {{Path|/etc/apache2/httpd.conf}}.

{{Warning/ru|Листинг приведён ''только'' в качестве «быстрой справки» и чтобы дать вам общее представление. Крайне рекомендуем обратить внимание на комментарии, включенные в различные файлы, для понимания деталей настройки. Для более глубокого понимания можно обратиться к руководству Apache.}}

{{File|http.d ||<pre>
ServerRoot "/usr/lib64/apache2"
  
#Module loaded unconditionally, assuming the USE flag is no unset in
# /etc/portage/make.conf or in /etc/portage/package.use
LoadModule actions_modulemodules/mod_actions.so
...
#other modules loaded that way : alias_module, auth_basic_module, authn_alias_module,
# authn_anon_module, authn_dbm_module, authn_default_module, authn_file_module, 
# authz_dbm_module, authz_default_module, authz_groupfile_module, authz_host_module, 
# authz_owner_module, authz_user_module, autoindex_module,  cgi_module,  cgid_module, 
# deflate_module, dir_module, env_module, expires_module, ext_filter_module, filter_module,
#  headers_module, include_module,  log_config_module, logio_module, mime_module,  
# mime_magic_module, negotiation_module, rewrite_module, setenvif_module, 
# speling_module,ssl_module, status_module, unique_id_module, usertrack_module, host_alias_module
  
  
#Modules loaded conditionally, assuming matching USE flag is not unset in
# /etc/portage/make.conf or in /etc/portage/package.use (flag to be set in )
<IfDefine AUTHNZ_LDAP>
LoadModule authnz_ldap_module modules/mod_authnz_ldap.so
</IfDefine>
#other modules loaded that way : cache_module, dav_module, dav_fs_module,
# dav_lock_module,disk_cache_module,  file_cache_module, info_module, ldap_module,
# mem_cache_module, userdir_module
  
  
User apache
Group apache
  
# Supplemental configuration
#**************************************************************************************vvv
#this part is included via Include /etc/apache2/modules.d/*.conf 
  
#included from /etc/apache2/modules.d/00_default_settings.conf-------------v
#this is always included as there is not option to deactivate it.
Timeout 300
KeepAlive On
MaxKeepAliveRequests 100
KeepAliveTimeout 15
UseCanonicalName Off
AccessFileName .htaccess
ServerTokens Prod
TraceEnable off
ServerSignature On 
HostnameLookups Off
EnableMMAP On
EnableSendfile On
FileEtag INode MTime Size
ContentDigest Off
ErrorLog /var/log/apache2/error_log
LogLevel warn
  
<Directory />
	Options FollowSymLinks
	AllowOverride None
	Order deny,allow
	Deny from all
</Directory>
  
<IfModule dir_module>
	DirectoryIndex index.html index.html.var
</IfModule>
<FilesMatch "^\.ht">
	Order allow,deny
	Deny from all
</FilesMatch>
#--------------------------------------------------------------------------^
  
#included from 00_mod_info.conf--------------------------------------------v
<IfDefine INFO>
<Location /server-info>
	SetHandler server-info
	Order deny,allow
	Deny from all
	Allow from 127.0.0.1
</Location>
</IfDefine>
#--------------------------------------------------------------------------^
  
#--------------------------------------------------------------------------v
#included from 00_languages.conf
# Settings for hosting different languages.
<IfDefine LANGUAGE>
  
	AddLanguage ca .ca
	...
	AddLanguage zh-TW .zh-tw
  
	LanguagePriority en ca cs da de el eo es et fr he hr it ja ko ltz nl nn no pl pt pt-BR ru sv zh-CN zh-TW
  
	ForceLanguagePriority Prefer Fallback
  
	AddCharset us-ascii.ascii	.us-ascii
	AddCharset ISO-8859-1		.iso8859-1 .latin1
	...
	AddCharset shift_jis		.shift_jis .sjis
</IfDefine>
#---------------------------------------------------------------------------^
#**************************************************************************************^^^
  
  
#***************************************************************************************vvv
#this part is included via Include /etc/apache2/vhosts.d/*.conf 
#from 00_default_ssl_vhost.conf-----------------------------------------------------vv
<IfDefine SSL>
	<IfDefine SSL_DEFAULT_VHOST>
		<IfModule ssl_module>
			Listen 443
  
			<VirtualHost _default_:443>
				ServerName localhost
                                #------------------------------------------v
				# this part is included via Include /etc/apache2/vhosts.d/default_vhost.include
				ServerAdmin root@localhost
				DocumentRoot "/var/www/localhost/htdocs"
  
  	
				<Directory "/var/www/localhost/htdocs">
	   				Options Indexes FollowSymLinks
	   				AllowOverride All
	   				Order allow,deny
	   				Allow from all
				</Directory>
  
				<IfModule alias_module>
	   				ScriptAlias /cgi-bin/ "/var/www/localhost/cgi-bin/"
				</IfModule>
  
				<Directory "/var/www/localhost/cgi-bin">
	   				AllowOverride None
	   				Options None
	   				Order allow,deny
	   				Allow from all
				</Directory>
        			#end of Include ---------------------------^
  	
				ErrorLog /var/log/apache2/ssl_error_log
  
				<IfModule log_config_module>
					TransferLog /var/log/apache2/ssl_access_log
				</IfModule>
				SSLEngine on
				SSLCipherSuite ALL:!ADH:!EXPORT56:RC4+RSA:+HIGH:+MEDIUM:+LOW:+SSLv2:+EXP:+eNULL
				SSLCertificateFile /etc/ssl/apache2/server.crt
				SSLCertificateKeyFile /etc/ssl/apache2/server.key
  
				<FilesMatch "\.(cgi|shtml|phtml|php)$">
					SSLOptions +StdEnvVars
				</FilesMatch>
  
				<Directory "/var/www/localhost/cgi-bin">
					SSLOptions +StdEnvVars
				</Directory>
  
				<IfModule setenvif_module>
					BrowserMatch ".*MSIE.*" \
					nokeepalive ssl-unclean-shutdown \
					downgrade-1.0 force-response-1.0
				</IfModule>
  
  
				<IfModule log_config_module>
					CustomLog /var/log/apache2/ssl_request_log \
					"%t %h %{SSL_PROTOCOL}x %{SSL_CIPHER}x \"%r\" %b"
					</IfModule>
			</VirtualHost>
		</IfModule>
	</IfDefine>
</IfDefine>
#---------------------------------------------------------------------------------^^
#from 00_default_vhost.conf-------------------------------------------------------vv
<IfDefine DEFAULT_VHOST>
	Listen 80
	NameVirtualHost *:80
  
	<VirtualHost *:80>
		ServerName localhost
  
		#---------------------------------------------------------------v
		# this part is included via Include /etc/apache2/vhosts.d/default_vhost.include
		ServerAdmin root@localhost
		DocumentRoot "/var/www/localhost/htdocs"
  
  	
		<Directory "/var/www/localhost/htdocs">
	   		Options Indexes FollowSymLinks
	   		AllowOverride All
	   		Order allow,deny
	   		Allow from all
		</Directory>
  
		<IfModule alias_module>
	   		ScriptAlias /cgi-bin/ "/var/www/localhost/cgi-bin/"
		</IfModule>
  
		<Directory "/var/www/localhost/cgi-bin">
	   		AllowOverride None
	   		Options None
	   		Order allow,deny
	   		Allow from all
		</Directory>
        	#end of Include -----------------------------------------------^
  
		<IfModule mpm_peruser_module>
			ServerEnvironment apache apache
		</IfModule>
	</VirtualHost>
</IfDefine>
#-----------------------------------------------------------------------------------^^
# end of include ****************************************************************************************^^^
</pre>}}

=== Первые признаки жизни ===

Как можно видеть из приведённой выше первоначальной конфигурации, предварительно установленным каталогом для виртуального хоста <code>DocumentRoot</code> является {{Path|/var/www/localhost/htdocs}}, именем соответствующего сервера — ''localhost''. К тому же в каталог для <code>DocumentRoot</code> устанавливается файл index.html, так что, чтобы проверить всё ли правильно установлено, можно направить браузер на [http://www.localhost http://www.localhost].

На этой странице вы должны увидеть сообщение "It works !".

=== Включение модуля безопасности ===

{{emerge|mod_security}}

{{File|/etc/conf.d/apache2||<pre>
APACHE2_OPTS="... -D SECURITY"
</pre>}}

Управляйте этим модулем с помощью редактирования {{Path|/etc/apache2/modules.d/79_modsecurity.conf}} и {{Path|/etc/apache2/modules.d/80_modsecurity-crs.conf}} и перезапуском apache.

=== Включение поддержки PHP ===

Установите [[PHP]] с USE-флагом "apache2" и включите соответствующий модуль:

{{File|/etc/conf.d/apache2||<pre>
APACHE2_OPTS="... -D PHP5"
</pre>}}

Чтобы проверить, работает ли модуль PHP, создайте тестовую страницу:

{{File|/var/www/localhost/htdocs/index.php||<pre>
<html>
 <body>
  <?php phpinfo(); ?>
 </body>
</html>
</pre>}}

Теперь, откройте тестовую страницу: http://localhost/. Вы должны увидеть таблицу, описывающую настройки PHP

=== Добавление собственных виртуальных хостов ===

Для каждого виртуального хоста необходимо иметь каталог <code>DocumentRoot</code>, который демон Apache сможет открыть и прочитать. Добавьте файл конфигурации виртуального хоста ({{Path|myVirtualHost.conf}}) в каталоге {{Path|/etc/apache2/vhosts.d}}, который будет использовать данный <code>DocumentRoot</code> и данное имя сервера виртуального хоста, а также не забудьте добавить запись для данного доменного имени в {{Path|/etc/hosts}}.

Для назначения владельца файлов виртуального хоста (пользователю/группе apache), используйте <code>chown</code>, как показано в следующем примере:

{{RootCmd|chown apache:apache /var/www/sitename}}

Ниже приведены два определения виртуального хоста для примера, один для domainname1.com, а второй для domainname2.com. Заметьте, что в них различные <code>DocumentRoot</code> и <code>ServerName</code>, хотя сам хост (<code>*:80</code>) остается постоянным:

{{Code|Примерные определения виртуальных хостов|<pre>
<VirtualHost *:80>
    ServerAdmin email@site.com
    DocumentRoot /var/www/website1
    ServerName domainname1.com
</VirtualHost>
  
<VirtualHost *:80>
    ServerAdmin email@site.com
    DocumentRoot /var/www/website2
    ServerName domainname2.com
</VirtualHost>
</pre>}}

Также рекомендуется дать определение виртуального хоста на основании IP. Это позволит администратору оставить сообщение пользователям, которые попытаются попасть на сайт через его IP адрес:

{{Code|Виртуальный хост на основании IP|<pre>
<VirtualHost *:80>
    ServerAdmin email@site.com
    DocumentRoot /var/www/html
    ServerName xxx.xxx.xxx.xxx
</VirtualHost>
</pre>}}

После вставки новых хостов, сервер должен быть (мягко) перезапущен, чтобы новые сайты стали активны.

=== Включение PHP через fcgid ===

Установите {{Package|www-apache/mod_fcgid}} и {{Package|dev-lang/php}}. Пакету PHP нужен USE флаг ''cgi'':

{{emerge|mod_fcgid php}}

Edit the {{Path|mod_fcgid.conf}} file:

{{File|/etc/apache2/modules.d/20_mod_fcgid.conf||<pre>
<IfDefine FCGID>
LoadModule fcgid_module modules/mod_fcgid.so
SocketPath /var/run/fcgidsock
SharememPath /var/run/fcgid_shm
  
AddHandler php-fcgid .php
AddType application/x-httpd-php .php
Action php-fcgid /fcgid-bin/php-fcgid-wrapper
# max request 128mb
FcgidMaxRequestLen 134217728
<Location /fcgid-bin/>
        SetHandler fcgid-script
        Options +ExecCGI
</Location>
</IfDefine>
</pre>}}

Create the needed directory: 

{{RootCmd|mkdir /var/www/localhost/htdocs/fcgid-bin}}

Symlink it for the PHP wrapper:

{{RootCmd|ln -s /usr/bin/php-cgi /var/www/localhost/htdocs/fcgid-bin/php-fcgid-wrapper}}

Enable the fcgid module:

{{File|/etc/conf.d/apache2||<pre>
APACHE2_OPTS="... -D FCGID"
</pre>}}

Finally restart Apache and check the <code>phpinfo()</code> site created earlier. The value of <code>Server API</code> should be ''CGI/FastCGI''

== Устранение проблем ==

* [http://www.gentoo.org/proj/en/apache/doc/troubleshooting.xml Руководство по устранению проблем]
* {{Bug|www-servers/apache|search=package}}

=== Стандартные неполадки ===
При запуске apache вы можете получить следующие сообщения об ошибках:

{{Code||<pre>apache2: apr_sockaddr_info_get() failed for SomeHostname
</pre>}}

Когда это происходит, добавьте имя вашего хоста в файл {{Path|/etc/hosts}}.

{{file|/etc/hosts||127.0.0.1 localhost SomeHostname
}}

== Смотрите также ==

* [[Lighttpd]] — быстрый, легковесный веб-сервер.
* [[Nginx]] — небольшой, надежный и высокопроизводительный HTTP-сервер.

== Внешние ресурсы ==

* [http://articles.slicehost.com/2010/12/2/installing-apache-on-gentoo статья Slicehost: Установка Apache в Gentoo]
* [http://articles.slicehost.com/2010/12/3/apache-configuration-files-on-gentoo статья Slicehost: Конфигурационые файлы Apache в Gentoo]
* [http://articles.slicehost.com/2010/12/3/configuring-the-apache-mpm-on-gentoo статья Slicehost: Настройка Apache MPM в Gentoo]
* [http://articles.slicehost.com/2010/12/3/apache-configuration-on-gentoo-part-1 статья Slicehost: Настройка Apache в Gentoo]
* [http://articles.slicehost.com/2010/12/3/apache-virtual-hosts-on-gentoo-part-1 статья Slicehost: Виртуальные хосты Apache в Gentoo]
* [http://articles.slicehost.com/2010/12/3/enabling-and-using-apache-s-mod_status-on-gentoo статья Slicehost: Включение и использование модуля apache mod_status в Gentoo]
* [http://httpd.apache.org/docs/ документация apache.org]
* [http://gentoo-en.vfose.ru/wiki/Apache2_mod_pagespeed Apache2 mod_pagespeed]


[[Category:Web Servers]]
