<languages />

{{Metadata|abstract=nginx is a robust, small and high performance web server and reverse proxy server.}}

{{Lowercase title}}
{{InfoBox stack
|{{InfoBox homepage|http://nginx.org/en/|header=true}}
|{{InfoBox wikipedia}}
}}

'''nginx''' nginx это маленький [[:Category:Web Servers|веб сервер]] и обратный прокси сервер. Это хорошая альтернатива популярным веб-серверам, таким как [[Apache]] и [[lighttpd]].

== Установка ==

Перед непосредственной установкой пакета {{Package|www-servers/nginx}}, сначала прочитайте про USE флаги для Nginx.

Nginx использует модули для расширения своих возможностей. Для упрощения обслуживания при таком модульном подходе, файл ebuild для nginx использует USE флаги для определения того, какие модули нужно установить. Модули, относящиеся к HTTP можно включить с помощью переменной <code>${NGINX_MODULES_HTTP}</code>, а модули, относящиеся к почте через переменную <code>${NGINX_MODULES_MAIL}</code>.

Эти переменные нужно установить в {{Path|/etc/portage/make.conf}}. Их описание можно найти в [http://sources.gentoo.org/cgi-bin/viewvc.cgi/gentoo-x86/profiles/desc/nginx_modules_http.desc /usr/portage/profiles/desc/nginx_modules_http.desc] и [http://sources.gentoo.org/cgi-bin/viewvc.cgi/gentoo-x86/profiles/desc/nginx_modules_mail.desc /usr/portage/profiles/desc/nginx_modules_mail.desc].

Другие USE флаги следующие:

{{USEflag|package=www-servers/nginx
|aio+++Включить поддержку AIO
|debug+++Включить дополнительную отладочную информацию, вроде assert и дополнительного вывода на экран. Если вы хотите получать понятную распечатку стека, смотрите [http://www.gentoo.org/proj/en/qa/backtraces.xml http://www.gentoo.org/proj/en/qa/backtraces.xml]
|http+yes++Включение базовой поддержки HTTP
|http-cache+yes++Включение поддержки кэширования HTTP
|ipv6+yes++Включение поддержки протокола IP версии 6
|libatomic+++Использовать libatomic вместо встроенных атомарных операций
|pcre+++Добавить поддержку регулярных выражений Perl
|pcre-jit+++Включить JIT для pcre
|syslog+++Добавляет поддержку syslog
|vim-syntax+++Включает необходимые скрипты синтаксиса vim
|ssl+yes++Включает модуль HTTPS для HTTP. Включает поддержку SSL/TLS для почты POP3/IMAP/SMTP
}}

С установленными USE флагами, установите {{Package|www-servers/nginx}}:

{{Emerge|nginx}}

Не забудьте добавить nginx к уровню доступа по умолчанию.

{{RootCmd|rc-update add nginx default}}

== Работа ==

Пакет nginx устанавливает сервисный скрипт, который позволяет администратору останавливать, запускать, либо перезапускать сервис:

{{RootCmd|/etc/init.d/nginx start}}

Чтобы проверить, что nginx правильно работает, зайдите на него вашим браузером, либо используйте один из веб-клиентов командной строки (например, <code>curl</code>):

{{Cmd|curl http://localhost}}

== Конфигурация ==

Конфигурация nginx находится в файле {{Path|/etc/nginx/nginx.conf}}.

=== Доступ к одному сайту ===

Следующий пример показывает конфигурацию для доступа к одному сайту без динамических возможностей (таких как [[PHP]]).

{{File|/etc/nginx/nginx.conf|Конфигурация Gentoo по умолчанию|<pre>
user nginx nginx;
worker_processes 1;
  
error_log /var/log/nginx/error_log info;
  
events {
        worker_connections 1024;
        use epoll;
}
  
http {
        include /etc/nginx/mime.types;
        default_type application/octet-stream;
  
        log_format main
                '$remote_addr - $remote_user [$time_local] '
                '"$request" $status $bytes_sent '
                '"$http_referer" "$http_user_agent" '
                '"$gzip_ratio"';
  
        client_header_timeout 10m;
        client_body_timeout 10m;
        send_timeout 10m;
  
        connection_pool_size 256;
        client_header_buffer_size 1k;
        large_client_header_buffers 4 2k;
        request_pool_size 4k;
  
        gzip on;
        gzip_min_length 1100;
        gzip_buffers 4 8k;
        gzip_types text/plain;
  
        output_buffers 1 32k;
        postpone_output 1460;
  
        sendfile on;
        tcp_nopush on;
        tcp_nodelay on;
  
        keepalive_timeout 75 20;
  
        ignore_invalid_headers on;
  
        index index.html;
  
        server {
                listen 127.0.0.1;
                server_name localhost;
  
                access_log /var/log/nginx/localhost.access_log main;
                error_log /var/log/nginx/localhost.error_log info;
  
                root /var/www/localhost/htdocs;
        }
}
</pre>}}

=== Включение поддержки PHP ===

Добавьте следующие строки в конфигурацию nginx для включения поддержки PHP. В данном примере nginx обменивается информацией с процессом PHP через сокет UNIX.

{{File|/etc/nginx/nginx.conf|Enabling PHP support|<pre>
...
http {
...
    server { 
    ...
            location ~ \.php$ {
                       # Test for non-existent scripts or throw a 404 error
                       # Without this line, nginx will blindly send any request ending in .php to php-fpm
                       try_files $uri =404;
                       include /etc/nginx/fastcgi.conf;
                       fastcgi_pass unix:/run/php-fpm.socket;
           }
    }
}
</pre>}}

Для поддержки такой настройки, PHP нужно собрать с поддержкой менеджера процессов FastCGI (php-fpm), что обрабатывается через USE флаг <code>fpm</code>:

{{RootCmd|echo "dev-lang/php fpm" >> /etc/portage/package.use}}

Пересоберите php с новым включенным USE флагом.

{{Emerge|dev-lang/php}}
 
{{Note/ru|Использование связи через сокет UNIX это предпочтительная и рекомендуемая конфигурация}}

Просмотрите конфигурацию в файле {{Path|/etc/php/fpm-php5.4/php-fpm.conf}} и добавьте следующую строку:

{{File|/etc/php/fpm-php5.4/php-fpm.conf|Запуск PHP с поддержкой сокетов UNIX|<pre>
listen = /run/php-fpm.socket
</pre>}}

Setup your timezone in the php-fpm {{Path|php.ini}} file.

{{File|/etc/php/fpm-php5.4/php.ini|Setup timezone in php.ini|<pre>
date.timezone = <fill in your timezone!>
</pre>}}

Start the php-fpm daemon:

Добавьте php-fpm к уровню запуска по умолчанию:

{{RootCmd|rc-update add php-fpm default}}

Перезагрузите nginx с измененной конфигурацией:

{{RootCmd|/etc/init.d/nginx reload}}

=== Включение списка доступа по IP ===

Следующий пример показывает, как разрешить доступ к конкретному URL (в этом случае, к ''/nginx_status'') только для
* конкретных хостов (например, ''192.0.2.1 127.0.0.1'')
* и IP-сетей (например, ''198.51.100.0/24'')

{{File|/etc/nginx/nginx.conf|Включение и настройка списков доступа по IP для страницы /nginx_status|<pre>
http {
    server { 
            location /nginx_status {
                     stub_status on;
                     allow 127.0.0.1/32;
                     allow 192.0.2.1/32;
                     allow 198.51.100.0/24;
                     deny all;
             }
     }
}
</pre>}}

== Устранение проблем ==

В случае проблем следующие команды могут помочь вам найти ошибки.

=== Проверка конфигурации ===

Проверьте, что запущенная конфигурация nginx не содержит ошибок.

{{RootCmd|/usr/sbin/nginx -t|output=<pre>
nginx: the configuration file /etc/nginx/nginx.conf syntax is ok
nginx: configuration file /etc/nginx/nginx.conf test is successful
</pre>}} 

Запустив <code>nginx</code> с опцией <code>-t</code>, он проверит синтаксис файла конфигурации без самого старта демона nginx.

=== Проверка запущенных процессов ===

Проверьте, запущены ли процессы nginx:

{{Cmd|ps aux {{!}} egrep 'nginx{{!}}PID'|output=<pre>
  PID TTY      STAT   TIME COMMAND
26092 ?        Ss     0:00 nginx: master process /usr/sbin/nginx -c /etc/nginx/nginx.conf
26093 ?        S      0:00 nginx: worker proces
</pre>}}

=== Проверьте адрес привязки и порты ===

Проверьте, что демон nginx прослушивает правильный TCP порт (например, 80 для HTTP или 443 для HTTPS):

{{RootCmd|netstat -tulpen {{!}} grep :80|output=<pre>
tcp        0      0 127.0.0.1:80            0.0.0.0:*               LISTEN      0          12336835   -26092/nginx: master
</pre>}}

{{RootCmd|netstat -tulpen {{!}} grep :80|output=<pre>
tcp        0      0 127.0.0.1:80            0.0.0.0:*               LISTEN      0          12336835   -26092/nginx: master
</pre>}}

{{Metadata|abstract=nginx это маленький и высокопроизводительный веб-сервер и обратный прокси сервер.}}
