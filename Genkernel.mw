{{Lowercase title}}
{{Stub}}
{{InfoBox stack
|{{InfoBox wikipedia|header=true}}
|{{InfoBox gdoc|genkernel}}
}}
'''genkernel''' is used to automate the build process of the [[kernel]] and [[initramfs]]. Some of the general features:
* configure the kernel sources
* build bzImage and copy to {{Path|/boot}}
* create initramfs and copy to {{Path|/boot}}
* create symlinks in {{Path|/boot}}
* add custom content to initramfs for encryption, splash images, extra modules etc.
* compress initramfs
* configure the [[bootloader]]

== Installation ==
Install {{Package|sys-kernel/genkernel}}:
{{USEflag|package=sys-kernel/genkernel
|crypt++no
|cryptsetup++no
|ibm++no
|selinux++no
}}

{{Emerge|genkernel}}

== Using genkernel ==
The general form of genkernel invocation is as follows:
{{RootCmd|<pre> genkernel [options ...] action
</pre>}}
=== Options === 
The actual behavior of genkernel depends on  a large variety of options, the majority of which,  can be set/unset in the   {{Path|/etc/genkernel.conf}} file or passed via with the '''genkernel''' command. Options passed over the command line take precedence over options defined into  {{Path|/etc/genkernel.conf}}. This file is very well documented but let's examine some of the most commonly used ones here. For a more complete explanation, please refer to the comments in {{Path|/etc/genkernel.conf}} itself or to the output of the <code>man genkernel</code> command.<br />

{{Note|Some of the options have a variant that triggers a converse behavior. They are figured as '''--[no]option_name''', and the converse effect is shown in square brakets as in the following example:<br />
'''--[no]-menuconfig''': Activates [deactivates] ... }}<br />

==== Options acting on user interactivity ====
The configuration flags listed below  help you decide how you will interact with the configuration process. You can even choose whether or not the configuration file created in the process should be saved. The following are the primary configuration flags:

:* '''--[no-]menuconfig''': Activates [ or deactivates] the <code>make menuconfig</code> command (which invokes un interactive configuration menu) before building the kernel.
:* '''--gconfig''': Provides a kernel configuration utility which depends on the GTK+ libraries. The advantage of this option is that most users find it easier and clearer to configure the kernel using this tool, since it relies on the X-windowing system. The disadvantage of this option is that you need the X-windowing system to use it, so it will not work on the command line.
:* '''--xconfig''': Provides a kernel configuration utility which depends on the QT libraries. The advantage of this option is that most users find it easier and clearer to configure the kernel using this tool, since it relies on the X-windowing system. The disadvantage of this option is that you need the X-windowing system to use it, so it will not work on the command line.
:* '''--[no-]save-config''': Saves [or does not save] the kernel configuration to a file in the /etc/kernels/ directory for later use.
:* '''--kernname=NickName''': Allows you to modify the name of the kernel and initrd images in the /boot/ directory, so that the images produced are kernel-NickName-version and initramfs-NickName-version.

==== Options acting on the resulting system ====
The configuration flags listed here defines which features will, or won't be enabled in the resulting kernel and initrd. 
:* '''--[no-]splash''': Activates [or deactivates] support for [http://fbsplash.berlios.de/wiki/doku.php framebuffer splash] support in the genkernel-built initrd image. To override the default theme used by fbsplash, use '''--splash=PreferredTheme''' (where PreferredTheme is the title of one of the directories inside the /etc/splash/ directory.
:* '''--splash-res=PreferredResolution''': This flag allows you to select which splash screen resolutions will be supported in the initrd during the start-up of the system. This is useful for two reasons: First, you are able to select only the splash screen resolution(s) relevant to your system. Second, you avoid the unnecessary increase in the disk space required by initrd (since the initrd does not have to support resolutions that are irrelevant for your system configuration.) However, you may want to omit this flag if the kernel is being compiled for an Installation CD; this allows splash support for all possible resolutions.
:* '''--do-keymap-auto''': Force keymap selection during the boot sequence.
:* '''--lvm''': Includes support for storage using via [http://sources.redhat.com/lvm2/ Logical Volume Management] (LVM2) from static binaries, if available to the system. Relevant (static) LVM2 binaries are compiled if they are unavailable. Be sure to install the lvm2 package on your system with emerge lvm2 before enabling this flag, and review the [[LVM | LVM article]] on the Gentoo wiki.
:* '''--dmraid''': Includes support for DMRAID; the utility which creates RAID mappings using the kernel device-mapper subsystem. [http://people.redhat.com/~heinzm/sw/dmraid/readme DMRAID] discovers, activates, deactivates and displays properties of software RAID sets (ATARAID, for example) and contained DOS partitions.
:* '''--luks''': Includes support for Linux Unified Key Setup or [http://clemens.endorphin.org/cryptography LUKS]. This will allow you to use a device encrypted by LUKS which contains the root filesystem. On the bootloader, you then set that encrypted device as the value of crypt_root (and real_root shall be the unencrypted device LUKS creates).
:* '''--disklabel''': Adds support for disk label and UUID support to your initrd.
:* '''--iscsi''': Adds support for iSCSI to your initrd.
:* '''--multipath''': Adds support for [[Multipath]] to your initrd.
:* '''--linuxrc=/path/to/your/linuxrc'''': Specifies a user-created linuxrc — a script that is initialized during the start-up stage of the kernel, prior to the actual boot process. (A default linuxrc script should be in the /usr/share/genkernel/ directory.) This script allows you to boot into a small, modularized kernel and load the drivers that are needed (as modules) by the system.
:* '''--cachedir=/path/to/alt/dir/''': Overrides the default cache location used while compiling the kernel.
:* '''--tempdir=/path/to/new/tempdir/''': Specifies the location of the temporary directory used by genkernel while compiling the kernel.
:* '''--unionfs''': Includes support for the [http://www.fsl.cs.sunysb.edu/project-unionfs.html Unification File System] in the initrd image.
:* '''--mountboot''': Detects whether or not the /boot/ directory needs to be mounted on a separate partition. It will check /etc/fstab script for instructions on how to mount the boot partition on a file system (if needed).

==== Options acting on the tools used for building ====
The following flags are supported by genkernel, and are passed to the relevant applications while the kernel is being assembled. These flags affect the compiling tools used for the kernel compilation process, albeit at a much lower level.

:* '''--kernel-cc=someCompiler''': Specifies the compiler employed during the kernel compilation process.
:* '''--kernel-ld=someLinker''': Specifies the linker employed during the kernel compilation process.
:* '''--kernel-as=someAssembler''': Specifies the assembler employed during the kernel compilation process.
:* '''--kernel-make=someMake''': Specifies an alternative to the GNU make utility employed during the kernel compilation process.
:* '''--utils-cc=someCompiler''': Specifies the compiler employed during the compilation of support utilities.
:* '''--utils-ld=someLinker''': Specifies the linker employed during the compilation of support utilities.
:* '''--utils-as=someAssembler''': Specifies the assembler employed during the compilation of support utilities.
:* '''--utils-make=someMake''': Specifies an alternative to the GNU make utility employed during the compilation of support utilities.
:* '''--makeopts=-jX''': Specifies the number of concurrent threads that the make utility can implement while the kernel (and utilities) are being compiled. The variable 'X' is a number obtained by adding one (1) to the number of CPUs used by the system. So, for a system with one CPU, the appropriate flag is -j2; a system with two CPUs will use the -j3 flag, and so on. (A system with one processor that supports Hyper-Threading™ (HT) Technology can use the -j3 flag, provided Symmetric Multi-Processing (SMP) support is enabled in the kernel.)

==== Options acting on the compilation process ====
The following options usually take effect during the actual compilation:

:* '''--kerneldir=/path/to/sources/''': Specifies an alternative kernel source location, rather than the default /usr/src/linux/ location.
:* '''--kernel-config=/path/to/config-file''': Specifies what alternative kernel configuration will be used, rather than the default /path/to/sources/.config file.
:* '''--module-prefix=/path/to/prefix-directory/''': Specifies a prefix to the directory where kernel modules will be installed (default path is the /lib/modules/ directory.)
:- '''--no-clean''': Activates [or deactivates] the make clean command before compiling your kernel. The make clean command removes all object files and dependencies from the kernel's source tree.
:* '''--no-mrproper''': Activates [or deactivates] the make mrproper command before kernel compilation. Like the make clean command, make mrproper removes all object files and dependencies from the kernel's source tree. However, any previous configuration files (in /path/to/sources/.config or /path/to/sources/.config.old) will also be purged from the kernel's source tree.
:* '''--oldconfig''': Issues the make oldconfig command, which attempts to collect configuration information for the system's architecture from a generic script in /usr/share/genkernel/. This is a non-interactive process; no user input is entertained. Also, if --oldconfig is used in conjunction with --clean, the latter flag is negated, resulting in the activation of the --no-clean flag.
:* '''--callback="echo hello"''': Calls the specified arguments (echo hello, in this case) after the kernel and the relevant modules have been built, but before building the initrd image. This may be useful if you want to install external modules in the initrd image by emerging the relevant item(s) with the callback feature, and then redefining a genkernel module group.
:* '''--no-install''': Activates [or deactivates] the make install command, which installs your new kernel image, configuration file, initrd image and system map onto your mounted boot partition. Any compiled modules will be installed as well.
:* '''--no-ramdisk-modules''': Refrains from copying any modules to the genkernel-created initrd image. This flag is an exception to the rule about the no- prefix; omission of this prefix creates an invalid genkernel flag.
:* '''--all-ramdisk-modules''': Copies all available modules to the genkernel-created initrd image.
:* '''--genzimage''': Creates the initrd image, prior to the kernel image. (This hack currently applies only to PPC Pegasos systems.)

==== Debugging options ====
The use of debugging options during the kernel compilation process controls the amount of information reported, as well as the presentation of said data.

:* '''--loglevel=verblevel''': Controls the level of verbosity for information provided by genkernel. The variable verblevel is an integer between 0 and 5. The level '0' represents minimal output, while '5' provides as much information as possible about genkernel's activities during the kernel compilation process.
:* '''--logfile=/path/to/outputfile''': Ignores the value set by the --loglevel argument, and sends all debugging data produced by genkernel to the specified output file, which is located at {{Path|/var/log/genkernel.log }} by default.
:* '''--no-color''': Activates [or deactivates] colored output of debugging information (reported by genkernel) using escape sequences.

=== Action ===
The action passed on the command line with the <code>genkernel [options …] action</code> command, tells ''genkernel''  what you want it to do - the following actions are supported:

:* '''all''': Builds all stages — the initrd, kernel image and modules.
:* '''bzImage''': Only builds the kernel image
:* '''kernel''': Only builds the kernel image and modules
:* '''initramfs''': Only builds the initramfs/ramdisk image
:* '''ramdisk''': Only builds the initramfs/ramdisk image

== Genkernel invocation ==
Although there are several ways to run genkernel, the least-intrusive approach recommanded for most users  is provided by <code>genkernel all</code>. Here, a generic configuration which works well for most systems is used. As was mentioned earlier, this approach is not without drawbacks; most of the modules created are useless to the average user and may increase compile time. Below is an illustration of a more efficient approach, achieved by passing certain options to genkernel as root:
<br />
{{RootCmd|<pre> genkernel --splash --no-install --no-clean --menuconfig all</pre>}}
<br />
The above operation causes genkernel to create a framebuffer splash-enabled kernel ('''--splash''') that will have to be manually installed ('''--no-install'''). While preparing the kernel source tree, genkernel will refrain from cleaning out any preexisting object files present in the source tree ('''--no-clean'''). A menu-driven kernel configuration utility will be displayed that allows the user to select which modules will be built for the system ('''--menuconfig''').

Replacing '''--no-install''' with the '''--install''' option allows genkernel to automatically install the new kernel in the /boot directory, and will create symlinks for you if '''--symlink''' is specified. Using the '''--mountboot''' option allows genkernel to mount your /boot partition automatically, if necessary.

{{Note|Don't forget that the {{Path|/etc/genkernel.conf}} file is sourced by the <code>genkernel</code>
 command at startup, and that any option defined there, will be applied, except where a command line option takes precedence over it.}}

== Bootloader Configuration ==
To allow the '''kernel''' and '''intird''' provided by genkernel to run correctly, you should provide a minimum information in your bootloader s' configuration file :
:* Add <code> real_root=/dev/sdax</code> ,  to the kernel parameters passed to the kernel image, where /dev/sdax contains your root partition.
:* If you are using splash, add a suitable mode line such as <code>vga=0x317</code> to the parameters passed to the kernel and also add <code>splash=verbose</code> or <code>splash=silent</code> depending on the verboseness you require from your bootloader.
:* Add the <code>initrd</code> information as required by the bootloader. Consult the [http://www.gentoo.org/doc/en/handbook/handbook-x86.xml?part=1&chap=10   Bootloader Configuration Chapter] of the Gentoo Handbook for details on how to make your bootloader initrd-aware.

== Network Booting with Genkernel ==
=== Network Booting with Genkernel from an Installation CD ===
The genkernel utility can build kernel and initrd images that provide support for network booting, or netbooting. With any luck, you should be able to netboot any recent computer into the environment provided by the Installation CD.

The magic lies in genkernel's linuxrc script: it will try to netmount the Installation CD using NFS. From there, the init scripts of the Installation CD can take over, as if the CD was present locally.

=== Building Kernel and Initrd Images with Support for Netbooting ===
To enable support for netbooting, include the following options while configuring the kernel:

{{Warning|Support for netbooting with genkernel is experimental and may contain bugs. }}

First, the kernel image must include the drivers for your Network Interface Cards (NIC). Normally, drivers for such devices will be compiled as modules. However, it is essential (for netbooting) that you have such drivers compiled directly into the kernel image and not as modules.

{{Code|Configuring a 2.6.x series kernel to support your NIC driver|<pre>
Device Drivers --->
   Networking Support --->
      Ethernet (10 or 100Mbit)  --->
         [*] Ethernet (10 or 100Mbit)
         <*>   the driver for your network card
(Be sure to select <*> and not <M>)</pre>
 }}

Secondly, we suggest that you enable <code>IP: kernel level autoconfiguration</code> and the <code>IP: DHCP support options</code>. This avoids an unnecessary layer of complexity since the IP address and the NFS path to the Installation CD can be configured on a DHCP server. Of course, this means the kernel command line will remain constant for any machine — which is very important for etherbooting.

{{Code| Configuring a 2.6.x series kernel to support DHCP|<pre>
Device Drivers --->
   Networking Support --->
      Networking options
         [*] TCP/IP networking--->
         [*]   IP: kernel level autoconfiguration
         [*]     IP: DHCP support
(These options tell the kernel to send a DHCP request at bootup.)</pre>
 }}

Additionally, you should enable SquashFS because most modern Gentoo Installation CDs require it. Support for SquashFS is not included with the generic kernel source tree. To enable SquashFS, apply the necessary patches to the generic kernel source or install gentoo-sources.

{{Code| Configuring the kernel to support SquashFS|<pre>
File systems--->
   Miscellaneous filesystems --->
      [*] SquashFS 2.X - Squashed file system support</pre>
 }}

Once the compilation process is completed, create a compressed tarball (tar.gz) that contains the kernel's modules. This step is only necessary if your kernel version does not match the kernel image version on the Installation CD.

{{Code| Creating a compressed tarball containing the kernel modules|<pre>
(Create a tar.gz containing all the modules)
# cd /
# tar -cf /tmp/modules-X.Y.Z.tar.gz /lib/modules/X.Y.Z/</pre>
 }}
Depending on your network boot mechanism, you will need to do some of the following steps:
{{Code|Creating a boot image|<pre>
Create an etherboot image)
# emerge mknbi
# cd /boot
# mkelf-linux -params="root=/dev/ram0 init=/linuxrc ip=dhcp" kernel... initrd... > etherboot.img

(Create a OpenBoot / SPARC64 TFTP image)
# emerge sparc-utils
# cd /boot
# elftoaout kernel... -o kernel.aout
# piggyback64 kernel.aout System.map-... initrd-...
# mv kernel.aout openboot.img (This is the boot image)

(PXE does not need any more steps, the kernel and initrd can be used as is)
</pre>
 }}

Finally, copy this kernel to your TFTP server. The details are architecture-dependent and are beyond the scope of this guide. Please refer to the documentation for your platform.

=== NFS setup ===
To setup a NFS share that contains the Installation CD, use the loop device to mount the ISO image and then copy the contents of the CD into the NFS share. As a nice extra, genkernel's initrd scripts will extract all tar.gz files located in the '''/nfs/livecd/add/''' directory. All you have to do here is copy the '''modules-X.Y.Z.tar.gz''' archive to the '''/nfs/livecd/add/''' directory.

{{Code|Preparing the NFS share|<pre>
(This assumes that /nfs/livecd is an exported NFS share)
# mount /tmp/gentoo-livecd.iso /mnt/cdrom -o loop
# cp -p /mnt/cdrom /nfs/livecd
# umount /mnt/cdrom

(Copy the modules.tar.gz into /add)
# mkdir /nfs/livecd/add
# cp /tmp/modules-X.Y.Z.tar.gz /nfs/livecd/add
</pre>

=== DHCP setup ===
The netboot images will ask your DHCP server for an IP as well as a root-path parameter. Both can be specified per host using a MAC address to identify machines:

{{Code|Sample client dhcpd.conf setup| <pre>

Code Listing 4.7: Sample client dhcpd.conf setup
...

host netbootableMachine {
         hardware ethernet 11:22:33:44:55:66;
         fixed-address 192.168.1.10;
         option root-path "192.168.1.2:/nfs/livecd";
}
# Here, 192.168.1.2 is the NFS server
# While 192.168.1.10 will be the IP address of the netbooted machine
...
</pre>}}

=== Netbooting Instructions ===
Netbooting itself is again very platform-specific. The important part is to specify the '''ip=dhcp''' and '''init=/linuxrc''' parameters on the kernel command line, as this will bring up the network interface and tell the initrd scripts to mount the Installation CD via NFS. Here are some platform-specific tips:

{{Code| Netbooting Instructions|<pre>
# Etherboot - insert the etherboot disk into the drive and reboot
# The kernel command line was specified when the image was constructed

# Sparc64 - Hit Stop-A at the boot prompt
ok boot net ip=dhcp init=/linuxrc

# PXE - Setup pxelinux (part of syslinux),
then create a pxelinux.cfg/default along the lines of:

DEFAULT gentoo
TIMEOUT 40
PROMPT 1

LABEL gentoo
    KERNEL kernel-X.Y.Z
    APPEND initrd=initrd-X.Y.Z root=/dev/ram0 init=/linuxrc ip=dhcp

</pre> }}

=== Booting a genkernel initramfs ===
==== Introduction ====
If you installed an initramfs with genkernel, you should definitely take a look at the various boot options that you can (or need to) define in your bootloader configuration. The most common ones are added to this guide for your reference.

==== Loading LVM or software-RAID ====
If your system uses LVM or software-RAID, you undoubtedly have built the initramfs using the --lvm and --mdadm options (didn't you). However, you should not forget to enable support during boot as well. This can be done using the dolvm and domdadm options.

{{Code|Enabling LVM and/or MDADM support|<pre>
# Example for GRUB 1.x
title Gentoo Linux
root (hd0,0)
kernel /vmlinuz root=/dev/md3 dolvm domdadm
initrd /initramfs-genkernel-x86_64-3.4.3
</pre> }}

==== Booting in single-user mode ====
If for some reason boot-up fails, you might be able to rescue your system by booting in the single-user mode. This will only load the really necessary services and then drop you to a rescue (root) shell.

{{Code| Booting in single-user mode|<pre>
# Example for GRUB 1.x
title Gentoo Linux
root (hd0,0)
kernel /vmlinuz root=/dev/md3 init_opts=S
initrd /initramfs-genkernel-x86_64-3.4.3
</pre> }}

[[Category:Kernel]]
[[Category:Initramfs]]
